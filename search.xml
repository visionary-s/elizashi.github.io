<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Gson LinkedTreeMap</title>
    <url>/2019/12/09/About%20Gson%20LinkedTreeMap/</url>
    <content><![CDATA[<h4 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h4><p>Given a Gson object with format <code>LinkedTreeMap&lt;String, String&gt;</code>, e.g.:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">LinkedTreeMap&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; misc = &#123;</span><br><span class="line">  misc1: misc_site,</span><br><span class="line">  misc2: misc_sector,</span><br><span class="line">  misc3: <span class="literal">null</span>,</span><br><span class="line">  misc4: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I got the HashMap with</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  misc: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">and</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>And pass case <code>assertThat(misc).isNull();</code> is what I expected. Unfortunately both were deleted not Null.<br>I try to transform the type into HashTable but got:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR: com.google.gson.internal.LinkedTreeMap cannot be cast to java.util.Hashtable</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>Construct an Iterator to get each value in map in sequence (LinkedTreeMap has already did it).</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Iterator it = misc.keySet().iterator();</span><br><span class="line">Integer cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    String key = (String) it.next();</span><br><span class="line">    <span class="keyword">if</span> (misc.get(key) != <span class="keyword">null</span>) cnt++;</span><br><span class="line">&#125;</span><br><span class="line">assertThat(cnt).isEqualTo(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>不怎么好看不过能用。。</p>
<p>Ref: <a href="https://blog.csdn.net/cheweilol/article/details/52098637">Gson解析时对于不确定泛型的处理</a></p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>data structure</tag>
        <tag>FT</tag>
      </tags>
  </entry>
  <entry>
    <title>CDT Learning</title>
    <url>/2019/07/25/CDT/</url>
    <content><![CDATA[<h2 id="Skeleton"><a href="#Skeleton" class="headerlink" title="Skeleton"></a>Skeleton</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">my-app/</span><br><span class="line">    .cdt                  <span class="comment"># installed lib and conf，do not modify</span></span><br><span class="line">    <span class="built_in">help</span>/                 <span class="comment"># help docs</span></span><br><span class="line">    locales/              <span class="comment"># translation files</span></span><br><span class="line">    resources/            <span class="comment"># imgs &amp; other resources that are not js files</span></span><br><span class="line">    src/                  <span class="comment"># src code. Contains only one folder (my-app)</span></span><br><span class="line">        my-app/           <span class="comment"># name = app name, fully lowercase</span></span><br><span class="line">    <span class="built_in">test</span>/                 </span><br><span class="line">        bit/              <span class="comment"># FT, API concerned only</span></span><br><span class="line">        unit/             <span class="comment"># UT</span></span><br><span class="line">    .editorconfig         <span class="comment"># coding styles，已删</span></span><br><span class="line">    .gitignore  </span><br><span class="line">    app.config.js         <span class="comment"># metadata for app</span></span><br><span class="line">    build.json            <span class="comment"># used by the build module</span></span><br><span class="line">    container.config.js   <span class="comment"># only for dev, never used in production, contains dev version of container</span></span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<h4 id="app-config-js"><a href="#app-config-js" class="headerlink" title="app.config.js"></a>app.config.js</h4><p>  app configuration file, example:<br>  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">  define(&#123;</span><br><span class="line">    script: <span class="string">&#x27;active-alerts/ActiveAlerts&#x27;</span>, <span class="comment">// path to app, src下的脚本执行</span></span><br><span class="line">    title:  <span class="string">&#x27;Active Alerts&#x27;</span>,    <span class="comment">// app title, used in breadcrumb widget</span></span><br><span class="line">    <span class="comment">// opt</span></span><br><span class="line">    parent: <span class="string">&#x27;alert-management&#x27;</span>,</span><br><span class="line">    <span class="comment">// opt, when exe parent script will start the children</span></span><br><span class="line">    children: [              </span><br><span class="line">        &#123;<span class="attr">app</span>: <span class="string">&#x27;alerts-log&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="attr">app</span>: <span class="string">&#x27;alerts-settings&#x27;</span>&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// opt, expose app modules that can be loaded by other apps dynamically</span></span><br><span class="line">    <span class="built_in">exports</span>: &#123;     </span><br><span class="line">        <span class="string">&#x27;active-alerts/Module1&#x27;</span>: <span class="string">&#x27;active-alerts/modules/Module1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;active-alerts/Module2&#x27;</span>: <span class="string">&#x27;active-alerts/modules/Module2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// i18n.locales: list of supported language</span></span><br><span class="line">    <span class="string">&quot;i18n&quot;</span>: &#123;   <span class="comment">// 这里可以不加引号，也可以加，上面的参数同理</span></span><br><span class="line">                <span class="comment">// ES6可以不加，ES5要加</span></span><br><span class="line">        <span class="string">&quot;locales&quot;</span>: [<span class="string">&quot;en-us&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><br>detailed folder structure: <a href="https://arm101-eiffel004.lmera.ericsson.se:8443/nexus/content/sites/tor/cdt/latest/proj_struct.html">internal link</a><br>other link: <a href="https://cloud.tencent.com/developer/section/1489898">breadcrumb widget</a></p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>CDT</tag>
        <tag>dev-env</tag>
      </tags>
  </entry>
  <entry>
    <title>3PP Upgrade</title>
    <url>/2020/07/16/3pp-upgrade/</url>
    <content><![CDATA[<p>This is a record for my work to product 3pp upgrade.</p>
<h3 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h3><p>log on a host server to build docker image and test deployment:</p>
<ul>
<li>log on a jump server first</li>
<li>ssh e-id@seroius01502</li>
</ul>
<p>use xxxx/xxx-compiler(cdt2 image) to build frontend <br>use xxx/xxx-base(node image) to build backend</p>
<h3 id="Compiler-frontend-cdt2-debugging"><a href="#Compiler-frontend-cdt2-debugging" class="headerlink" title="Compiler (frontend, cdt2) debugging"></a>Compiler (frontend, cdt2) debugging</h3><p>Run upgraded cdt2+node images as a container first:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --rm -it -d --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/eshibij/cec-3pp-upgrade,dst=/usr/share sekidocker.rnd.ki.sw.ericsson.se/bolte/bcam/bcam-compiler:cdt_2.6.1-node_14.5 cat</span><br><span class="line">e2849d6f818cb1ccacc1ce58c41d2695d0315b60b37f976c221397a997a856a2</span><br></pre></td></tr></table></figure>
<p>[–rm](<a href="https://blog.csdn.net/nzjdsds/article/details/8hexo">https://blog.csdn.net/nzjdsds/article/details/8hexo</a> 1981732): clean up <br><a href="https://www.imooc.com/qadetail/327658">-it</a>: wait for container cmds to be executed <br>-d: run in background and return container id <br>–mount: <a href="https://blog.csdn.net/longlong6682/article/details/104730138">https://blog.csdn.net/longlong6682/article/details/104730138</a> <br>cat: seems like catting the container id</p>
 <center><a id="more"></a></center>

<blockquote>
<p><em>other refs:</em></p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/run/">https://docs.docker.com/engine/reference/commandline/run/</a></li>
<li><a href="https://www.jianshu.com/p/f83f809d7b6f">https://www.jianshu.com/p/f83f809d7b6f</a></li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                                                           COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">e2849d6f818c        .../bolte/bcam/bcam-compiler:cdt_2.6.1-node_14.5   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   2 seconds ago       Up 2 second</span><br><span class="line">$ docker <span class="built_in">exec</span> -it e284 bash</span><br><span class="line">root@e2849d6f818c:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">root@57b9f72a7d6a:/# USER=root</span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# sed -i &quot;s/</span>^\(.*\\<span class="string">&quot;lamda-optimizer\&quot;:\).*/\1 \&quot;^0.3.6\&quot;,/&quot;</span> <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>node_modules<span class="regexp">/@uisdk/</span>cdt-build/<span class="keyword">package</span>.json</span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# sed -i &quot;s/</span>^\(.*\<span class="string">&quot;lamda\&quot;:\).*/\1 \&quot;^0.2.3\&quot;,/&quot;</span> <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>node_modules<span class="regexp">/@uisdk/</span>cdt-serve/<span class="keyword">package</span>.json</span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# cd /</span>usr<span class="regexp">/local/</span>lib<span class="regexp">/node_modules/</span><span class="meta">@uisdk</span><span class="regexp">/cdt-build/</span></span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# npm install --registry https:/</span><span class="regexp">/arm.sero.gic.ericsson.se/</span>artifactory<span class="regexp">/api/</span>npm<span class="regexp">/npm-remote/</span></span><br><span class="line">root@57b9f72a7d6a:/# cd -</span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# cd /</span>usr<span class="regexp">/local/</span>lib<span class="regexp">/node_modules/</span><span class="meta">@uisdk</span><span class="regexp">/cdt-serve/</span></span><br><span class="line">root@<span class="number">57</span><span class="attr">b9f72a7d6a:</span><span class="regexp">/# npm install --registry https:/</span><span class="regexp">/arm.sero.gic.ericsson.se/</span>artifactory<span class="regexp">/api/</span>npm<span class="regexp">/npm-remote/</span></span><br><span class="line">root@57b9f72a7d6a:/# cd -</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@32f850a89d63:&#x2F;# mkdir ~&#x2F;.m2</span><br><span class="line">root@32f850a89d63:&#x2F;# cp docker&#x2F;settings.xml ~&#x2F;.m2</span><br><span class="line">cp: cannot stat &#39;docker&#x2F;settings.xml&#39;: No such file or directory</span><br></pre></td></tr></table></figure>
<p>The <code>docker/settings.xml</code> does not exist because in real fast-test environment, all source code will be mounted to the container, here apparently no mounting step has been done. So I just make a <code>docker</code> directory and copy the <code>settings</code> file under it.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@32f850a89d63:&#x2F;# cat &gt; docker&#x2F;settings.xml &lt;&lt; EOF</span><br><span class="line">&lt;settings xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">          xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">          xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0</span><br><span class="line">          .....</span><br><span class="line">&gt; EOF</span><br><span class="line">root@32f850a89d63:&#x2F;# cp docker&#x2F;settings.xml ~&#x2F;.m2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@32f850a89d63:&#x2F;# cd coreservice&#x2F;frontend</span><br><span class="line">bash: cd: coreservice&#x2F;frontend: No such file or directory</span><br></pre></td></tr></table></figure>
<p>Same reason as before, so I mounted all source codes to container (better do it before start container)<br>If errors like <code>permission denied, mkdir</code> happens, try directly coping source code to container path. for example:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[home/eshibij/cec-3pp-upgrade]$ docker cp cec &lt;container-id&gt;:/mnt/share</span><br></pre></td></tr></table></figure>
<h4 id="issues"><a href="#issues" class="headerlink" title="issues"></a>issues</h4><ol>
<li><p>lamda-optimizer</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;node_modules&#x2F;lamda-optimizer&#x2F;lamda-optimizer.js:25</span><br><span class="line">    GLOBAL.define &#x3D; lamda.define;</span><br><span class="line">    ^</span><br><span class="line">ReferenceError: GLOBAL is not defined</span><br><span class="line">    at module.exports (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;node_modules&#x2F;lamda-optimizer&#x2F;lamda-optimizer.js:25:5)</span><br><span class="line">    at Object.executeLamda (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;tasks&#x2F;compile.js:256:35)</span><br><span class="line">    at Object.run (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;tasks&#x2F;compile.js:115:14)</span><br><span class="line">    at Runner.&lt;anonymous&gt; (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;config&#x2F;runner.js:98:18)</span><br><span class="line">    at Runner.emit (events.js:314:20)</span><br><span class="line">    at Runner.&lt;anonymous&gt; (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;config&#x2F;runner.js:72:18)</span><br><span class="line">    at Runner.emit (events.js:314:20)</span><br><span class="line">    at Runner.&lt;anonymous&gt; (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;config&#x2F;runner.js:114:18)</span><br><span class="line">    at Runner.emit (events.js:314:20)</span><br><span class="line">    at Runner.&lt;anonymous&gt; (&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;@uisdk&#x2F;cdt-build&#x2F;config&#x2F;runner.js:106:18)</span><br></pre></td></tr></table></figure>
<h3 id="Base-backend-node-debugging"><a href="#Base-backend-node-debugging" class="headerlink" title="Base (backend, node) debugging"></a>Base (backend, node) debugging</h3><p>Container is already built up in above, so just enter the source code and run compile script. It turned out no error. <br>Then come to the part of compile each service and run unit test. Some problems and solution during this proceed:</p>
</li>
<li><p>target port is already in use</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/mnt/share/cellinfoservice<span class="comment"># npm test</span></span><br><span class="line">&gt; BCAM_Cell_Info_Handler@1.0.0 <span class="built_in">test</span> /mnt/share/cellinfoservice</span><br><span class="line">&gt; cross-env NODE_ENV=LOCAL mocha <span class="built_in">test</span> --<span class="built_in">exit</span> --timeout=10000</span><br><span class="line">  1) Uncaught error outside <span class="built_in">test</span> suite</span><br><span class="line">  cell info server <span class="built_in">test</span></span><br><span class="line">(node:2739) [DEP0066] DeprecationWarning: OutgoingMessage.prototype._headers is deprecated</span><br><span class="line">(Use `node --trace-deprecation ...` to show <span class="built_in">where</span> the warning was created)</span><br><span class="line">    ✓ /</span><br><span class="line">    ✓ post file (100ms)</span><br><span class="line">    ✓ upload fail</span><br><span class="line">    ✓ get files</span><br><span class="line">    ✓ delete files</span><br><span class="line">    ✓ import cells (93ms)</span><br><span class="line">    ✓ import cells with iplanet (64ms)</span><br><span class="line">  7 passing (440ms)</span><br><span class="line">  1 failing</span><br><span class="line">  1) Uncaught error outside <span class="built_in">test</span> suite:</span><br><span class="line">     Uncaught Error: listen EADDRINUSE: address already <span class="keyword">in</span> use :::8082</span><br><span class="line">      at Server.setupListenHandle [as _listen2] (net.js:1316:16)</span><br><span class="line">      at listenInCluster (net.js:1364:12)</span><br><span class="line">      at Server.listen (net.js:1450:7)</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>
<p>solution: kill all node processes inside the container.</p>
<ul>
<li>find all processes: <code>docker exec &lt;container-id&gt; ps</code><br>the different between <code>docker exec ps</code> and <code>docker top &lt;container-id&gt;</code> is that the previous one returns pid inside container, but the latter returns pid and ppid of these processes on host server. Both cmds are executed outside the target container.</li>
<li>enter container and kill all node processes using <code>kill &lt;pid&gt;</code></li>
</ul>
<p>sample:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[home/eshibij/cec-3pp-upgrade]$ docker <span class="built_in">exec</span> f7748a275a7a ps</span><br><span class="line">PID TTY          TIME CMD</span><br><span class="line">1309 ?        00:00:00 node</span><br><span class="line">1331 ?        00:00:00 sh</span><br><span class="line">1332 ?        00:00:00 node</span><br><span class="line">1343 ?        00:00:00 node</span><br><span class="line">1365 ?        00:00:00 sh</span><br><span class="line">1366 ?        00:00:00 node</span><br><span class="line">1377 ?        00:00:00 node</span><br><span class="line">1399 ?        00:00:00 sh</span><br><span class="line">1400 ?        00:00:00 node</span><br><span class="line">2534 ?        00:00:00 node</span><br><span class="line">2546 ?        00:00:00 sh</span><br><span class="line">2547 ?        00:00:00 node</span><br><span class="line">2759 ?        00:00:00 ps</span><br><span class="line">[home/eshibij/cec-3pp-upgrade]$ docker <span class="built_in">exec</span> -it f7748a275a7a bash</span><br><span class="line">root@f7748a275a7a:/<span class="comment"># kill 1309</span></span><br><span class="line">root@f7748a275a7a:/<span class="comment"># kill 1332</span></span><br><span class="line">root@f7748a275a7a:/<span class="comment"># kill 1343</span></span><br><span class="line">...</span><br><span class="line">[home/eshibij/cec-3pp-upgrade]$ docker <span class="built_in">exec</span> f7748a275a7a ps</span><br><span class="line">PID TTY          TIME CMD</span><br><span class="line">2779 ?        00:00:00 ps</span><br></pre></td></tr></table></figure>
<p>Re-enter and run <code>npm test</code> to check unit test for each part:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/mnt/share/cellinfoservice<span class="comment"># npm test</span></span><br><span class="line">&gt; BCAM_Cell_Info_Handler@1.0.0 <span class="built_in">test</span> /mnt/share/cellinfoservice</span><br><span class="line">&gt; cross-env NODE_ENV=LOCAL mocha <span class="built_in">test</span> --<span class="built_in">exit</span> --timeout=10000</span><br><span class="line">  cell info server <span class="built_in">test</span></span><br><span class="line">(node:2815) [DEP0066] DeprecationWarning: OutgoingMessage.prototype._headers is deprecated</span><br><span class="line">(Use `node --trace-deprecation ...` to show <span class="built_in">where</span> the warning was created)</span><br><span class="line">    ✓ /</span><br><span class="line">    ✓ post file (88ms)</span><br><span class="line">    ✓ upload fail</span><br><span class="line">    ✓ get files</span><br><span class="line">    ✓ delete files</span><br><span class="line">    ✓ import cells (78ms)</span><br><span class="line">    ✓ import cells with iplanet (53ms)</span><br><span class="line">  7 passing (388ms)</span><br></pre></td></tr></table></figure></li>
<li><p>cross-env: Permission denied<br>error code:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/mnt/share/coreservice/backend<span class="comment"># npm test</span></span><br><span class="line">&gt; BCAM_Backend_Handler@1.0.0 <span class="built_in">test</span> /mnt/share/coreservice/backend</span><br><span class="line">&gt; cross-env NODE_ENV=LOCAL mocha <span class="built_in">test</span> --<span class="built_in">exit</span> --timeout=10000</span><br><span class="line">sh: 1: cross-env: Permission denied</span><br><span class="line">npm ERR! Test failed.  See above <span class="keyword">for</span> more details</span><br></pre></td></tr></table></figure>
<p>solution: rebuild and run test again</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm rebuild</span><br></pre></td></tr></table></figure></li>
<li><p>local test failed due to <code>&quot;before all&quot; hook</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/mnt/share/coreservice/backend<span class="comment"># npm test</span></span><br><span class="line">&gt; BCAM_Backend_Handler@1.0.0 <span class="built_in">test</span> /mnt/share/coreservice/backend</span><br><span class="line">&gt; cross-env NODE_ENV=LOCAL mocha <span class="built_in">test</span> --<span class="built_in">exit</span> --timeout=10000</span><br><span class="line">sequelize deprecated String based operators are now deprecated. Please use Symbol based operators <span class="keyword">for</span> better security, <span class="built_in">read</span> more at http://docs.sequelizejs.com/manual/tutorial/querying.html<span class="comment">#operators node_modules/sequelize/lib/sequelize.js:245:13</span></span><br><span class="line">  <span class="comment">#model.js</span></span><br><span class="line">    <span class="comment">#Cell test()</span></span><br><span class="line">      1) <span class="string">&quot;before all&quot;</span> hook</span><br><span class="line">  <span class="comment">#ENMJobtest.js</span></span><br><span class="line">    2) <span class="string">&quot;before all&quot;</span> hook: create ENMJobTest Datas</span><br><span class="line">    3) <span class="string">&quot;after all&quot;</span> hook</span><br><span class="line">  <span class="comment">#ENodeBTest.js</span></span><br><span class="line">    <span class="comment">#ENodeB test()</span></span><br><span class="line">      4) <span class="string">&quot;before all&quot;</span> hook: create ENodeBTest Datas</span><br><span class="line">  <span class="comment">#model.js</span></span><br><span class="line">    <span class="comment">#MbsArea test()</span></span><br><span class="line">      5) <span class="string">&quot;before all&quot;</span> hook</span><br></pre></td></tr></table></figure>
<p>It happened due to no local db was found by the test procedures, create postgre db using image <code>postgres:12.3-alpine</code> with</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --name bcamdb -e POSTGRES_PASSWORD=bcam -p5432:5432 -d postgres:12.3-alpine</span><br></pre></td></tr></table></figure>
<p>Enter the db and get its local address:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-5.0<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14468: eth0@if14469: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>Re-enter to backend container and ping the address to test connection:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/<span class="comment"># ping 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.067 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.050 ms</span><br><span class="line">^C</span><br><span class="line">  --- 172.17.0.2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</span><br></pre></td></tr></table></figure>
<p>re-write the backend env file <code>application-default.yml</code> and <code>application-local.yml</code>, retry and still failed.</p>
<ul>
<li>check if connection is able to be built:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ &gt;/dev/tcp/172.17.0.2/5432</span><br></pre></td></tr></table></figure>
no error throw out, so request to can be sent to db container</li>
<li>other debug:<br><code>&amp;</code> means running in background, also can be added after <code>npm test &amp;</code>, here I tried to do package capture but failed<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt install tcpdump</span><br><span class="line">$ tcpdump -i any port 5432 &amp;</span><br></pre></td></tr></table></figure>
check process in running and kill process:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -ef</span><br><span class="line">$ pkill npm</span><br><span class="line">$ pkill node</span><br><span class="line">$ pkill node npm</span><br></pre></td></tr></table></figure></li>
<li>logon the default postgre:    <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ su - postgres</span><br><span class="line">ddacfbb38c89:~$ psql</span><br></pre></td></tr></table></figure>
It is the issue concerning with <code>pg</code> module: <a href="https://github.com/brianc/node-postgres/issues/2170">https://github.com/brianc/node-postgres/issues/2170</a> <br>update the version of <a href="https://github.com/brianc/node-postgres/tree/master/packages/pg">pg</a> to <strong>v8.0.3</strong> or above solved this problem.</li>
</ul>
<p><strong>updated solution</strong> <br>use <code>--net</code> to attach your container directly to the host’s network interfaces.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --name &lt;container-name&gt; -e POSTGRES_PASSWORD=postgres --net=container:&lt;target-container-id&gt; -d &lt;image-name&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure>
<h3 id="backend-3pp-upgrade"><a href="#backend-3pp-upgrade" class="headerlink" title="backend 3pp upgrade"></a>backend 3pp upgrade</h3><p>For upgrade part, firstly get to know <a href="https://docs.npmjs.com/cli/update">https://docs.npmjs.com/cli/update</a> and <a href="https://docs.npmjs.com/cli/install">https://docs.npmjs.com/cli/install</a> <br>other refs:</p>
</li>
</ol>
<ul>
<li><a href="https://stackoverflow.com/questions/43127863/node-update-a-specific-package">https://stackoverflow.com/questions/43127863/node-update-a-specific-package</a></li>
<li><a href="https://stackoverflow.com/questions/16073603/how-do-i-update-each-dependency-in-package-json-to-the-latest-version">https://stackoverflow.com/questions/16073603/how-do-i-update-each-dependency-in-package-json-to-the-latest-version</a></li>
<li><a href="https://stackoverflow.com/questions/15890958/how-to-install-a-previous-exact-version-of-a-npm-package">https://stackoverflow.com/questions/15890958/how-to-install-a-previous-exact-version-of-a-npm-package</a></li>
</ul>
<p>Update step:</p>
<ul>
<li><p>update <code>package.json</code> file with given versions</p>
</li>
<li><p>run <code>npm install</code> to update package in <code>./node_modules</code></p>
</li>
<li><p>run <code>npm test</code> for all UTs or add <code>only</code> before <code>it</code> to run a single test like：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">/mnt/share/coreservice/backend $ npm test /test/CellTest.js -- -t <span class="string">&quot;#Cell test()&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="Handle-errors"><a href="#Handle-errors" class="headerlink" title="Handle errors"></a>Handle errors</h4><ol>
<li>port is in use:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1) Uncaught error outside <span class="built_in">test</span> suite:</span><br><span class="line">     Uncaught Error: listen EADDRINUSE: address already <span class="keyword">in</span> use :::8083</span><br></pre></td></tr></table></figure>
for case that <code>netstat</code> is not installed, use <code>ss -lp</code> instead to  check port:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/mnt/share/enmservice<span class="comment"># natstat -ano |grep 8083</span></span><br><span class="line">bash: natstat: <span class="built_in">command</span> not found</span><br><span class="line">root@f7748a275a7a:/mnt/share/enmservice<span class="comment"># ss -lp |grep 8083</span></span><br><span class="line">tcp    LISTEN     0      128    :::8083                 :::*                     users:((<span class="string">&quot;node&quot;</span>,pid=7662,fd=21))</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ss</code> is auto-defined as “another utility to investigate sockets”. For more information you can use <code>ss --help</code> or <code>man ss</code></p>
</blockquote>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> 7662</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>package <code>connect-multiparty</code> not compatible with node v14.<br>ref: <a href="https://github.com/expressjs/connect-multiparty/issues/29">https://github.com/expressjs/connect-multiparty/issues/29</a> <br>change to lib <code>multiparty</code> or <a href="https://visionary-s.github.io/2020/07/20/npm/">update node version to v14.6.0</a></li>
</ol>
</li>
</ul>
<ol start="3">
<li>Error: EPERM: operation not permitted, unlink ‘C:\work\cec\saiservice\node_modules.staging\semver-9c480dbf\README.md’<br>This usually occurs when the network connection is not stable. thx to <a href="https://blog.csdn.net/SilenceJude/article/details/101196261">https://blog.csdn.net/SilenceJude/article/details/101196261</a> <br><strong>Solution</strong>:<ul>
<li>delete <code>node_modules</code> folder in related package</li>
<li>npm install again</li>
<li>if not work, <code>npm cache clean -f</code> before installing</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>work flow</tag>
        <tag>record</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>File Upload and Display</title>
    <url>/2019/08/19/FileUploadAndDisplay/</url>
    <content><![CDATA[<p><a href="https://blog.csdn.net/WuLex/article/details/84296934">input [type=file] 获取上传文件的内容</a></p>
<p>Modify:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_addFileContent: <span class="function"><span class="keyword">function</span> (<span class="params">fileTag</span>) </span>&#123;</span><br><span class="line">    fileTag.addEventHandler(<span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">&quot;#fileUpload&quot;</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file = <span class="built_in">document</span>.getElementById(<span class="string">&quot;fileUpload&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (file.files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> trueFile = file.files[<span class="number">0</span>];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="built_in">document</span>.getElementById(<span class="string">&quot;fileContent&quot;</span>).value);</span><br><span class="line">                <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line"></span><br><span class="line">                reader.readAsText(trueFile, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                reader.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (reader.error) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(reader.error);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">var</span> urlData = <span class="built_in">this</span>.result;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">&quot;fileContent&quot;</span>).value = urlData;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Failed to upload file!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Other ref:<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/change">Change event | MDN</a></p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>jquery</tag>
      </tags>
  </entry>
  <entry>
    <title>ES6 - Template strings</title>
    <url>/2019/08/05/ES6-Template%20String/</url>
    <content><![CDATA[<p>刷题的时候遇到了这个新语法 - <strong>模板字符串</strong>，记录一下用法。</p>
<p>是增强版的字符串，用反引号（`）标识。主要用法：</p>
<ol>
<li><p>作为普通字符串使用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">`string text`</span></span><br></pre></td></tr></table></figure></li>
<li><p>定义多行字符串</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`string text line 1</span></span><br><span class="line"><span class="string">string text line 2`</span>);</span><br><span class="line"><span class="comment">// &quot;string text line 1</span></span><br><span class="line"><span class="comment">// string text line 2&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在字符串中嵌入变量</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> expression = <span class="string">&quot;xxxx&quot;</span>;</span><br><span class="line"><span class="string">`string text <span class="subst">$&#123;expression&#125;</span> string text`</span></span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>
</li>
<li><p>标签模板 (tagged template)<br>相当于一个模板函数，tag表示函数，整个表达式的返回值，就是tag函数处理模板字符串后的返回值。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">tag<span class="string">`Hello <span class="subst">$&#123; a + b &#125;</span> world <span class="subst">$&#123; a * b &#125;</span>`</span>;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">tag([<span class="string">&#x27;Hello &#x27;</span>, <span class="string">&#x27; world &#x27;</span>, <span class="string">&#x27;&#x27;</span>], <span class="number">15</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><em>For more specific explanation:</em><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">MDN</a><br><a href="http://es6.ruanyifeng.com/#docs/string">阮一峰</a> (start from section 5)</p>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo - Tools &amp; cmd used during deployment</title>
    <url>/2019/07/25/Hexo%20cmd&amp;debug/</url>
    <content><![CDATA[<p>Ref: <a href="https://caiyantao.gitee.io/2019/04/13/Hexo-%E4%B8%80/">https://caiyantao.gitee.io/2019/04/13/Hexo-%E4%B8%80/</a></p>
<h3 id="npm-CN-image（taobao）"><a href="#npm-CN-image（taobao）" class="headerlink" title="npm CN image（taobao）"></a>npm CN image（taobao）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<h3 id="Hexo-installation"><a href="#Hexo-installation" class="headerlink" title="Hexo installation"></a>Hexo installation</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>check if successfully installed</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo -v</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo: 3.9.0</span><br><span class="line">hexo-cli: 2.0.0</span><br><span class="line">os: Windows_NT 10.0.16299 win32 x64</span><br><span class="line">http_parser: 2.8.0</span><br><span class="line">node: 10.16.0</span><br><span class="line">v8: 6.8.275.32-node.52</span><br><span class="line">uv: 1.28.0</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">brotli: 1.0.7</span><br><span class="line">ares: 1.15.0</span><br><span class="line">modules: 64</span><br><span class="line">nghttp2: 1.34.0</span><br><span class="line">napi: 4</span><br><span class="line">openssl: 1.1.1b</span><br><span class="line">icu: 64.2</span><br><span class="line">unicode: 12.1</span><br><span class="line">cldr: 35.1</span><br><span class="line">tz: 2019a</span><br></pre></td></tr></table></figure>
### Local init for first time setup
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo init</span><br></pre></td></tr></table></figure>
### Start server and Run in browser
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
Visit <http://localhost:4000/>

<h3 id="Add-ssh-key"><a href="#Add-ssh-key" class="headerlink" title="Add ssh-key"></a>Add ssh-key</h3><p>Pass</p>
<h3 id="When-error-generated-local-compile"><a href="#When-error-generated-local-compile" class="headerlink" title="When error generated (local compile)"></a>When error generated (local compile)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo g    <span class="comment"># gengerate post to public folder</span></span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
<h3 id="Deploy-to-github"><a href="#Deploy-to-github" class="headerlink" title="Deploy to github"></a>Deploy to github</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>

<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><ol>
<li>error:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Template render error: (unknown path)</span><br><span class="line"> Error: expected end of comment, got end of file</span><br><span class="line"> at Object._prettifyError (C:\Users\eshibij\p_blog\node_modules\nunjucks\src\lib.js:36:11)</span><br></pre></td></tr></table></figure>
error occurs when generating, due to <a href="https://github.com/hexojs/hexo/issues/2070">https://github.com/hexojs/hexo/issues/2070</a></li>
</ol>
<h3 id="hexo-upgrade"><a href="#hexo-upgrade" class="headerlink" title="hexo upgrade"></a>hexo upgrade</h3><p>for incompatible hexo version with node v14, need to upgrade hexo to v5.0+  </p>
<p>Modify package.json file, inside <code>dependencies</code> braces:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">  &quot;hexo&quot;: &quot;^3.9.0&quot;,</span><br><span class="line">  &quot;hexo-deployer-git&quot;: &quot;^1.0.0&quot;,</span><br><span class="line">  &quot;hexo-generator-archive&quot;: &quot;^0.1.5&quot;,</span><br><span class="line">  &quot;hexo-generator-category&quot;: &quot;^0.1.3&quot;,</span><br><span class="line">  &quot;hexo-generator-index-pin-top&quot;: &quot;^0.2.2&quot;,</span><br><span class="line">  &quot;hexo-generator-searchdb&quot;: &quot;^1.0.8&quot;,</span><br><span class="line">  &quot;hexo-generator-tag&quot;: &quot;^0.2.0&quot;,</span><br><span class="line">  &quot;hexo-renderer-ejs&quot;: &quot;^0.3.1&quot;,</span><br><span class="line">  &quot;hexo-renderer-marked&quot;: &quot;^1.0.1&quot;,</span><br><span class="line">  &quot;hexo-renderer-stylus&quot;: &quot;^0.3.3&quot;,</span><br><span class="line">  &quot;hexo-server&quot;: &quot;^0.3.3&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>change <code>&quot;hexo&quot;: &quot;^3.9.0&quot;</code> -&gt; <code>&quot;hexo&quot;: &quot;^5.0.0&quot;</code><br><strong>UNNECESSARY</strong> to change</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;hexo&quot;: &#123;</span><br><span class="line">  &quot;version&quot;: &quot;3.9.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>it will be updated to version above 5.0.0 after running <code>npm update</code><br>after updating, check hexo version:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo -v</span><br><span class="line">INFO  Validating config</span><br><span class="line">hexo: 5.3.0</span><br><span class="line">hexo-cli: 2.0.0</span><br><span class="line">os: Windows_NT 10.0.18363 win32 x64</span><br><span class="line">node: 14.6.0</span><br><span class="line">v8: 8.4.371.19-node.12</span><br><span class="line">uv: 1.38.1</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">brotli: 1.0.7</span><br><span class="line">ares: 1.16.0</span><br><span class="line">modules: 83</span><br><span class="line">nghttp2: 1.41.0</span><br><span class="line">napi: 6</span><br><span class="line">llhttp: 2.0.4</span><br><span class="line">openssl: 1.1.1g</span><br><span class="line">cldr: 37.0</span><br><span class="line">icu: 67.1</span><br><span class="line">tz: 2020a</span><br><span class="line">unicode: 13.0</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo Theme Modification</title>
    <url>/2019/07/17/Hexo%20Theme%20Modification/</url>
    <content><![CDATA[<p>Modify the Theme in the following branch:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Source/themes/&lt;Theme folder name&gt;/layout/_partial/*.ejs</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hard &amp; Soft Dependencies</title>
    <url>/2019/07/25/Hard%20or%20Soft%20Dependencies/</url>
    <content><![CDATA[<p>ref: <a href="https://magento.stackexchange.com/questions/151250/whats-a-hard-dependency-and-whats-a-soft-dependency">https://magento.stackexchange.com/questions/151250/whats-a-hard-dependency-and-whats-a-soft-dependency</a></p>
<h2 id="Hard-Dependency"><a href="#Hard-Dependency" class="headerlink" title="Hard Dependency"></a>Hard Dependency</h2><p>a module <strong>cannot</strong> function without the other modules on which it depends</p>
<ul>
<li><p>The module contains code that directly uses logic from another module (<strong>instances, class constants, static methods, public class properties, interfaces and traits</strong>).</p>
</li>
<li><p>The module contains strings that include <strong>class names, methods names, class constants, class properties, interfaces, and traits</strong> from another module.</p>
</li>
<li><p>The module de-serializes an <strong>object declared in another module</strong>.</p>
</li>
<li><p>The module uses or modifies the <strong>database tables used by another module</strong>.</p>
<center><a id="more"></a></center>

</li>
</ul>
<h2 id="Soft-Dependency"><a href="#Soft-Dependency" class="headerlink" title="Soft Dependency"></a>Soft Dependency</h2><p>a module <strong>can</strong> function without the other modules on which it depends</p>
<ul>
<li>The module directly <strong>checks</strong> another module’s availability.</li>
<li>The module <strong>extends</strong> another module’s configuration.</li>
<li>The module extends another module’s layout.</li>
</ul>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo - Tools &amp; cmd used during deployment</title>
    <url>/2019/07/25/Hexo%20cmd/</url>
    <content><![CDATA[<p>Ref: <a href="https://caiyantao.gitee.io/2019/04/13/Hexo-%E4%B8%80/">https://caiyantao.gitee.io/2019/04/13/Hexo-%E4%B8%80/</a></p>
<h3 id="npm-CN-image（taobao）"><a href="#npm-CN-image（taobao）" class="headerlink" title="npm CN image（taobao）"></a>npm CN image（taobao）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<h3 id="Hexo-installation"><a href="#Hexo-installation" class="headerlink" title="Hexo installation"></a>Hexo installation</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>check if successfully installed</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo -v</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo: 3.9.0</span><br><span class="line">hexo-cli: 2.0.0</span><br><span class="line">os: Windows_NT 10.0.16299 win32 x64</span><br><span class="line">http_parser: 2.8.0</span><br><span class="line">node: 10.16.0</span><br><span class="line">v8: 6.8.275.32-node.52</span><br><span class="line">uv: 1.28.0</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">brotli: 1.0.7</span><br><span class="line">ares: 1.15.0</span><br><span class="line">modules: 64</span><br><span class="line">nghttp2: 1.34.0</span><br><span class="line">napi: 4</span><br><span class="line">openssl: 1.1.1b</span><br><span class="line">icu: 64.2</span><br><span class="line">unicode: 12.1</span><br><span class="line">cldr: 35.1</span><br><span class="line">tz: 2019a</span><br></pre></td></tr></table></figure>
### Local init for first time setup
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo init</span><br></pre></td></tr></table></figure>
### Start server and Run in browser
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
Visit <http://localhost:4000/>

<h3 id="Add-ssh-key"><a href="#Add-ssh-key" class="headerlink" title="Add ssh-key"></a>Add ssh-key</h3><p>Pass</p>
<h3 id="When-error-generated-local-compile"><a href="#When-error-generated-local-compile" class="headerlink" title="When error generated (local compile)"></a>When error generated (local compile)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo g    <span class="comment"># gengerate post to public folder</span></span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
<h3 id="Deploy-to-github"><a href="#Deploy-to-github" class="headerlink" title="Deploy to github"></a>Deploy to github</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s - kubectl</title>
    <url>/2020/04/07/Kubernetes/</url>
    <content><![CDATA[<p>Every time before start kubectl, remember export <code>admin.config</code> file first which contains server info for connection. The pwd should under path where the config file lies.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> KUBECONFIG=./admin.conf</span><br></pre></td></tr></table></figure>
<p>then start nodes</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get node</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get node -n testing</span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>

<h3 id="useful-cmd"><a href="#useful-cmd" class="headerlink" title="useful cmd"></a>useful cmd</h3><ol>
<li><p>通过bash获得pod中某个容器的TTY，相当于登录容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -n &lt;namespace&gt; -- bash</span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://www.cnblogs.com/klvchen/archive/2018/09/04/9585746.html">kubectl 常用命令总结</a></p>
</li>
<li><p><code>--</code><br>shell命令前，要加– 号，不然shell命令中的参数，不能识别 <br><a href="https://www.wandouip.com/t5i281271/">https://www.wandouip.com/t5i281271/</a></p>
</li>
<li><p>获取异常容器 <em>(for debug)</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get pods -n kube-system | grep -v Running</span><br></pre></td></tr></table></figure></li>
<li><p>get pod description <em>(for debug)</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod &lt;pod-name&gt; -n &lt;namespaces-name&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>查看异常pod的日志 <em>(for debug)</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl logs &lt;pod-name&gt; -n &lt;namespaces-name&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>查看相关的config map存不存在 <em>(for debug)</em> <br>find the path to configmap file first</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls -l   <span class="comment"># if the result is &quot;total 0&quot;, means the configmap is not exist</span></span><br></pre></td></tr></table></figure></li>
<li><p>delete pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete pod &lt;pod-name&gt; -n &lt;namespaces-name&gt;</span><br></pre></td></tr></table></figure>
<p><code>-n &lt;namespaces-name&gt;</code> can be omitted.</p>
</li>
</ol>
<p>delete pods in batches (e.g. delete all evicted pods)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -A| grep Evicted | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs kubectl delete pod -n cec</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>create namespace<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create namespace &lt;name&gt;</span><br></pre></td></tr></table></figure></li>
<li>check detailed info (especially for ip), add <code>-o wide</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get node -o wide -A</span><br><span class="line">NAME                  STATUS   ROLES    AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">pccc-303-7-master-1   Ready    master   3h12m   v1.18.2   192.168.2.1   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.27.2.el7.x86_64   docker://19.3.5</span><br><span class="line">pccc-303-7-worker-1   Ready    worker   3h10m   v1.18.2   11.110.2.2    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.27.2.el7.x86_64   docker://19.3.5</span><br><span class="line">pccc-303-7-worker-2   Ready    worker   3h10m   v1.18.2   11.110.2.3    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.27.2.el7.x86_64   docker://19.3.5</span><br><span class="line">pccc-303-7-worker-3   Ready    worker   3h10m   v1.18.2   11.110.2.4    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.27.2.el7.x86_64   docker://19.3.5</span><br></pre></td></tr></table></figure></li>
<li><code>watch -d</code>: monitor all pods status with certain namespace:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ watch -d kubectl get pods -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li>
<li>Tail the system journal log<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ journalctl -f</span><br></pre></td></tr></table></figure></li>
<li>List config maps<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get configmap -A</span><br><span class="line"><span class="comment"># Check the configmap name for a specific namespace</span></span><br><span class="line">$ kubectl get cm -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># Check the config in a configmap</span></span><br><span class="line">$ kubectl describe cm -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># Edit a configmap</span></span><br><span class="line">$ kubectl edit configmap -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li>
<li>List all services in a namespace, with extended info<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n &lt;namespace&gt; -o json</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>JS-Label</title>
    <url>/2019/07/25/JS-Label/</url>
    <content><![CDATA[<p>标签（label），相当于定位符，用于跳转到程序的任意位置。</p>
<ol>
<li><p>配合break</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">top:  <span class="comment">// Label</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (i === <span class="number">1</span> &amp;&amp; j === <span class="number">1</span>) <span class="keyword">break</span> top; <span class="comment">// 注意，不加引号</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;i=&#x27;</span> + i + <span class="string">&#x27;, j=&#x27;</span> + j);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// i=0, j=0</span></span><br><span class="line"><span class="comment">// i=0, j=1</span></span><br><span class="line"><span class="comment">// i=0, j=2</span></span><br><span class="line"><span class="comment">// i=1, j=0</span></span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>
如果满足if，直接跳出双重循环。
</li>
<li><p>配合continue</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">top:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (i === <span class="number">1</span> &amp;&amp; j === <span class="number">1</span>) <span class="keyword">continue</span> top;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;i=&#x27;</span> + i + <span class="string">&#x27;, j=&#x27;</span> + j);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// i=0, j=0</span></span><br><span class="line"><span class="comment">// i=0, j=1</span></span><br><span class="line"><span class="comment">// i=0, j=2</span></span><br><span class="line"><span class="comment">// i=1, j=0</span></span><br><span class="line"><span class="comment">// i=2, j=0</span></span><br><span class="line"><span class="comment">// i=2, j=1</span></span><br><span class="line"><span class="comment">// i=2, j=2</span></span><br></pre></td></tr></table></figure>
<p>当i=1，j=1时，跳过打印（当前内层循环）直接进行下一个外层循环（不会跳出top）</p>
</li>
<li><p>label用于跳出代码块</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">foo: &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">break</span> foo;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;本行不会输出&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://wangdoc.com/javascript/basic/grammar.html#%E8%AF%AD%E5%8F%A5">阮一峰</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>JS对象引用</title>
    <url>/2019/07/25/JS%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8/</url>
    <content><![CDATA[<p>如果不同的变量名指向同一个对象，那么它们都是这个对象的引用，也就是说指向同一个内存地址。修改其中一个变量，会影响到其他所有变量。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o1 = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> o2 = o1;</span><br><span class="line"></span><br><span class="line">o1.a = <span class="number">1</span>;</span><br><span class="line">o2.a <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">o2.b = <span class="number">2</span>;</span><br><span class="line">o1.b <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>
上面代码中，o1和o2指向同一个对象，因此为其中任何一个变量添加属性，另一个变量都可以读写该属性。

<p>如果取消某一个变量对于原对象的引用，不会改变已经引用过的另一个变量。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o1 = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> o2 = o1;</span><br><span class="line"></span><br><span class="line">o1 = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(o2);    <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(o1);    <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span> o1); <span class="comment">// number</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，o1和o2指向同一个对象，然后o1的值变为1，这时不会对o2产生影响，o2还是指向原来的那个对象。</p>
<p><strong><font color=red>注意：这种引用只局限于object</font></strong>,如果两个变量指向同一个原始类型的值，则变量这时都是值的拷贝。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> y = x;</span><br><span class="line"></span><br><span class="line">x = <span class="number">2</span>;</span><br><span class="line">y <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，当x的值变化后，y值不变，这就表示y和x并不是指向同一个内存地址。</p>
<p>ref: <a href="https://wangdoc.com/javascript/types/object.html">阮一峰</a></p>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>NBI &amp; SBI</title>
    <url>/2019/12/23/NBIandSBI/</url>
    <content><![CDATA[<h2 id="Northbound-Interface"><a href="#Northbound-Interface" class="headerlink" title="Northbound Interface"></a>Northbound Interface</h2><p>NBI conceptualizes lower level details (e.g. data or functions) used by, or in the component. It interfaces to higher level layers and is normally drawn at the top of an architectural overview.<br><em>e.g. REST API, SMMP, CORBA, SNMP</em><br>北向接口，用于接口编程开发各app，采集、分析app在运行中产生的各种数据，因网络管理中从上而下分应用层、数据处理层、数据管理层，北向接口即应用层和数据处理层之间的数据交互定义接口（见下图），因为朝上（上北下南）称北向接口。</p>
<h2 id="Southbound-Interface"><a href="#Southbound-Interface" class="headerlink" title="Southbound Interface"></a>Southbound Interface</h2><p>A southbound interface decomposes concepts in the technical details, mostly specific to a single component of the architecture. Southbound interfaces are drawn at the bottom of an architectural overview.<br><em>e.g. OpenFlow, NETCONF, XMPP</em></p>
 <center><a id="more"></a></center>

<hr>
<p><strong>A Northbound interface goes “up” and a Southbound interface goes “down”.</strong><br>northbound interfaces go towards the core of the data center or towards the Internet-facing egress of the network.  Southbound goes towards the end-users/servers/VMs.<br>Northbound interfaces normally talk to southbound interfaces of higher level components and vice versa.</p>
<center>
<img src=https://res.cloudinary.com/elizashi/image/upload/v1577086420/gitblog/posts/nbi/Capture_isxpve.png style="width: 80%"/>
</center>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>interface</tag>
      </tags>
  </entry>
  <entry>
    <title>Post photos to Gallery</title>
    <url>/2019/07/25/Post%20photos%20to%20Gallery/</url>
    <content><![CDATA[<h3 id="How-to-post-a-photo-to-blog-gallery"><a href="#How-to-post-a-photo-to-blog-gallery" class="headerlink" title="How to post a photo to blog gallery"></a>How to post a photo to blog gallery</h3><h4 id="1-Setup-the-gallery-page"><a href="#1-Setup-the-gallery-page" class="headerlink" title="1. Setup the gallery page:"></a>1. Setup the gallery page:</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new page gallery      // create <span class="string">&#x27;gallery&#x27;</span> page</span><br><span class="line"></span><br><span class="line">$ hexo new page about        // create <span class="string">&#x27;about&#x27;</span> page</span><br><span class="line">$ hexo new page tags         // <span class="string">&#x27;tags&#x27;</span> page</span><br><span class="line">$ hexo new page categories   // <span class="string">&#x27;categories&#x27;</span> page</span><br></pre></td></tr></table></figure>
<h4 id="2-Find-the-index-md-and-modify-it"><a href="#2-Find-the-index-md-and-modify-it" class="headerlink" title="2. Find the index.md and modify it."></a>2. Find the index.md and modify it.</h4><p>After step 1, there will be folders named “gallery”, “about”… under /source/.<br> <center><a id="more"></a></center></p>
<p>And you can find a file named “index.md” generated automatically under these folders.<br>Open and modify the front-matter part as :</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: Gallery</span><br><span class="line">albums: [</span><br><span class="line">        [<span class="string">&quot;img_url&quot;</span>,<span class="string">&quot;img_caption&quot;</span>],</span><br><span class="line">        [<span class="string">&quot;img_url&quot;</span>,<span class="string">&quot;img_caption&quot;</span>]</span><br><span class="line">        ]</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>use outer links can be a better way as internal insert of images will decrease loading speed.<br>(I haven’t find a good-way to insert as internal files, so I turned to use weibo-albums-link as alt… ).</p>
<p>There was something wrong that photos didn’t display successfully in mobile mode.</p>
<ul>
<li><strong>190725 Update</strong>: Problem fixed with changing photo cloud storage from weibo to <a href="https://cloudinary.com/">cloudinary</a>. (weibo albums no longer support free external ref links)</li>
</ul>
<h4 id="same-way-to-edit-the-“about”-page"><a href="#same-way-to-edit-the-“about”-page" class="headerlink" title="same way to edit the “about” page"></a>same way to edit the “about” page</h4>]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Migrate local video header to cloud storage</title>
    <url>/2019/07/25/Migrate%20local%20video%20header%20to%20cloud%20storage/</url>
    <content><![CDATA[<p> Since the Ocean theme includes and initiates the videos and images about header via local folder <code>themes/ocean/source/images/ocean/</code>, the page loads slowly at mobile device. So I decided to transfer these large files to cloud side to promote loading speed.</p>
<ol>
<li><p>Find the local image folder as referred above.</p>
</li>
<li><p>upload these files to <a href="https://cloudinary.com/">cloudinary</a>, it provides plugin as a module to js file:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">cloudinary.videoTag(<span class="string">&#x27;gitblog/ocean/ocean_j5rpnt&#x27;</span>).toHtml();</span><br></pre></td></tr></table></figure>
<p>the src ref-way can be find at <strong>“edit”</strong> page by right clicking on cloudinary/file.<br>Here I did not use this short path cuz I am not in need of a large quantity of inserted files.</p>
<center><a id="more"></a></center>

</li>
</ol>
<ol start="3">
<li>Modify <code>themes/ocean/_config.yml</code>:<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ocean Video</span></span><br><span class="line"><span class="comment"># Because I put videos in multiple formats on the same path, I just labeled the path here.</span></span><br><span class="line"><span class="attr">ocean:</span></span><br><span class="line">  <span class="attr">overlay:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">https://res.cloudinary.com/elizashi/</span></span><br><span class="line">  <span class="comment"># path: /images/ocean/</span></span><br><span class="line">  <span class="attr">brand:</span> <span class="string">/images/ming-inverted.svg</span></span><br></pre></td></tr></table></figure></li>
<li>Find the <code>ocean.ejs</code> file in <code>themes/ocean/layout/_partial/</code>, and modify as follows:<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;% if (theme.ocean.overlay) &#123; %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;video-frame&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;%- theme.ocean.path %&gt;image/upload/v1564042232/gitblog/ocean/overlay-hero_hfo1px.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Decorative image frame&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;video-media&quot;</span>&gt;</span><br><span class="line">  &lt;video playsinline=<span class="string">&quot;&quot;</span> autoplay=<span class="string">&quot;&quot;</span> loop=<span class="string">&quot;&quot;</span> muted=<span class="string">&quot;&quot;</span> data-autoplay=<span class="string">&quot;&quot;</span></span><br><span class="line">         poster=<span class="string">&quot;&lt;%- theme.ocean.path %&gt;image/upload/v1564042234/gitblog/ocean/ocean_dvmafj.png&quot;</span> x5-video-player-type=<span class="string">&quot;h5&quot;</span>&gt;</span><br><span class="line">    &lt;source src=<span class="string">&quot;&lt;%- theme.ocean.path %&gt;video/upload/v1564042238/gitblog/ocean/ocean_j5rpnt.mp4&quot;</span> type=<span class="string">&quot;video/mp4&quot;</span>&gt;</span><br><span class="line">    &lt;source src=<span class="string">&quot;&lt;%- theme.ocean.path %&gt;video/upload/v1564042232/gitblog/ocean/ocean_p4kg5c.ogv&quot;</span> type=<span class="string">&quot;video/ogg&quot;</span>&gt;</span><br><span class="line">    &lt;source src=<span class="string">&quot;&lt;%- theme.ocean.path %&gt;video/upload/v1564042238/gitblog/ocean/ocean_qgwvjh.webm&quot;</span> type=<span class="string">&quot;video/webm&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Your user agent does not support the HTML5 Video element.&lt;/p&gt;</span><br><span class="line">  &lt;/video&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;video-overlay&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
As I mentioned that I am not using many external src so I modify each file address one by one.<br>If files come to more, shall turn to use the <code>cloudinary.videoTag</code> func to insert files or the code will get lengthy and jumbled.</li>
</ol>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Angular</title>
    <url>/2021/03/23/angular/</url>
    <content><![CDATA[<p>This article is created for recording problems when I learning Angular.</p>
<center><a id="more"></a></center>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>frontend</tag>
        <tag>framework</tag>
        <tag>typescript</tag>
      </tags>
  </entry>
  <entry>
    <title>Tips for create-react-app</title>
    <url>/2020/01/19/create-react-app/</url>
    <content><![CDATA[<p>This is a recording work while using create-react-app.</p>
<h3 id="ERROR-SKIP-PREFLIGHT-CHECK-true"><a href="#ERROR-SKIP-PREFLIGHT-CHECK-true" class="headerlink" title="[ERROR] SKIP_PREFLIGHT_CHECK=true"></a>[ERROR] SKIP_PREFLIGHT_CHECK=true</h3><p>error happens when run <code>npm start</code>:<br><img src="https://res.cloudinary.com/elizashi/image/upload/v1579140501/gitblog/posts/create-react-app/react-npm-start-error_fk5pfl.png" alt="Alt"></p>
<p><strong>Solution:</strong></p>
<ol>
<li>create a new file named <strong>.env</strong> in folder.</li>
<li>write cmd <code>SKIP_PREFLIGHT_CHECK=true</code> into the file, save and restart npm.</li>
</ol>
<center><a id="more"></a></center>

<hr>
<h3 id="change-the-localhost-port-3000"><a href="#change-the-localhost-port-3000" class="headerlink" title="change the localhost port 3000"></a>change the localhost port 3000</h3><ol>
<li><p>write in <code>.env</code> file with:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PORT=2200</span><br></pre></td></tr></table></figure>
<p>This works on Windows, not tried on Mac OS.</p>
</li>
<li><p>On windows with <code>npm</code> (works): <br>in <code>package.json</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;set PORT=2200&amp;&amp;react-scripts start&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>On Windows with <code>yarn</code> (not tried): <br>in <code>package.json</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;set PORT=2200 &amp;&amp; react-scripts start&quot;</span>,</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure></li>
<li><p>using npm <a href="https://www.npmjs.com/package/cross-env"><code>cross-env</code></a> (not tried):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;start&quot;</span>: <span class="string">&quot;cross-env PORT=3006 react-scripts start&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This method need to install cross-env to project first:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install --save-dev cross-env</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="ERROR-Module-not-found-Can’t-resolve-‘react-router-dom’-in-‘C-my-cv-src’"><a href="#ERROR-Module-not-found-Can’t-resolve-‘react-router-dom’-in-‘C-my-cv-src’" class="headerlink" title="[ERROR] Module not found: Can’t resolve ‘react-router-dom’ in ‘C:...\my-cv\src’"></a>[ERROR] Module not found: Can’t resolve ‘react-router-dom’ in ‘C:...\my-cv\src’</h3><p>It means dependency <code>react-router-dom</code> have not been added/installed. just run:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install react-router-dom</span><br></pre></td></tr></table></figure>
<p>The dependency will be automatically added to <code>package.json</code> and <code>package-lock.json</code> with latest version. Then npm start again.</p>
<hr>
<h3 id="Add-stylesheets-Sass"><a href="#Add-stylesheets-Sass" class="headerlink" title="Add stylesheets (Sass)"></a>Add stylesheets (Sass)</h3><ol>
<li>install <code>node-sass</code>:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install node-sass --save</span><br></pre></td></tr></table></figure></li>
<li>rename <code>&lt;filename&gt;.css</code> file to <code>&lt;filename&gt;.module.scss</code>. <br>About <code>.module</code>: 个人理解是为了避免同名的class作用域互相影响，把这个stylesheet限定仅用于此module (即编译后class前加一个stylesheetname-前缀，用以区分) <br>For more details, see <a href="https://blog.bitsrc.io/how-to-use-sass-and-css-modules-with-create-react-app-83fa8b805e5e">CSS Modules</a> part in this post.</li>
</ol>
<hr>
<h3 id="Heroku-ERROR-SecurityError-Failed-to-construct-‘WebSocket’"><a href="#Heroku-ERROR-SecurityError-Failed-to-construct-‘WebSocket’" class="headerlink" title="[Heroku ERROR] SecurityError: Failed to construct ‘WebSocket’"></a>[Heroku ERROR] SecurityError: Failed to construct ‘WebSocket’</h3><p><code>SecurityError: Failed to construct &#39;WebSocket&#39;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</code> <br>This is due to <code>react-scripts 3.3.0</code>, check webpack script in <code>node_modules/react-dev-utils/webpackHotDevClient.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// line 62, the original protocol is &#x27;ws&#x27;, change it to:</span></span><br><span class="line">  protocol: <span class="built_in">window</span>.location.protocol === <span class="string">&#x27;https:&#x27;</span> ? <span class="string">&#x27;wss&#x27;</span> : <span class="string">&#x27;ws&#x27;</span>,</span><br><span class="line">  <span class="comment">// which means using &#x27;wss&#x27; when connection is secure</span></span><br></pre></td></tr></table></figure>
<p>But the problem is not resovled, cuz when Heroku deploy the app, it automatically downloads the node_modules, which will rewrite the script. So the only way I can fix this issue at present is <strong>downgrade react-scripts to 3.2.0</strong> in <code>package.json</code>. <br>For more discussion about this problem, see <a href="https://stackoverflow.com/questions/59359280/react-app-error-failed-to-construct-websocket-an-insecure-websocket-connecti">stackoverflow</a>.</p>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>framework</tag>
      </tags>
  </entry>
  <entry>
    <title>CDT App Lifecycle</title>
    <url>/2019/07/25/cdt-app-lifecycle/</url>
    <content><![CDATA[<p>Apps that run in the container have their lifecycle managed.<br>The container checks for various functions implemented by the app. If those functions are implemented, the container will execute them accordingly. The following functions are supported by the container:</p>
<h4 id="1-void-onStart"><a href="#1-void-onStart" class="headerlink" title="1. void onStart()"></a>1. void onStart()</h4><p>This method is called when the app is first instantiated in the current tab for the first time.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">onStart: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-void-onPause"><a href="#2-void-onPause" class="headerlink" title="2. void onPause()"></a>2. void onPause()</h4><p>This method is called when the user has left your app to view a different app.<br> <center><a id="more"></a></center></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">onPause: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-void-onResume"><a href="#3-void-onResume" class="headerlink" title="3. void onResume()"></a>3. void onResume()</h4><p>This method is called when the user has navigated away from the app to a different app, and has navigated back.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">onResume: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>CDT</tag>
        <tag>dev-env</tag>
      </tags>
  </entry>
  <entry>
    <title>docker errors in daily use</title>
    <url>/2020/05/13/docker-error/</url>
    <content><![CDATA[<h3 id="Error1"><a href="#Error1" class="headerlink" title="Error1"></a>Error1</h3><ul>
<li><p>Steps to reproduce the error:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -A</span><br><span class="line">Unable to connect to the server: EOF</span><br></pre></td></tr></table></figure>
<p>According to <a href="https://stackoverflow.com/questions/55234700/docker-for-windows-ce-kubernetes-unable-to-connect-to-the-server-eof">this answer</a>, I tried</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps -a --filter name=k8s_kubedns_kube-dns --format <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;&quot;</span></span><br><span class="line">Error response from daemon: open \\.\pipe\docker_engine_linux: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">Error response from daemon: open \\.\pipe\docker_engine_linux: The system cannot find the file specified.</span><br><span class="line">$ docker info</span><br><span class="line">Client:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line">Server:</span><br><span class="line">ERROR: Error response from daemon: open \\.\pipe\docker_engine_linux: The system cannot find the file specifie                                                                            d.</span><br><span class="line">errors pretty printing info</span><br></pre></td></tr></table></figure>
<p>Search for <code>Error response from daemon</code>, I found <a href="https://github.com/docker/for-win/issues/4495">this issue</a> same to mine</p>
<center><a id="more"></a></center>
</li>
<li><p>Solution: <strong>Restart docker via docker desktop</strong>, right click and choose ‘restart’.</p>
</li>
</ul>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Git cmd for daily use</title>
    <url>/2019/07/11/git-for-daily-use/</url>
    <content><![CDATA[<h4 id="Codes-commit-procedure-for-daily-work"><a href="#Codes-commit-procedure-for-daily-work" class="headerlink" title="Codes commit procedure for daily work:"></a>Codes commit procedure for daily work:</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status          <span class="comment"># check current modifications</span></span><br></pre></td></tr></table></figure>
<p>see detailed changes from current code:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git diff</span><br></pre></td></tr></table></figure>
<p>Add work:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add .           <span class="comment"># do not miss &quot;.&quot;</span></span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -u</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<p><a href="https://www.cnblogs.com/skura23/p/5859243.html">add -u 和 add . 的区别</a></p>
<p>Check status and see that modifications displayed in green.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -m <span class="string">&quot;[Task/Bug] Jira-id : Jira Task content.&quot;</span></span><br></pre></td></tr></table></figure>
<p>if there’s any change not need is added, withdraw the addition with:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git reset HEAD              <span class="comment"># reset all added files</span></span><br><span class="line">$ git reset HEAD &lt;file-name&gt;  <span class="comment"># reset certain file</span></span><br></pre></td></tr></table></figure>
<p><strong>Notice</strong>:</p>
<ul>
<li>better to build locally first and see if it will get failed. (Close local server before building, no need to close db server on docker)</li>
<li>how to build:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./startindesignenv.sh -c</span><br></pre></td></tr></table></figure>
sometimes it failed due to late version of project, checkout and pull the latest version.<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull          <span class="comment"># pull the update to local branch</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git rebase -i master  </span><br><span class="line"><span class="comment"># rebase multi local submits and get sync with new branch on master and local, conflicts may occur</span></span><br></pre></td></tr></table></figure>
if late-version conflicts occur, reset to last commit version, use <code>git rebase</code> to modify commit which is not pushed: <a href="https://cloud.tencent.com/developer/article/1335804">link</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">log</span>                   <span class="comment"># check commit history</span></span><br><span class="line">$ git reset &lt;commit id&gt;     <span class="comment"># reset to certain commit version</span></span><br></pre></td></tr></table></figure>
<p>If build failed, you should redo “add” and “commit” step after resetting.</p>
<blockquote>
<p>Tip: <code>git log</code> only show commit history of default remote branch (usually master). If remote has multiple branches in work, use <code>git log --all</code> to check full historical submits.</p>
</blockquote>
<p>Final Step：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push origin HEAD:refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure>
<p><em>Remember check Gerrit and add reviewers when work pushed. After the work is successfully built on cloud and get merged, add resolved mark and commit on JIRA task system.</em></p>
<hr>
<h1 id=""><a href="#" class="headerlink" title="."></a>.</h1><h4 id="amend-amp-reset"><a href="#amend-amp-reset" class="headerlink" title="amend &amp; reset:"></a>amend &amp; reset:</h4><p>if something wrong with codes was found in code review and have to add modifications, you should try to use <code>amend</code> to change the Last Commit</p>
<ol>
<li>to modify commit message:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit --amend</span><br></pre></td></tr></table></figure></li>
<li>to modify changed (already pushed) submit without abandon:<br>add modified local files, then do<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit --amend --no-edit</span><br></pre></td></tr></table></figure>
For more info about using amend :<br><a href="https://www.atlassian.com/git/tutorials/rewriting-history">Rewriting history</a><br><a href="https://www.jianshu.com/p/a8a2ac58f37d">git commit –amend用法(摘抄)</a></li>
</ol>
<p>If unfortunately failed to amend the commit, go back to last commited submit:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git reset --hard &lt;commit-id&gt;</span><br></pre></td></tr></table></figure>
<p>remember to pull down the latest version in this step, then resubmit the new changes.</p>
<hr>
<h1 id="-1"><a href="#-1" class="headerlink" title="."></a>.</h1><h4 id="branch-amp-merge"><a href="#branch-amp-merge" class="headerlink" title="branch &amp; merge:"></a>branch &amp; merge:</h4><p>Create a personal branch (excluded from master) locally:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch &lt;<span class="built_in">declare</span> a new branch name here&gt;   <span class="comment"># create</span></span><br><span class="line"><span class="comment"># e.g. git branch test-branch</span></span><br><span class="line">$ git branch                                    <span class="comment"># view all existing branches</span></span><br></pre></td></tr></table></figure>
<p>Switch to certain branch:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git checkout &lt;branch name&gt;</span><br></pre></td></tr></table></figure>
<p>push local commit to remote repository:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># when push current branch to remote</span></span><br><span class="line">$ git push origin test-branch</span><br><span class="line"><span class="comment"># when push another branch to remote repository</span></span><br><span class="line">$ git push origin &lt;local_branch_name&gt;:&lt;remote_branch_name&gt;</span><br></pre></td></tr></table></figure>
<p>pull master branch to current branch:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git merge master</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="-2"><a href="#-2" class="headerlink" title="."></a>.</h1><h4 id="git-add-not-work"><a href="#git-add-not-work" class="headerlink" title="git add not work"></a>git add not work</h4><p>Today I encountered with a problem that <code>git add .</code> did not work. <br>The reason might be that someone else is pushing his work to main repository throght branch master while I was also trying to add my work on same branch then.<br>The solution is simple, use:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A  <span class="comment"># equal to --all</span></span><br></pre></td></tr></table></figure>
<p>Cuz the work I was working on is changed to untracked status for forking reason.</p>
<hr>
<h1 id="-3"><a href="#-3" class="headerlink" title="."></a>.</h1><h4 id="git-crashed"><a href="#git-crashed" class="headerlink" title="git crashed"></a>git crashed</h4><p>起因：deploy自己的react练手项目到Heroku上时，因为react-script 3.3.0在webpack上不靠谱的脚本遇到websocket错误，在本地更改node_module里的脚本完，手贱把gitignore里的/node_module去掉后git add -A试图上传github, 放弃并cancel以后再打开git bash，把react-script downgrade到3.2.0再次提交时发现:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">fatal: Unable to create <span class="string">&#x27;.../.git/index.lock&#x27;</span>: File exists.</span><br><span class="line"></span><br><span class="line">Another git process seems to be running <span class="keyword">in</span> this repository, e.g.</span><br><span class="line">an editor opened by <span class="string">&#x27;git commit&#x27;</span>. Please make sure all processes</span><br><span class="line">are terminated <span class="keyword">then</span> try again. If it still fails, a git process</span><br><span class="line">may have crashed <span class="keyword">in</span> this repository earlier:</span><br><span class="line">remove the file manually to <span class="built_in">continue</span>.</span><br></pre></td></tr></table></figure>
<p>Solution: <br>Find the <code>.../.git/index.lock</code> file and delete it. Then reopen git bash.</p>
<hr>
<h1 id="-4"><a href="#-4" class="headerlink" title="."></a>.</h1><h4 id="re-login-after-changing-password"><a href="#re-login-after-changing-password" class="headerlink" title="re-login after changing password"></a>re-login after changing password</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  git config --global credential.helper wincred  <span class="comment"># for Windows, different from mac OS</span></span><br></pre></td></tr></table></figure>
<p>Then just use git cmd like <code>git pull</code>, credential confirm dialog will popup, enter the updated password.</p>
<hr>
<h1 id="-5"><a href="#-5" class="headerlink" title="."></a>.</h1><p>check remote branches:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -r</span><br></pre></td></tr></table></figure>
<p>Push to remote branch which is not master</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push origin HEAD:refs/<span class="keyword">for</span>/&lt;branch-name&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="-6"><a href="#-6" class="headerlink" title="."></a>.</h1><p>when there exist different branches, after download codes, first switch to target branch then pull, like:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MINGW64 ~/Desktop/bdc-test (master)</span><br><span class="line">$ git checkout 19q4_cp</span><br><span class="line">Switched to a new branch <span class="string">&#x27;19q4_cp&#x27;</span></span><br><span class="line">Branch <span class="string">&#x27;19q4_cp&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;19q4_cp&#x27;</span> from <span class="string">&#x27;origin</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MINGW64 ~/Desktop/bdc-test (19q4_cp) $ git pull origin 19q4_cp</span><br><span class="line">From https://gerrit.ericsson.se/a/EMBMS/bdc-test</span><br><span class="line">* branch              19q4_cp    -&gt; FETCH_HEAD</span><br><span class="line">Already up to date.</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="-7"><a href="#-7" class="headerlink" title="."></a>.</h1><p>save temporarily work:<br>can skip these steps:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git stash           <span class="comment"># save work with the latest commit title (current modifications)</span></span><br><span class="line">$ git stash save <span class="string">&quot;note&quot;</span> <span class="comment"># save work with title &quot;note&quot;</span></span><br><span class="line">$ git stash list      <span class="comment"># check to see saved work list</span></span><br><span class="line">$ git stash apply 0   <span class="comment"># apply work-id to restore the work to tmp branch</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/zndxall/archive/2018/09/04/9586088.html">git stash 用法总结和注意点</a></p>
<hr>
<h1 id="-8"><a href="#-8" class="headerlink" title="."></a>.</h1><p>Git search with format:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --pretty=format:<span class="string">&#x27;%C(yellow)%h %Cred%ad %Cblue%an%Cgreen%d %Creset%s&#x27;</span> --date=short</span><br></pre></td></tr></table></figure>
<p>with defined author, add <code>--author=&quot;auth_name&quot;</code><br>for given tag, add <code>--tags=&quot;given_tag&quot;</code></p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>git</tag>
        <tag>cmd</tag>
      </tags>
  </entry>
  <entry>
    <title>docker CMD for daily use</title>
    <url>/2020/01/20/docker/</url>
    <content><![CDATA[<h3 id="images"><a href="#images" class="headerlink" title="images"></a>images</h3><ol>
<li>Display images on current server:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure></li>
<li>rename image:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">oldName              latest              d583c3ac45fd        26 minutes ago      685.5 MB</span><br><span class="line">######## change to ########</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">newName            latest              d583c3ac45fd       26 minutes ago         685.5 MB</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker image tag oldName:latest newName:latest</span><br><span class="line">or</span><br><span class="line">$ docker image tag d583c3ac45fd newName:latest</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice: this operation is equal to “copy” + “rename”, thus there will be two repositories “oldName” and “newName” after change. If you want to remove “oldName”, use <code>docker rmi oldName</code>.</p>
</blockquote>
</li>
</ol>
<center><a id="more"></a></center>

<hr>
<h3 id="docker-load-import"><a href="#docker-load-import" class="headerlink" title="docker load / import"></a>docker load / import</h3><ol>
<li><code>docker load</code> can load images which is released via <code>docker save</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker load -i &lt;package&gt;(tar/tar.gz)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>docker import</code> imports some packages that is released via <code>docker export</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker import &lt;package&gt; &lt;repository-name:tag-version&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>note: there might be &lt;none&gt; repository name and &lt;none&gt; TAG after import, this is because we did not commit its name when importing. we can rename it after it is imported.</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<hr>
<h3 id="check-build-logs"><a href="#check-build-logs" class="headerlink" title="check build logs"></a>check build logs</h3><ol>
<li>get container id<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps -a  <span class="comment"># list all docker images, get container id here</span></span><br></pre></td></tr></table></figure></li>
<li>get logs for certain container<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs &lt;container-id&gt;</span><br></pre></td></tr></table></figure>
set time limit (get latest 30 mins logs)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs --since 30m &lt;container-id&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="docker-save-existed-image"><a href="#docker-save-existed-image" class="headerlink" title="docker save existed image"></a>docker save existed image</h3><p>for some cases you might want to save local images and reload on another host server. Here I use <code>tiller</code> as an example.</p>
<ol>
<li>get image id<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  docker images |grep tiller</span><br><span class="line">or</span><br><span class="line">$ docker images|findstr tiller</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/tiller       v2.16.4               7eece2e1da99        2 days ago          89.1MB</span><br><span class="line">gcr.io/kubernetes-helm/tiller                                    v2.14.3               2d0a693df3ba        7 months ago        94.2MB</span><br></pre></td></tr></table></figure></li>
<li>save target image to local tar.gz<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker save 7eece2e1da99 &gt; tiller.tar.gz</span><br></pre></td></tr></table></figure>
now you can find the <code>tiller.tar.gz</code> under current folder, use <code>docker load -i &lt;pack&gt;</code> for reload on other server.</li>
</ol>
<hr>
<h3 id="image-is-being-used-by-running-container-xxxxxxxx"><a href="#image-is-being-used-by-running-container-xxxxxxxx" class="headerlink" title="image is being used by running container xxxxxxxx"></a>image is being used by running container xxxxxxxx</h3><p>follow the error messages, do <code>docker stop &lt;container-id&gt;</code>, then delete the container by <code>docker rm &lt;container-id&gt;</code>, finally do <code>docker rmi &lt;image-id&gt;</code></p>
<hr>
<h3 id="delete-images-containers-in-batches"><a href="#delete-images-containers-in-batches" class="headerlink" title="delete images/containers in batches"></a>delete images/containers in batches</h3><p>delete images named <none></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker images | grep <span class="string">&#x27;&lt;none&gt;&#x27;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | xargs docker rmi</span><br></pre></td></tr></table></figure>
<p>delete all stopped containers</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps -a | grep <span class="string">&#x27;Exited&#x27;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs docker stop | xargs docker rm</span><br></pre></td></tr></table></figure>
<h3 id="run-a-container-from-image"><a href="#run-a-container-from-image" class="headerlink" title="run a container from image"></a>run a container from image</h3><p>docker run [OPTIONS] IMAGE [COMMAND] [ARG…] <br>sample:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -itd --name &lt;container-name&gt; -p 8091:8091 -v &lt;volume-path&gt; &lt;image-id or name&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>cmd</tag>
      </tags>
  </entry>
  <entry>
    <title>JS getter</title>
    <url>/2020/01/08/js-getter/</url>
    <content><![CDATA[<p>Encountered with the following function as below:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">get</span> <span class="title">userFilter</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        dataset1: &#123;</span><br><span class="line">            value: <span class="string">&#x27;...&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        dataset2: &#123;</span><br><span class="line">            value: <span class="string">&#x27;...&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>so question comes up: <a href="https://stackoverflow.com/questions/42884751/whats-the-meaning-of-static-get-in-javascript-es6">Whats the meaning of ‘static get’ in Javascript (ES6)?</a></p>
<center><a id="more"></a></center>

<p>According to the above answer,</p>
<ul>
<li><p><code>static</code> defines that this function inside class is static, which means you cannot call the func via the instance of the class</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// e.g.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">get</span> <span class="title">CIRCLE</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">get</span> <span class="title">SQUARE</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// you call this as a property directly</span></span><br><span class="line">Agent.CIRCLE; <span class="comment">// 1</span></span><br><span class="line"><span class="comment">// but call by an instance is not allowed</span></span><br><span class="line"><span class="keyword">const</span> newAgent = <span class="keyword">new</span> Agent();</span><br><span class="line"><span class="built_in">console</span>.log(newAgent.CIRCLE); <span class="comment">// undefined or TypeError: foo.classMethod is not a function</span></span><br></pre></td></tr></table></figure>
<p>Lookup: <a href="https://developer.mozilla.org/en-US/docs/Glossary/Static_method">Static method</a> | <a href="http://es6.ruanyifeng.com/?search=get&x=0&y=0#docs/class#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">Class的基本语法 2.静态方法</a></p>
</li>
<li><p><code>get</code> syntax binds an object property to a function that will be called when is property is looked up</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// e.g.</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  log: [<span class="string">&#x27;example&#x27;</span>,<span class="string">&#x27;test&#x27;</span>],</span><br><span class="line">  <span class="keyword">get</span> <span class="title">latest</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.log.length === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.log[<span class="built_in">this</span>.log.length - <span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obj.latest); <span class="comment">// &quot;test&quot;.</span></span><br></pre></td></tr></table></figure>
<p>Note: the above code will create a pseudo-property <code>latest</code> for object <code>obj</code>, which will return the last array item in <code>log</code>, but the attempt to assign a value to <code>latest</code> will not change it. <br>For more details, see <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">MDN&gt;JavaScript reference&gt;Functions&gt;getter</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Frontend Interview</title>
    <url>/2021/03/29/frontend-interview/</url>
    <content><![CDATA[<p>This article is created for recording problems encountered in my interview.</p>
<h3 id="什么是IIFE（立即调用函数表达式）"><a href="#什么是IIFE（立即调用函数表达式）" class="headerlink" title="什么是IIFE（立即调用函数表达式）"></a>什么是IIFE（立即调用函数表达式）</h3><p>它是立即调用函数表达式（Immediately-Invoked Function Expression），简称 IIFE。函数被创建后立即被执行：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">IIFE</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="built_in">console</span>.log( <span class="string">&quot;Hello!&quot;</span> );</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">// &quot;Hello!&quot;</span></span><br></pre></td></tr></table></figure>
<p>在避免污染全局命名空间时经常使用这种模式，因为 IIFE（与任何其他正常函数一样）内部的所有变量在其作用域之外都是不可见的。  </p>
<p>ref: <a href="https://www.jianshu.com/p/d4d2eb4be216">https://www.jianshu.com/p/d4d2eb4be216</a></p>
<center><a id="more"></a></center>

<h3 id="闭包是什么？举个例子"><a href="#闭包是什么？举个例子" class="headerlink" title="闭包是什么？举个例子"></a>闭包是什么？举个例子</h3><p>闭包是在另一个函数（称为父函数）中定义的函数，并且可以访问在父函数作用域中声明和定义的变量。<br>闭包可以访问三个作用域中的变量:<br>1) 在自己作用域中声明的变量<br>2) 在父函数中声明的变量<br>3) 在全局作用域中声明的变量<br>闭包就是函数的局部变量集合，只是<strong>这些局部变量在函数返回后会继续存在</strong>。闭包就是就是函数的“堆栈”在<strong>函数返回后并不释放</strong>，我们也可以理解为这些函数堆栈并不在栈上分配而是在堆上分配。<strong>当在一个函数内定义另外一个函数就会产生闭包</strong>。</p>
<blockquote>
<p>为什么要用闭包？</p>
<ul>
<li>匿名自执行函数：我们知道所有的变量，如果不加上var关键字，则默认的会添加到全局对象的属性上去，这样的临时变量加入全局对象有很多坏处，比如：别的函数可能误用这些变量；造成全局对象过于庞大，影响访问速度(因为变量的取值是需要从原型链上遍历的)。除了每次使用变量都是用var关键字外，我们在实际情况下经常遇到这样一种情况，即有的函数只需要执行一次，其内部变量无需维护，可以用闭包。</li>
<li>结果缓存：我们开发中会碰到很多情况，设想我们有一个处理过程很耗时的函数对象，每次调用都会花费很长时间，那么我们就需要将计算出来的值存储起来，当调用这个函数的时候，首先在缓存中查找，如果找不到，则进行计算，然后更新缓存并返回值，如果找到了，直接返回查找到的值即可。闭包正是可以做到这一点，因为它不会释放外部的引用，从而函数内部的值可以得以保留。</li>
</ul>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> globalVar = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="comment">// 自调用函数</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">outerFunction</span> (<span class="params">outerArg</span>) </span>&#123; <span class="comment">// outerFunction 作用域开始</span></span><br><span class="line"> <span class="comment">// 在 outerFunction 函数作用域中声明的变量</span></span><br><span class="line"> <span class="keyword">var</span> outerFuncVar = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line"> <span class="comment">// 闭包自调用函数</span></span><br><span class="line"> (<span class="function"><span class="keyword">function</span> <span class="title">innerFunction</span> (<span class="params">innerArg</span>) </span>&#123; <span class="comment">// innerFunction 作用域开始</span></span><br><span class="line"> <span class="comment">// 在 innerFunction 函数作用域中声明的变量</span></span><br><span class="line"> <span class="keyword">var</span> innerFuncVar = <span class="string">&quot;y&quot;</span>;</span><br><span class="line"> <span class="built_in">console</span>.log(</span><br><span class="line"> <span class="string">&quot;outerArg = &quot;</span> + outerArg + <span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"> <span class="string">&quot;outerFuncVar = &quot;</span> + outerFuncVar + <span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"> <span class="string">&quot;innerArg = &quot;</span> + innerArg + <span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"> <span class="string">&quot;innerFuncVar = &quot;</span> + innerFuncVar + <span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"> <span class="string">&quot;globalVar = &quot;</span> + globalVar);</span><br><span class="line"> <span class="comment">// innerFunction 作用域结束</span></span><br><span class="line"> &#125;)(<span class="number">5</span>); <span class="comment">// 将 5 作为参数</span></span><br><span class="line"><span class="comment">// outerFunction 作用域结束</span></span><br><span class="line">&#125;)(<span class="number">7</span>); <span class="comment">// 将 7 作为参数</span></span><br></pre></td></tr></table></figure>
<p>innerFunction 是在 outerFunction 中定义的闭包，可以访问在 outerFunction 作用域内声明和定义的所有变量。除此之外，闭包还可以访问在全局命名空间中声明的变量。<br>上述代码的输出将是:  </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">outerArg = <span class="number">7</span></span><br><span class="line">outerFuncVar = x</span><br><span class="line">innerArg = <span class="number">5</span></span><br><span class="line">innerFuncVar = y</span><br><span class="line">globalVar = abc</span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://www.jianshu.com/p/d4d2eb4be216">https://www.jianshu.com/p/d4d2eb4be216</a></p>
<blockquote>
<p>已知两个funcion A &amp; B，如何实现先调用一次A，往后全部调用B</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 用闭包模拟私有方法</span></span><br><span class="line"><span class="comment">// 此方法可避免非核心的方法弄乱代码的公共接口部分</span></span><br><span class="line"><span class="keyword">let</span> t = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> A = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;A&quot;</span>, time);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> B = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;B&quot;</span>, time);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        time++;</span><br><span class="line">        <span class="keyword">if</span> (time === <span class="number">1</span>) &#123;</span><br><span class="line">            A();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            B();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;();          <span class="comment">// this is closure</span></span><br><span class="line"><span class="keyword">let</span> test = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">while</span>(test &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    t();</span><br><span class="line">    test--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// A 1</span></span><br><span class="line"><span class="comment">// B 2</span></span><br><span class="line"><span class="comment">// B 3</span></span><br><span class="line"><span class="comment">// B 4</span></span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures</a></p>
<h3 id="mock-data"><a href="#mock-data" class="headerlink" title="mock data"></a>mock data</h3><p>适用于后端没有给出测试阶段的假接口和模拟数据情况<br>1) 直接在页面写死数据，后期等接口来了，再改成动态的; 哈哈哈这是最简单的，也是最笨的，所以小型的项目，不出5个页面的可以解决，或是每个页面的数据很少的可以解决，但是不推荐，后期太麻烦<br>2) 在js里直接声明变量，并给变量赋值，在逻辑脚本中使用，并渲染到dom<br>3) 将模拟数据编辑成json数据或者是零碎的js脚本中，通过请求，取回数据，并进行业务逻辑处理，渲染到dom<br>4) 最理想的方式:</p>
<ul>
<li>前后台在需求分解之后，一起定义好接口api，包含：请求url（项目前缀+具体的接口名称）、请求方式、请求参数、数据响应</li>
<li>前端研发人员根据接口约定，模拟请求返回对应的数据，完成对应的交互</li>
<li>后台人员根据接口约定，完成对应的api，并完成对应的自测</li>
<li>待后台人员交付接口api后，前端人员直接修改接口项目前缀，切换到对应的环境，即可进入项目提测</li>
</ul>
<p>ref: <a href="https://zhuanlan.zhihu.com/p/77199413">https://zhuanlan.zhihu.com/p/77199413</a></p>
<h3 id="数组去重"><a href="#数组去重" class="headerlink" title="数组去重"></a>数组去重</h3><ol>
<li>indexOf循环去重</li>
<li>ES6 Set去重；Array.from(new Set(array))</li>
<li>Object 键值对去重；把数组的值存成 Object 的 key 值，比如 Object[value1] = true，在判断另一个值的时候，如果 Object[value2]存在的话，就说明该值是重复的。</li>
</ol>
<h3 id="JS实现跨域"><a href="#JS实现跨域" class="headerlink" title="JS实现跨域"></a>JS实现跨域</h3><ol>
<li>JSONP：通过动态创建script，再请求一个带参网址实现跨域通信。document.domain + iframe跨域：两个页面都通过js强制设置document.domain为基础主域，就实现了同域。</li>
<li>location.hash + iframe跨域：a欲与b跨域相互通信，通过中间页c来实现。 三个页面，不同域之间利用iframe的location.hash传值，相同域之间直接js访问来通信。</li>
<li>window.name + iframe跨域：通过iframe的src属性由外域转向本地域，跨域数据即由iframe的window.name从外域传递到本地域。</li>
<li>postMessage跨域：可以跨域操作的window属性之一。</li>
<li>CORS：服务端设置Access-Control-Allow-Origin即可，前端无须设置，若要带cookie请求，前后端都需要设置。</li>
<li>代理跨域：启一个代理服务器，实现数据的转发</li>
</ol>
<p>ref: <a href="https://segmentfault.com/a/1190000011145364">https://segmentfault.com/a/1190000011145364</a></p>
<h3 id="通过nginx反向代理解决前端访问的跨域问题"><a href="#通过nginx反向代理解决前端访问的跨域问题" class="headerlink" title="通过nginx反向代理解决前端访问的跨域问题"></a>通过nginx反向代理解决前端访问的跨域问题</h3><p>ref: <a href="https://www.ucloud.cn/yun/97273.html">https://www.ucloud.cn/yun/97273.html</a></p>
<h3 id="js页面性能优化"><a href="#js页面性能优化" class="headerlink" title="js页面性能优化"></a>js页面性能优化</h3><ul>
<li>减少HTTP请求</li>
<li>使用内容发布网络（CDN）</li>
<li>添加本地缓存</li>
<li>压缩资源文件</li>
<li>将CSS样式表放在顶部，把javascript放在底部（浏览器的运行机制决定）</li>
<li>避免使用CSS表达式</li>
<li>减少DNS查询</li>
<li>使用外部javascript和CSS</li>
<li>避免重定向</li>
<li>图片lazyLoad</li>
</ul>
<h3 id="防抖节流"><a href="#防抖节流" class="headerlink" title="防抖节流"></a>防抖节流</h3><h3 id="CSS-flex"><a href="#CSS-flex" class="headerlink" title="CSS flex"></a>CSS flex</h3><p><a href="http://www.ruanyifeng.com/blog/2015/07/flex-examples.html">http://www.ruanyifeng.com/blog/2015/07/flex-examples.html</a></p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>frontend</tag>
        <tag>interview</tag>
      </tags>
  </entry>
  <entry>
    <title>Skip html labels in JS</title>
    <url>/2020/07/27/js-skip-html-label/</url>
    <content><![CDATA[<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">str = str.replace(<span class="regexp">/&lt;[^&lt;&gt;]+&gt;/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>sample:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> error = <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Error&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Unauthorized&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">error = error.replace(<span class="regexp">/&lt;[^&lt;&gt;]+&gt;/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(error);</span><br><span class="line"><span class="comment">// print ErrorUnauthorized</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Sonar Fix (Java backend)</title>
    <url>/2020/09/07/java-sonar/</url>
    <content><![CDATA[<p>This is a record for sonar fixing for backend based on Java.</p>
<h3 id="CERT-issues"><a href="#CERT-issues" class="headerlink" title="CERT issues"></a>CERT issues</h3><h4 id="Extract-this-increment-or-decrement-operator-into-a-dedicated-statement"><a href="#Extract-this-increment-or-decrement-operator-into-a-dedicated-statement" class="headerlink" title="Extract this increment or decrement operator into a dedicated statement."></a>Extract this increment or decrement operator into a dedicated statement.</h4><p><strong>Rule: Increment (++) and decrement (–) operators should not be used in a method call or mixed with other operators in an expression</strong></p>
<h5 id="1-original-code"><a href="#1-original-code" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">u8a = ++u8b + u8c--;</span><br><span class="line">foo = bar++ / <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<h5 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">++u8b;</span><br><span class="line">u8a = u8b + u8c;</span><br><span class="line">u8c--;</span><br><span class="line">foo = bar / <span class="number">4</span>;</span><br><span class="line">bar++;</span><br></pre></td></tr></table></figure>
<h5 id="2-original-code"><a href="#2-original-code" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (++searchCounter &gt; portRange) &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-1"><a href="#solution-1" class="headerlink" title="solution"></a>solution</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">++searchCounter;</span><br><span class="line"><span class="keyword">if</span> (searchCounter &gt; portRange) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-original-code"><a href="#3-original-code" class="headerlink" title="3. original code:"></a>3. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> retry = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (retry++ &lt; RETRY_NUM &amp;&amp; ..) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-2"><a href="#solution-2" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> retry = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (retry &lt; RETRY_NUM + <span class="number">1</span> &amp;&amp; ..) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  retry++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-original-code"><a href="#4-original-code" class="headerlink" title="4. original code:"></a>4. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((++cnt &lt;= num) &amp;&amp; (...)) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-3"><a href="#solution-3" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> cnt = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ((cnt &lt;= num) &amp;&amp; (...)) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  cnt++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Specify-an-appropriate-locale-when-comparing-locale-dependent-data"><a href="#Specify-an-appropriate-locale-when-comparing-locale-dependent-data" class="headerlink" title="Specify an appropriate locale when comparing locale-dependent data."></a>Specify an appropriate locale when comparing locale-dependent data.</h4><h5 id="2-original-code-1"><a href="#2-original-code-1" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String password = user.getPassword().toLowerCase();</span><br></pre></td></tr></table></figure>
<h5 id="solution-4"><a href="#solution-4" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String password = user.getPassword().toLowerCase(Locale.getDefault());</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Classes-and-methods-that-rely-on-the-default-system-encoding-should-not-be-used"><a href="#Classes-and-methods-that-rely-on-the-default-system-encoding-should-not-be-used" class="headerlink" title="Classes and methods that rely on the default system encoding should not be used"></a>Classes and methods that rely on the default system encoding should not be used</h4><p><strong>Rule: 1. Remove this use of “toString”. 2. Remove this use of constructor “FileWriter(File,boolean)”. etc</strong></p>
<h5 id="1-original-code-1"><a href="#1-original-code-1" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"></span><br><span class="line">BufferedWriter csvFileBufferWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(csvFile, <span class="keyword">true</span>))</span><br></pre></td></tr></table></figure>
<h5 id="solution-5"><a href="#solution-5" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line">BufferedWriter csvFileBufferWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(csvFile, <span class="keyword">true</span>), Charset.defaultCharset()))</span><br></pre></td></tr></table></figure>
<p>This solution came out with new sonar issue <a href="https://sonarqube.lmera.ericsson.se/coding_rules?open=fb-contrib%3AIOI_USE_OF_FILE_STREAM_CONSTRUCTORS&amp;rule_key=fb-contrib%3AIOI_USE_OF_FILE_STREAM_CONSTRUCTORS">https://sonarqube.lmera.ericsson.se/coding_rules?open=fb-contrib%3AIOI_USE_OF_FILE_STREAM_CONSTRUCTORS&amp;rule_key=fb-contrib%3AIOI_USE_OF_FILE_STREAM_CONSTRUCTORS</a> <br>2nd modification:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line">BufferedWriter csvFileBufferWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(Files.newOutputStream(csvFile.toPath()), Charset.defaultCharset()))</span><br></pre></td></tr></table></figure>
<p>another case:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(saiFileLocation);</span><br><span class="line">FileInputStream reader = <span class="keyword">new</span> FileInputStream(file);</span><br></pre></td></tr></table></figure>
<p>change to</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InputStream reader = Files.newInputStream(Paths.get(saiFileLocation));</span><br></pre></td></tr></table></figure>
<h5 id="2-original-code-2"><a href="#2-original-code-2" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (JAXBException e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bos.toString();</span><br></pre></td></tr></table></figure>
<h5 id="solution-6"><a href="#solution-6" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> bos.toString(Charset.defaultCharset().name());</span><br><span class="line">&#125; <span class="keyword">catch</span> (JAXBException | UnsupportedEncodingException e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-original-code-1"><a href="#3-original-code-1" class="headerlink" title="3. original code:"></a>3. original code:</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> (FileReader fileReader = <span class="keyword">new</span> FileReader(fileName)) &#123;</span><br><span class="line">  List&lt;..&gt; list = unmarshal2List(fileReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-7"><a href="#solution-7" class="headerlink" title="solution"></a>solution</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> (FileInputStream fileReader = <span class="keyword">new</span> FileInputStream(fileName)) &#123;</span><br><span class="line">  List&lt;..&gt; list = unmarshal2List(<span class="keyword">new</span> InputStreamReader(fileReader, Charset.defaultCharset()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>sonar</tag>
      </tags>
  </entry>
  <entry>
    <title>Sonar Fix (node.js backend)</title>
    <url>/2020/07/17/js-sonar/</url>
    <content><![CDATA[<p>This is a record for sonar fixing for backend based on node.js.</p>
<h3 id="Security-Hotspots"><a href="#Security-Hotspots" class="headerlink" title="Security Hotspots"></a>Security Hotspots</h3><p><em>Security Hotspots aren’t necessarily issues, but they need to be reviewed to make sure they aren’t vulnerabilities.</em></p>
<h4 id="Make-sure-that-using-a-regular-expression-is-safe-here"><a href="#Make-sure-that-using-a-regular-expression-is-safe-here" class="headerlink" title="Make sure that using a regular expression is safe here"></a>Make sure that using a regular expression is safe here</h4><p><strong>Rule: Using regular expressions is security-sensitive</strong></p>
<h5 id="1-original-code"><a href="#1-original-code" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> re = <span class="regexp">/^\d+(\.\d+)?$/</span>;</span><br></pre></td></tr></table></figure>
<p>the rule recommend not using group<code>()</code> to reduce evaluate work load. 个人理解是，group内外都有\d+，可能有重复校验的问题</p>
 <center><a id="more"></a></center>

<h5 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h5><p>Tried several regex but all failed, used brute force algo and solved.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">parseFloatStrict</span>(<span class="params">str</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str.includes(<span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> splitedStr = str.split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (splitedStr.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.parseIntStrict(splitedStr[<span class="number">0</span>]) || !<span class="built_in">this</span>.parseIntStrict(splitedStr[<span class="number">1</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parseFloat</span>(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.parseIntStrict(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-original-code"><a href="#2-original-code" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> reg = <span class="regexp">/^.*(?=.&#123;8,20&#125;)(?=.*\d)(?=.*[A-Z])(?=.*[a-z])(?=.*[-!@#$%^&amp;*?_.]).*$/</span>;</span><br></pre></td></tr></table></figure>
<h5 id="solution-1"><a href="#solution-1" class="headerlink" title="solution"></a>solution</h5><p>//NOSONAR</p>
<h5 id="3-original-code"><a href="#3-original-code" class="headerlink" title="3. original code:"></a>3. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!body.name || !<span class="regexp">/(\w+)&#123;6,16&#125;$/</span>.test(body.name))&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-2"><a href="#solution-2" class="headerlink" title="solution"></a>solution</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!body.name || !<span class="regexp">/^\w&#123;6,16&#125;$/</span>.test(body.name))</span><br></pre></td></tr></table></figure>
<h5 id="4-original-code"><a href="#4-original-code" class="headerlink" title="4. original code:"></a>4. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/\/login.*/</span>.test(req.path) || <span class="regexp">/.*login\/*/</span>.test(req.headers.referer) || req.path.startsWith(<span class="string">&quot;/api/&quot;</span>) || req.path === <span class="string">&quot;/&quot;</span>) &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="solution-3"><a href="#solution-3" class="headerlink" title="solution"></a>solution</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (... || <span class="regexp">/\/login.*/</span>.test(req.headers.referer) || ...)</span><br></pre></td></tr></table></figure>
<h5 id="5-original-code"><a href="#5-original-code" class="headerlink" title="5. original code:"></a>5. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> pattern1 = <span class="regexp">/SubNetwork=.*?MeContext=.*?ManagedElement=.*?MceFunction=.*?TermPointToMmeM3=[\s\S]*?TermPointToMmeM3Id[\s\S]*?ipAddress[\s\S]*?ipv6Address2.*/g</span>;</span><br></pre></td></tr></table></figure>
<h5 id="solution-4"><a href="#solution-4" class="headerlink" title="solution"></a>solution</h5><p>//NOSONAR</p>
<hr>
<h4 id="Make-sure-that-executing-SQL-queries-is-safe-here"><a href="#Make-sure-that-executing-SQL-queries-is-safe-here" class="headerlink" title="Make sure that executing SQL queries is safe here."></a>Make sure that executing SQL queries is safe here.</h4><p><strong>Rule: Formatting SQL queries is security-sensitive</strong></p>
<h5 id="1-original-code-1"><a href="#1-original-code-1" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = sequelize.query(<span class="string">`<span class="subst">$&#123;sql&#125;</span>`</span>, &#123;<span class="attr">type</span>: sequelize.QueryTypes.SELECT&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="solution-5"><a href="#solution-5" class="headerlink" title="solution"></a>solution</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = sequelize.query(sql, &#123;<span class="attr">type</span>: sequelize.QueryTypes.SELECT&#125;);</span><br></pre></td></tr></table></figure>
<p>  <em>Note: not a good solution, just exploited loopholes. cuz This rule’s current implementation does not follow variables. It will only detect SQL queries which are formatted directly in the function call.</em></p>
<hr>
<h4 id="Review-this-potentially-hardcoded-credential"><a href="#Review-this-potentially-hardcoded-credential" class="headerlink" title="Review this potentially hardcoded credential."></a>Review this potentially hardcoded credential.</h4><p><strong>Rule: Hard-coded credentials are security-sensitive</strong></p>
<h5 id="1-original-code-2"><a href="#1-original-code-2" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> initUser = [</span><br><span class="line">    &#123;</span><br><span class="line">        userId: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">        password: <span class="string">&quot;8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918&quot;</span>,</span><br><span class="line">        roles: <span class="string">&quot;Admin&quot;</span>,</span><br><span class="line">        userExpiryDate: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>),</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">await</span> Users.bulkCreate(initUser);</span><br><span class="line">password: <span class="string">&quot;8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918&quot;</span>,</span><br></pre></td></tr></table></figure>
<h5 id="solution-6"><a href="#solution-6" class="headerlink" title="solution"></a>solution</h5><p>//NOSONAR</p>
<p>This solution failed, TBD.</p>
<h5 id="2-original-code-1"><a href="#2-original-code-1" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">data.value.password = <span class="string">&quot;********&quot;</span>;</span><br></pre></td></tr></table></figure>
<h5 id="solution-7"><a href="#solution-7" class="headerlink" title="solution"></a>solution</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">data.value.password = Setting.getDisplayPassword();</span><br><span class="line">getDisplayPassword: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;********&quot;</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Make-sure-that-hashing-data-is-safe-here"><a href="#Make-sure-that-hashing-data-is-safe-here" class="headerlink" title="Make sure that hashing data is safe here."></a>Make sure that hashing data is safe here.</h4><p><strong>Rule: Hashing data is security-sensitive</strong></p>
<h5 id="1-original-code-3"><a href="#1-original-code-3" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> encryptedPass = crypto.createHash(<span class="string">&#x27;sha256&#x27;</span>).update(newBDC.ncmPassword, <span class="string">&#x27;utf8&#x27;</span>).digest(<span class="string">&#x27;hex&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h5 id="solution-8"><a href="#solution-8" class="headerlink" title="solution"></a>solution</h5><p>The issue recommend with</p>
<blockquote>
<p>use a hashing algorithm that generate its own salts as part of the hashing. If you generate your own salts, make sure that a cryptographically strong salt algorithm is used, that generated salts are credential-specific, and finally, that the salt is applied correctly before the hashing.</p>
</blockquote>
<blockquote>
<p>save both the salt and the hashed value in the relevant database record; during future validation operations, the salt and hash can then be retrieved from the database. The hash is recalculated with the stored salt and the value being validated, and the result compared to the stored hash.</p>
</blockquote>
<p>Further effort TBD.</p>
<hr>
<hr>
<h3 id="MITRE-CWE-563-Assignment-to-Variable-without-Use-‘Unused-Variable’"><a href="#MITRE-CWE-563-Assignment-to-Variable-without-Use-‘Unused-Variable’" class="headerlink" title="MITRE, CWE-563 - Assignment to Variable without Use (‘Unused Variable’)"></a>MITRE, CWE-563 - Assignment to Variable without Use (‘Unused Variable’)</h3><h4 id="Remove-this-useless-assignment-to-variable-“xxx”"><a href="#Remove-this-useless-assignment-to-variable-“xxx”" class="headerlink" title="Remove this useless assignment to variable “xxx”."></a>Remove this useless assignment to variable “xxx”.</h4><p><strong>Rule: Unused assignments should be removed</strong></p>
<h5 id="1-original-code-4"><a href="#1-original-code-4" class="headerlink" title="1. original code:"></a>1. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> res = <span class="keyword">await</span> client.connect();</span><br><span class="line">res = <span class="keyword">await</span> client.query(checkUserSQL);</span><br></pre></td></tr></table></figure>
<p>Some explains here for this issue: <a href="https://stackoverflow.com/questions/42151535/use-of-unassigned-local-variable-when-using-a-foreach-loop">https://stackoverflow.com/questions/42151535/use-of-unassigned-local-variable-when-using-a-foreach-loop</a></p>
<h5 id="solution-9"><a href="#solution-9" class="headerlink" title="solution"></a>solution</h5><p><code>client.connect()</code> returns a promise, when succeed it returns none, if fail return a error or none:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">connect(): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt;;</span><br><span class="line">connect(callback: <span class="function">(<span class="params">err: <span class="built_in">Error</span></span>) =&gt;</span> <span class="keyword">void</span>): <span class="keyword">void</span>;</span><br></pre></td></tr></table></figure>
<p>so just remove the <code>res</code> part:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> client.connect();</span><br></pre></td></tr></table></figure>
<h5 id="2-original-code-2"><a href="#2-original-code-2" class="headerlink" title="2. original code:"></a>2. original code:</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> res = -<span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (opts &amp;&amp; opts.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  res = <span class="keyword">await</span> ServerMoUtils.generateCreateAreaMO(postData, opts, profiles);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (opts &amp;&amp; opts.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  res = <span class="keyword">await</span> ServerMoUtils.generateDeleteAreaMO(postData, opts);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (opts) &#123;</span><br><span class="line">  res = <span class="keyword">await</span> ServerMoUtils.generateUpdateAreaMO(postData, opts, profiles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>check the function:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">generateCreateAreaMO</span>(<span class="params">postData, opts, profiles</span>)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  opts.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">opt</span>)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As the related function used <code>forEach</code>, so <code>await</code> is a must, but found no use with <code>return 0</code>.</p>
<h5 id="solution-10"><a href="#solution-10" class="headerlink" title="solution"></a>solution</h5><p>remove <code>return 0</code> for all three funcs, and also remove <code>res =</code> for each.</p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>sonar</tag>
        <tag>nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>Mini-program project demo for starter</title>
    <url>/2020/01/07/mini-program/</url>
    <content><![CDATA[<h3 id="demo-program"><a href="#demo-program" class="headerlink" title="demo program"></a>demo program</h3><ol>
<li><p>我要圣诞帽<br><a href="https://github.com/jasscia/ChristmasHat">https://github.com/jasscia/ChristmasHat</a> <br>图片编辑，存图</p>
</li>
<li><p>掌故<br><a href="https://github.com/Gesangs/PhoneStory">https://github.com/Gesangs/PhoneStory</a> <br>新闻推送</p>
</li>
<li><p>简约睡眠Music<br><a href="https://github.com/shajinyang/BeautyAudio">https://github.com/shajinyang/BeautyAudio</a> <br>音乐播放器</p>
</li>
<li><p>运势小程序<br><a href="https://github.com/panyefan/wxfortune">https://github.com/panyefan/wxfortune</a> <br>测运势，存图</p>
</li>
<li><p>跑马灯，左侧菜单，抽屉层，加载动画<br><a href="https://github.com/youzouzou/wxapp">https://github.com/youzouzou/wxapp</a> <br>小程序组件合集</p>
<center><a id="more"></a></center>
</li>
<li><p>订单管理，浮层菜单，页面设计<br><a href="https://github.com/GavinCarter1991/wx-onePro">https://github.com/GavinCarter1991/wx-onePro</a> <br>内部平台，商户端界面</p>
</li>
<li><p>电商模板，购物车模板<br><a href="https://github.com/fangliu520/wxbestcake">https://github.com/fangliu520/wxbestcake</a></p>
</li>
<li><p>摇一摇，二维码<br>《微信小程序入门与实践》一书的小程序源代码<br>前端： <a href="https://github.com/7insummer/orange-can">https://github.com/7insummer/orange-can</a> <br>后端： <a href="https://github.com/7insummer/orange-can-server">https://github.com/7insummer/orange-can-server</a></p>
</li>
<li><p>仿微信运动步数排行<br><a href="https://www.jianshu.com/p/bb7131114993">https://www.jianshu.com/p/bb7131114993</a></p>
</li>
</ol>
<p><em>Note. 以上代码都有两年左右年份，仅供入门学习参考</em><br>ref: <a href="https://www.jianshu.com/p/0e471853a548">https://www.jianshu.com/p/0e471853a548</a></p>
<h3 id="UI-Lab"><a href="#UI-Lab" class="headerlink" title="UI Lab"></a>UI Lab</h3><ol>
<li>iView<br><a href="https://github.com/TalkingData/iview-weapp">https://github.com/TalkingData/iview-weapp</a> <br>教程：<a href="https://www.jianshu.com/p/09b4515152ff">https://www.jianshu.com/p/09b4515152ff</a></li>
</ol>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>mini-program</tag>
        <tag>resource</tag>
      </tags>
  </entry>
  <entry>
    <title>NPM tips</title>
    <url>/2020/07/20/npm/</url>
    <content><![CDATA[<h3 id="npm-install"><a href="#npm-install" class="headerlink" title="npm install"></a>npm install</h3><p>different with <code>^</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install express@^4.16.1 --save --save-exact</span><br><span class="line">+ express@4.17.1</span><br><span class="line">removed 3 packages, updated 1 package and moved 1 package <span class="keyword">in</span> 124.659s</span><br><span class="line">$ npm install express@4.16.1 --save</span><br><span class="line">+ express@4.16.1</span><br><span class="line">added 4 packages from 4 contributors, removed 3 packages and updated 16 packages <span class="keyword">in</span> 20.374s</span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://docs.npmjs.com/cli/install">https://docs.npmjs.com/cli/install</a></p>
<center><a id="more"></a></center>

<h3 id="npm-list"><a href="#npm-list" class="headerlink" title="npm list"></a>npm list</h3><p>check the installed packages under current folder:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm list</span><br><span class="line">express-test@0.0.0 C:\Users\eshibij\Desktop\express-test</span><br><span class="line">-- express@4.16.1 invalid</span><br><span class="line">  +-- accepts@1.3.7 extraneous</span><br><span class="line">  +-- array-flatten@1.1.1 extraneous</span><br><span class="line">  +-- body-parser@1.18.2 extraneous</span><br><span class="line">  ....</span><br></pre></td></tr></table></figure>
<h3 id="upgrade-node-to-given-version"><a href="#upgrade-node-to-given-version" class="headerlink" title="upgrade node to given version"></a>upgrade node to given version</h3><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><ol>
<li><p>install <code>n</code> widget as tool upgrading node:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/<span class="comment"># node -v</span></span><br><span class="line">v14.5.0</span><br><span class="line">root@f7748a275a7a:/<span class="comment"># npm cache clean -f</span></span><br><span class="line">npm WARN using --force I sure hope you know what you are doing.</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/<span class="comment"># npm install -g n        </span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/n -&gt; /usr/<span class="built_in">local</span>/lib/node_modules/n/bin/n</span><br><span class="line">+ n@6.7.0</span><br><span class="line">added 1 package from 4 contributors <span class="keyword">in</span> 0.205s</span><br></pre></td></tr></table></figure></li>
<li><p>install node with given version:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/<span class="comment"># n v14.6.0</span></span><br><span class="line">  installing : node-v14.6.0</span><br><span class="line">       mkdir : /usr/<span class="built_in">local</span>/n/versions/node/14.6.0</span><br><span class="line">       fetch : https://nodejs.org/dist/v14.6.0/node-v14.6.0-linux-x64.tar.xz</span><br><span class="line">   installed : v14.6.0 (with npm 6.14.6)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@f7748a275a7a:/<span class="comment"># node -v</span></span><br><span class="line">v14.6.0</span><br></pre></td></tr></table></figure>
<h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><p>use <code>nvm</code> to manage node version on windows</p>
</li>
<li><p>install <code>nvm</code>:<br>download <code>nvm-setup.zip</code> from <a href="https://github.com/coreybutler/nvm-windows/releases">https://github.com/coreybutler/nvm-windows/releases</a> then install</p>
</li>
<li><p>check and switch node version:<br>check installed node version:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nvm ls</span><br></pre></td></tr></table></figure>
<p>install node with given version:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nvm install vXX</span><br></pre></td></tr></table></figure>
<p>choose certain installed verision:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nvm use xxx</span><br></pre></td></tr></table></figure>
<p>if error occurs like:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nvm install v10.15</span><br><span class="line">10.15.0</span><br><span class="line">Could not retrieve https://nodejs.org/dist/latest/SHASUMS256.txt.</span><br><span class="line">Get https://nodejs.org/dist/latest/SHASUMS256.txt: dial tcp 104.20.22.46:443: i/o timeout</span><br></pre></td></tr></table></figure>
<p>find nvm location with <code>where nvm</code> and modify the <code>settings.txt</code> under the path, add:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node_mirror:npm.taobao.org&#x2F;mirrors&#x2F;node&#x2F;</span><br><span class="line">npm_mirror:npm.taobao.org&#x2F;mirrors&#x2F;npm&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="node-js-run-unit-test-mocha"><a href="#node-js-run-unit-test-mocha" class="headerlink" title="node js run unit test (mocha)"></a>node js run unit test (mocha)</h3><p>ref: <a href="https://blog.csdn.net/weixin_42429288/article/details/97638626">https://blog.csdn.net/weixin_42429288/article/details/97638626</a></p>
</li>
<li><p>run single test<br>Add <code>only</code> before target case or suite, like</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">it.only(<span class="string">&#x27;XXX-1035 ....&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> db.initDB();</span><br><span class="line">    <span class="keyword">await</span> Area.dumpTestData2(<span class="string">&#x27;../../test/UT/data/Area1.json&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> agent.get(<span class="string">&#x27;/test/v1/xxx?origin=xxxx1&#x27;</span>)</span><br><span class="line">      .expect(<span class="number">200</span>,[ &#123; <span class="attr">out</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="keyword">in</span>: <span class="number">1</span>,</span><br><span class="line">        region: <span class="string">&#x27;region1&#x27;</span>,</span><br><span class="line">        adminZones: [ <span class="string">&#x27;Zona Norte&#x27;</span>, <span class="string">&#x27;Madrid Captial&#x27;</span> ] &#125; ])</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>can also add it before a suite, like:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">describe.only(<span class="string">&#x27;#digestAPI test()&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    before(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">await</span> db.initDB();</span><br><span class="line">        <span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line">        app = express();</span><br><span class="line">        serverDigest.baseRoute(app,<span class="number">9999</span>);</span><br><span class="line">        agent = request.agent(app);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    after(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// process.exit();</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">&#x27;XXX-980 ...&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>skip single Test<br>same way as <code>only</code>, you can add it after <code>describe</code> or <code>it</code> to skip certain suite/case.</p>
</li>
</ol>
<h3 id="npm-ERR-Maximum-call-stack-size-exceeded"><a href="#npm-ERR-Maximum-call-stack-size-exceeded" class="headerlink" title="npm ERR! Maximum call stack size exceeded"></a>npm ERR! Maximum call stack size exceeded</h3><p>Error came out when run <code>npm install --save --save-exact react-scripts@4.0.1</code><br>Solution:</p>
<ol>
<li>upgrade npm to a newer version, it worked for me after I switching to npm v6.14.6 from npm v6.4.1</li>
<li>delete <code>package-lock.json</code> and run <code>npm rebuild</code>, if not work, delete the npm_modules folder.</li>
</ol>
<h3 id="Node-Sass-does-not-yet-support-your-current-environment"><a href="#Node-Sass-does-not-yet-support-your-current-environment" class="headerlink" title="Node Sass does not yet support your current environment"></a>Node Sass does not yet support your current environment</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line">&gt; my-cv@<span class="number">0.1</span><span class="number">.0</span> build C:\Users\...\Desktop\...\cv\my-cv</span><br><span class="line">&gt; react-scripts build</span><br><span class="line">Creating an optimized production build...</span><br><span class="line">Failed to compile.</span><br><span class="line">./src/pages/App.module.scss</span><br><span class="line"><span class="built_in">Error</span>: Node Sass does not yet support your current environment: Windows <span class="number">64</span>-bit <span class="keyword">with</span> Unsupported runtime (<span class="number">83</span>)</span><br><span class="line">For more information on which environments are supported please see:</span><br><span class="line">https:<span class="comment">//github.com/sass/node-sass/releases/tag/v4.13.0</span></span><br></pre></td></tr></table></figure>
<p>Solution:  </p>
<ol>
<li>uninstall node-sass: <code>npm uninstall --save node-sass</code></li>
<li>reinstall node-sass: <code>npm install --save node-sass</code></li>
</ol>
<p>Update:<br>new issue occur: <code>Error: Node Sass version 5.0.0 is incompatible with ^4.0.0.</code><br>Solution:</p>
<ol>
<li>uninstall node-Sass</li>
<li>install node-sass version before v5.0.0: <code>npm install --save node-sass@4.14.1</code></li>
</ol>
<h3 id="upgrade-globally-installed-npm-packages"><a href="#upgrade-globally-installed-npm-packages" class="headerlink" title="upgrade globally installed npm packages"></a>upgrade globally installed npm packages</h3><p>check out-dated packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm outdated -g</span><br><span class="line">Package              Current   Wanted   Latest  Location</span><br><span class="line">@uisdk/cdt-build      2.5.10    2.6.1    2.6.1  global</span><br><span class="line">@uisdk/cdt-package     2.5.4    2.5.8    2.5.8  global</span><br><span class="line">@uisdk/cdt-serve      2.3.21   2.3.24   2.3.24  global</span><br><span class="line">@uisdk/cdt-skeleton    2.3.2    2.3.3    2.3.3  global</span><br><span class="line">@uisdk/cdt2            2.6.0    2.6.3    2.6.3  global</span><br><span class="line">cnpm                   6.1.0    6.1.1    6.1.1  global</span><br><span class="line">eslint                 6.0.1    6.8.0   7.18.0  global</span><br><span class="line">gatsby-cli            2.17.1   2.18.0   2.18.0  global</span><br><span class="line">hexo-cli               2.0.0    2.0.0    4.2.0  global</span><br><span class="line">jshint                2.10.2   2.12.0   2.12.0  global</span><br><span class="line">n                      6.7.0    6.8.0    7.0.0  global</span><br><span class="line">npm                   6.14.6  6.14.11  6.14.11  global</span><br></pre></td></tr></table></figure>
<p>update all global packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm update -g</span><br></pre></td></tr></table></figure>
<p>update specific global package:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm update -g &lt;package_name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="react-scripts-dependency-error"><a href="#react-scripts-dependency-error" class="headerlink" title="react-scripts dependency error"></a>react-scripts dependency error</h3><p>error message:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">react-scripts package provided by Create React App requires a dependency:</span><br><span class="line"><span class="string">&quot;babel-eslint&quot;</span>: <span class="string">&quot;^10.1.0&quot;</span></span><br></pre></td></tr></table></figure>
<p>I tried to update babel-eslint globally but seems it was not out-dated, not sure why react use this new version.<br>solution:</p>
<ol>
<li>Add <code>.env</code> file under project with the following statement:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SKIP_PREFLIGHT_CHECK=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>Save <code>.env</code> and delete <code>package-lock.json</code></li>
<li><code>npm install</code> -&gt; <code>npm start</code></li>
</ol>
<h3 id="cannot-install-chart-js-from-react-chartjs-2"><a href="#cannot-install-chart-js-from-react-chartjs-2" class="headerlink" title="cannot install chart.js from react-chartjs-2"></a>cannot install chart.js from react-chartjs-2</h3><p>compling failed like:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR <span class="keyword">in</span> ./~/react-chartjs-2/lib/index.js</span><br><span class="line">Module not found: Error: Can<span class="string">&#x27;t resolve &#x27;</span>chart.js<span class="string">&#x27; in &#x27;</span>node_modules/react-chartjs-2/es<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>
<p>The reason is that, chart.js is a peer dependancy. we should include a version in package.json.<br>But after running <code>npm install --save chart.js</code>, the react-chartjs-2 module got error:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TypeError: Cannot <span class="built_in">read</span> property <span class="string">&#x27;defaults&#x27;</span> of undefined</span><br><span class="line">(anonymous <span class="keyword">function</span>)</span><br><span class="line">C:/Users//Desktop/covid19-tracker/node_modules/react-chartjs-2/es/index.js:643</span><br><span class="line">  640 | &#125;(_react[<span class="string">&quot;default&quot;</span>].Component);</span><br><span class="line">  641 |</span><br><span class="line">  642 | exports.Scatter = Scatter;</span><br><span class="line">&gt; 643 | var defaults = _chart[<span class="string">&quot;default&quot;</span>].defaults;</span><br><span class="line">  644 | exports.defaults = defaults;</span><br></pre></td></tr></table></figure>
<p>resolved with</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># firstly uninstall chart.js v3</span></span><br><span class="line">$ npm uninstall chart.js</span><br><span class="line"><span class="comment"># reinstall chart.js v2</span></span><br><span class="line">$ npm i chart.js@2.9 --save</span><br><span class="line">+ chart.js@2.9.4</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>node.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux CMD for daily use</title>
    <url>/2019/07/14/linux-cmd/</url>
    <content><![CDATA[<h3 id="check-log"><a href="#check-log" class="headerlink" title="check log"></a>check log</h3><ol>
<li><p>Display whole log file content:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat target.log</span><br></pre></td></tr></table></figure></li>
<li><p>Search key word in log file, and return lines containing keyword:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat target.log |grep <span class="string">&quot;keyword&quot;</span></span><br><span class="line">or</span><br><span class="line">$ grep -i <span class="string">&quot;keyword&quot;</span> target.log</span><br></pre></td></tr></table></figure>
<p>these two method return same result</p>
</li>
<li><p>Check the most recent log (the tail lines of log file):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat target.log |tail -n 200   <span class="comment"># check the last 200 lines of log file</span></span><br><span class="line">or</span><br><span class="line">$ tail -200f target.log   <span class="comment"># show last 200 lines and continue printing new logs</span></span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>
</li>
</ol>
<hr>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><ol>
<li>To test whether the target host is accessible, mainly has two ways:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping &lt;host addr&gt;    <span class="comment"># sample address: 192.168.1.21</span></span><br><span class="line">$ ping6 &lt;host addr&gt;   <span class="comment"># ipv6 address</span></span><br></pre></td></tr></table></figure></li>
<li>ping + paras:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -a &lt;addr&gt;  <span class="comment"># 把地址解析成主机名 (NetBios名)</span></span><br><span class="line">                  <span class="comment"># e.g. ping -a 192.168.1.21 returns</span></span><br><span class="line">                  <span class="comment"># Pinging iceblood.yofor.com [192.168.1.21] with 32 bytes of data</span></span><br><span class="line">                  <span class="comment"># so the NetBios name is iceblood.yofor.com with ip=192.168.1.21</span></span><br><span class="line">$ ping -t &lt;addr&gt;  <span class="comment"># continue pinging the addr</span></span><br><span class="line">                  <span class="comment"># press Ctl+Break to show statistic info and continue pinging</span></span><br><span class="line">                  <span class="comment"># Ctl+C to stop</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>For more:</strong> <a href="https://blog.csdn.net/zhoudaxia/article/details/6154065">从ping和ping6说起</a></p>
<hr>
<h3 id="file-transport-scp"><a href="#file-transport-scp" class="headerlink" title="file transport (scp)"></a>file transport (scp)</h3><ol>
<li>copy file from path1 to path2<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scp path1 username@targetAddr:path2</span><br><span class="line"><span class="comment"># sample:</span></span><br><span class="line">$ scp /home/usrsby/xxx.jar root@10.136.40.75:/home/usrsby</span><br><span class="line"><span class="comment"># while using jumper as proxy, file has to be transported twice</span></span><br><span class="line">$ scp /home/usrsby/xxx.jar node-image-name:/opt/xxx/xx-xx/xxx-server/repository/com/xxx/x/xx-service-configuration/1.0-SNAPSHOT/</span><br></pre></td></tr></table></figure></li>
<li>download file from remote vm:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Step1: copy target file from vm to jumper in same way as above</span></span><br><span class="line"><span class="comment"># Step2: download file to jumper, execute in jumper</span></span><br><span class="line">$ scp username@remoteAddr:/remotePath/file folder_in_jumper</span><br><span class="line"><span class="comment"># Sample:</span></span><br><span class="line">$ scp root@10.136.40.75:/home/usrsby/xx.log /home/usrsby</span><br></pre></td></tr></table></figure></li>
<li>when copy a folder:<br>Append <code>-r</code> after <code>scp</code> like:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scp -r /tmp/tempA/ root@10.127.40.25:/tmp/usrsby/ <span class="comment"># copy tempA folder to usrsby</span></span><br><span class="line"><span class="comment"># !notice: do not dismiss &quot;/&quot; at the end of target path, not same as copying single file</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>For more:</strong> <a href="https://www.cnblogs.com/linuxprobe-sarah/p/9902649.html">linux利用scp远程上传下载文件/文件夹</a></p>
<hr>
<h3 id="time"><a href="#time" class="headerlink" title="time"></a>time</h3><p>to show current local time:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ date</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="grep-awk-amp-sed"><a href="#grep-awk-amp-sed" class="headerlink" title="grep, awk &amp; sed"></a>grep, awk &amp; sed</h3><p><strong>AWSOME specific summary! –&gt; <a href="http://blog.cee.moe/a-brief-introduction-to-grep-awk-and-sed.html">A brief introduction to grep, awk &amp; sed</a></strong></p>
<ol>
<li><strong><code>grep</code> (Global Regular Expression Print)</strong> is used to search for specific terms in a file.<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep <span class="built_in">test</span> testscript  <span class="comment"># grep keyword filename</span></span><br><span class="line">just <span class="keyword">for</span> <span class="built_in">test</span></span><br><span class="line">$ grep <span class="built_in">test</span> * <span class="comment"># grep keyword all_files</span></span><br><span class="line">testCase:<span class="built_in">test</span></span><br><span class="line">testscript:just <span class="keyword">for</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
If multiple keywords are selected:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ less filename | grep -E <span class="string">&quot;kw1|kw2&quot;</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$ grep -E <span class="string">&quot;kw1|kw2&quot;</span> filename</span><br></pre></td></tr></table></figure>
grep and save to a new file:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -E <span class="string">&quot;ERROR|CRIT|WARN&quot;</span> xxxxx.log &gt; /path/&lt;new-file&gt;.txt</span><br></pre></td></tr></table></figure></li>
<li><strong><code>awk</code></strong> is a text pattern scanning and processing language, which is created by <strong>A</strong>ho, <strong>W</strong>einberger &amp; <strong>K</strong>ernighan. awk is mostly used for <strong>data extraction and reporting</strong> (dealing with .csv files).<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span> 1st and 4th column</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> awk <span class="string">&#x27;&#123;print $1, $4&#125;&#x27;</span> file.txt</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># same with &#x27;cat file.txt&#x27;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> awk <span class="string">&#x27;&#123;print $0&#125;&#x27;</span> file.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> more see the reference</span></span><br></pre></td></tr></table></figure></li>
<li><code>sed</code> refers to <strong>Stream Editor</strong>. It can perform text transformations on a given file or an input stream.<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> replace the 1st <span class="string">&#x27;test&#x27;</span> with <span class="string">&#x27;text&#x27;</span> <span class="keyword">in</span> each line</span></span><br><span class="line">sed &#x27;s/test/text/&#x27; file.txt</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># replace all &#x27;test&#x27; with &#x27;text&#x27; in each line</span></span></span><br><span class="line">sed &#x27;s/test/text/g&#x27; file.txt</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># replace the 2nd &#x27;test&#x27; with &#x27;text&#x27; in each line</span></span></span><br><span class="line">sed &#x27;s/test/text/2&#x27; file.txt</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># replace all &#x27;test&#x27; from the 2nd to the end of each line with &#x27;text&#x27;</span></span></span><br><span class="line">sed &#x27;s/test/text/2g&#x27; file.txt</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># replace the &#x27;test&#x27; in the 2nd line with &#x27;text&#x27;</span></span></span><br><span class="line">sed &#x27;2s/test/text/g&#x27; file.txt</span><br></pre></td></tr></table></figure>
<h3 id="2-gt-dev-null-1-gt-amp-2"><a href="#2-gt-dev-null-1-gt-amp-2" class="headerlink" title="2&gt;/dev/null 1&gt;&amp;2"></a>2&gt;/dev/null 1&gt;&amp;2</h3><a href="https://unix.stackexchange.com/questions/163352/what-does-dev-null-21-mean-in-this-article-of-crontab-basics">https://unix.stackexchange.com/questions/163352/what-does-dev-null-21-mean-in-this-article-of-crontab-basics</a><br><a href="https://stackoverflow.com/questions/818255/in-the-shell-what-does-21-mean">https://stackoverflow.com/questions/818255/in-the-shell-what-does-21-mean</a></li>
</ol>
<h3 id="–"><a href="#–" class="headerlink" title="–"></a>–</h3><p><a href="https://unix.stackexchange.com/questions/11376/what-does-double-dash-mean">https://unix.stackexchange.com/questions/11376/what-does-double-dash-mean</a></p>
<h3 id="switch-to-root-user"><a href="#switch-to-root-user" class="headerlink" title="switch to root user"></a>switch to root user</h3><p><code>su</code> –&gt; enter password of root user</p>
<h3 id="packaging-and-unzip-extraction"><a href="#packaging-and-unzip-extraction" class="headerlink" title="packaging and unzip (extraction)"></a>packaging and unzip (extraction)</h3><ul>
<li>unzip ：<code>$ tar zxvf fileName.tar.gz</code><br>For <code>.gz</code> file, it may appears as:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tar zxvf loggd_persistent.log.0.gz</span><br><span class="line">tar: This does not look like a tar archive</span><br><span class="line">tar: Skipping to next header</span><br><span class="line">tar: Exiting with failure status due to previous errors</span><br></pre></td></tr></table></figure>
Then use:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gzip -d &lt;source-file&gt;</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$ gunzip &lt;source-file&gt;</span><br></pre></td></tr></table></figure></li>
<li>packaging: <code>tar zcvf fileName.tar.gz dirPath</code> <br>or use<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gzip &lt;source-file&gt;                      <span class="comment"># will not keep the source file</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$ gzip -c &lt;source-file&gt; &gt; &lt;zipped-file&gt;   <span class="comment"># will keep both source file and zipped file</span></span><br></pre></td></tr></table></figure>
To zip a folder:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gzip -r &lt;directory&gt;</span><br></pre></td></tr></table></figure>
<h3 id="file-type"><a href="#file-type" class="headerlink" title="file type"></a>file type</h3>for details, see <a href="https://blog.csdn.net/rong09_13/article/details/79233956">https://blog.csdn.net/rong09_13/article/details/79233956</a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ file &lt;fileName&gt;</span><br></pre></td></tr></table></figure>
<h3 id="search-history-cmd"><a href="#search-history-cmd" class="headerlink" title="search history cmd"></a>search history cmd</h3>use <code>ctrl + r</code> to search history input, continue input until find the target cmd, then press <code>Enter</code> to execute.</li>
</ul>
<h3 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h3><ol>
<li>check port status<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsof -i:&lt;port-id&gt;</span><br></pre></td></tr></table></figure>
e.g.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 ~]# lsof -i:32228</span><br><span class="line">COMMAND     PID USER   FD   TYPE    DEVICE SIZE&#x2F;OFF NODE NAME</span><br><span class="line">kube-prox 21592 root   16u  IPv6 171971606      0t0  TCP *:32228 (LISTEN)</span><br></pre></td></tr></table></figure></li>
<li>check the process running on certain port<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netstat -tunlp | grep &lt;port-id&gt;</span><br></pre></td></tr></table></figure>
e.g.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 ~]# netstat -tunlp | grep 32228</span><br><span class="line">tcp6       0      0 :::32228                :::*                    LISTEN      21592&#x2F;kube-proxy</span><br></pre></td></tr></table></figure>
<h3 id="search-for-files"><a href="#search-for-files" class="headerlink" title="search for files"></a>search for files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find / -name *&lt;tap here&gt;* <span class="comment"># search from all files</span></span><br><span class="line">$ find . -name *&lt;tap here&gt;* <span class="comment"># search under current path</span></span><br></pre></td></tr></table></figure>
or<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ whereis &lt;name here&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>whereis命令只能用于程序名的搜索，而且只搜索二进制文件（参数-b）、man说明文件（参数-m）和源代码文件（参数-s）。如果省略参数，则返回所有信息</p>
</blockquote>
</li>
</ol>
<p>For more. refer <a href="http://www.ruanyifeng.com/blog/2009/10/5_ways_to_search_for_files_using_the_terminal.html">http://www.ruanyifeng.com/blog/2009/10/5_ways_to_search_for_files_using_the_terminal.html</a></p>
<h3 id="permit"><a href="#permit" class="headerlink" title="permit"></a>permit</h3><ol>
<li>give execution permit to certain <strong>file</strong>:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chmod +x file.sh</span><br></pre></td></tr></table></figure>
Then <code>file.sh</code> is a executable file and display in green, also use <code>-</code> can revert permit and the target file will return back to white.<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chmod -x file.sh</span><br></pre></td></tr></table></figure></li>
<li>777: give read, write and execution permit to file/folder:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chmod -R 777 *</span><br></pre></td></tr></table></figure>
Above cmd means give permits to all files or folders under current path, also we can use specific file name to institute <code>*</code>. \<blockquote>
<p>777:分别对应文件实际拥有者，文件实际拥有者所在的组，其它用户的权限，数字权限是基于八进制数字系统而创建的，读权限（read，r）的值是4，写权限（write，w）的值是2，执行权限（execute，x）的值是1，没有授权的值是0</p>
</blockquote>
</li>
</ol>
<h3 id="tcsh-set-resource"><a href="#tcsh-set-resource" class="headerlink" title="tcsh set resource"></a>tcsh set resource</h3><p>Linux usually use bash as the default shell, but for specific working env whcih only tcsh is allowed, use the following file to change the shell style. It serves as <code>.bashrc</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vi ~/.cshrc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>tcsh is an improved version of csh (c-shell)</p>
</blockquote>
<h3 id="list-files-folders-by-timestamp-asc-desc"><a href="#list-files-folders-by-timestamp-asc-desc" class="headerlink" title="list files/folders by timestamp (asc/desc)"></a>list files/folders by timestamp (asc/desc)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll -t       <span class="comment"># list files by time desc</span></span><br><span class="line">$ ll -t |tar  <span class="comment"># by asc</span></span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls -lart    <span class="comment"># desc</span></span><br></pre></td></tr></table></figure>
<h3 id="bash-cannot-create-temp-file-for-here-document-No-space-left-on-device"><a href="#bash-cannot-create-temp-file-for-here-document-No-space-left-on-device" class="headerlink" title="-bash: cannot create temp file for here-document: No space left on device"></a>-bash: cannot create temp file for here-document: No space left on device</h3><p>when using <code>tab</code> on linux and got the above error, you should check if the disk usage on current host is full.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ df -h</span><br><span class="line">$ du -sh /*   <span class="comment"># check which folder use the most memory</span></span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://blog.csdn.net/muriyue6/article/details/84783107">https://blog.csdn.net/muriyue6/article/details/84783107</a></p>
<h3 id="vim-show-line-number"><a href="#vim-show-line-number" class="headerlink" title="vim show line number"></a>vim show line number</h3><ol>
<li>click <code>esc</code> and <code>:</code></li>
<li>input <code>set nu</code></li>
</ol>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>cmd</tag>
      </tags>
  </entry>
  <entry>
    <title>Timeout in Node.JS</title>
    <url>/2020/05/19/nodejs-req-timeout/</url>
    <content><![CDATA[<p>Thanks for answers in <a href="https://stackoverflow.com/questions/6214902/how-to-set-a-timeout-on-a-http-request-in-node">https://stackoverflow.com/questions/6214902/how-to-set-a-timeout-on-a-http-request-in-node</a> <br>The problem can mainly divided into two part in my implemention:</p>
<ul>
<li>connection timeout</li>
<li>response timeout</li>
</ul>
<ol>
<li><p>connection timeout <br>On request stage:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// set the desired timeout in options</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    timeout: <span class="number">3000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// create a request</span></span><br><span class="line"><span class="keyword">const</span> request = http.request(options, <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// your callback here</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// use its &quot;timeout&quot; event to abort the request</span></span><br><span class="line">request.on(<span class="string">&#x27;timeout&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    request.abort();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>
</li>
<li><p>response timeout <br>On response stage:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> options = &#123; ... &#125;</span><br><span class="line"><span class="keyword">var</span> req = http.request(options, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Usual stuff: on(data), on(end), chunks, etc...</span></span><br><span class="line">&#125;);</span><br><span class="line">req.on(<span class="string">&#x27;socket&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">    socket.setTimeout(myTimeout);  </span><br><span class="line">    socket.on(<span class="string">&#x27;timeout&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        req.destroy();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">req.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.code === <span class="string">&quot;ECONNRESET&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Timeout occurs&quot;</span>);</span><br><span class="line">        <span class="comment">//specific error treatment</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//other error treatment</span></span><br><span class="line">&#125;);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>Failed starting postgres DB container via k8s on linux</title>
    <url>/2020/05/09/postgres-error-linux/</url>
    <content><![CDATA[<p>When starting a postgres DB container via kubernetes on linux host server, it failed to start the container.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@compute2 log]# kubectl get pod</span><br><span class="line">NAME                                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-764dc8f84b-smg92                               0&#x2F;1     Error     3          49s</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@compute2 log]# kubectl logs test-764dc8f84b-smg92</span><br><span class="line">The files belonging to this database system will be owned by user &quot;postgres&quot;.</span><br><span class="line">This user must also own the server process.</span><br><span class="line"></span><br><span class="line">The database cluster will be initialized with locale &quot;en_US.utf8&quot;.</span><br><span class="line">The default database encoding has accordingly been set to &quot;UTF8&quot;.</span><br><span class="line">The default text search configuration will be set to &quot;english&quot;.</span><br><span class="line"></span><br><span class="line">Data page checksums are disabled.</span><br><span class="line"></span><br><span class="line">fixing permissions on existing directory &#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data ... ok</span><br><span class="line">creating subdirectories ... ok</span><br><span class="line">selecting default max_connections ... 20</span><br><span class="line">selecting default shared_buffers ... 400kB</span><br><span class="line">selecting dynamic shared memory implementation ... posix</span><br><span class="line">creating configuration files ... ok</span><br><span class="line">child process was terminated by signal 7</span><br><span class="line">initdb: removing contents of data directory &quot;&#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data&quot;</span><br></pre></td></tr></table></figure>
<p>Image is with no problem cuz I can do <code>docker run</code> to start container successfully. <br>————————————— Solution ————————————— <br><a href="https://github.com/docker-library/postgres/issues/451">https://github.com/docker-library/postgres/issues/451</a> <br>there are several possible solutions to the problem:</p>
<ol>
<li>Modify the docker image to be able to set huge_pages = off in /usr/share/postgresql/postgresql.conf.sample before initdb was ran (this is what I did).</li>
<li>Turn off huge page support on the system (vm.nr_hugepages = 0 in /etc/sysctl.conf).</li>
<li>Fix Postgres’s fallback mechanism when huge_pages = try is set (the default).</li>
<li>Modify the k8s manifest to enable huge page support (<a href="https://kubernetes.io/docs/tasks/manage-hugepages/scheduling-hugepages/">https://kubernetes.io/docs/tasks/manage-hugepages/scheduling-hugepages/</a>).</li>
<li>Modify k8s to show that huge pages are not supported on the system, when they are not enabled for a specific container.</li>
</ol>
<p>I tried the second way, and solve the issue successfully.</p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>Kubernetes</tag>
        <tag>K8s</tag>
        <tag>postgres</tag>
      </tags>
  </entry>
  <entry>
    <title>Some tips about OpenLayer</title>
    <url>/2019/08/19/openlayer-knowledge/</url>
    <content><![CDATA[<p>Using openlayer in work currently and need to write down some notes about it.</p>
<h3 id="EPSG-4326-VS-EPSG-3857"><a href="#EPSG-4326-VS-EPSG-3857" class="headerlink" title="EPSG 4326 VS EPSG 3857"></a>EPSG 4326 VS EPSG 3857</h3><p>地理Coordiante系统由EPSG编号标识。最常用于网络地图应用的两个坐标系统是EPSG：4326和EPSG：3857。</p>
<ul>
<li><strong>EPSG：4326</strong>（又名WGS84，未投影）是一个地理的非项目坐标系。它是lat，longs GPS显示器，单位是十进制度。EPSG：4326无法在平面地图上以有意义的方式显示。</li>
<li><strong>EPSG：3857</strong>（又名Pseudo-Mercator，球形墨卡托或Web墨卡托）是投影坐标系。这是Google Maps和几乎所有其他Web制图应用程序使用的坐标系。</li>
</ul>
<p>通常，数据存储在EPSG：4326中并显示在EPSG：3857中，自行转换。</p>
<p><a href="http://liubf.com/2018/08/22/epsg-4326-vs-epsg-3857/">ref link</a></p>
 <center><a id="more"></a></center>


<hr>
<h3 id="Function-to-draw-a-sector-accurately"><a href="#Function-to-draw-a-sector-accurately" class="headerlink" title="Function to draw a sector accurately"></a>Function to draw a sector accurately</h3><p>Cuz the untransformed sector displayed with great error in angle = 45° (start angle) so I have to turn to this Function as following, which convert longitude and latitude into Mercator projection first before the calculation.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetMarcoXyArcArray</span>(<span class="params">origin,radius,sides,r,angel</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> x = [];</span><br><span class="line">            x[<span class="number">0</span>] = [origin[<span class="number">0</span>],origin[<span class="number">1</span>]];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt; sides; j++) &#123;</span><br><span class="line">                <span class="keyword">var</span> tx = origin[<span class="number">0</span>] + radius * <span class="built_in">Math</span>.cos(<span class="built_in">Math</span>.PI / <span class="number">180</span> * (<span class="number">90</span> - angel + (sides/<span class="number">2</span> - j) * r / (sides-<span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> ty = origin[<span class="number">1</span>] + radius * <span class="built_in">Math</span>.sin(<span class="built_in">Math</span>.PI / <span class="number">180</span> * (<span class="number">90</span> - angel + (sides/<span class="number">2</span> - j) * r / (sides-<span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line">                x[j]=[tx,ty];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//alert(x);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ol.geom.Polygon([x]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Thanks to <a href="https://blog.csdn.net/tianshibufan521/article/details/81102042">tianshibufan521’s post</a></p>
<p>After modification: <center><br><img src=https://res.cloudinary.com/elizashi/image/upload/v1565247149/gitblog/posts/openlayer/rightSector_prseyd.png style="width: 60%"/></p>
</center>


<h4 id="190813-update"><a href="#190813-update" class="headerlink" title="190813 update"></a>190813 update</h4><p>this method will lead to wrong presentation size at about 4/5 of expected radius due to the Mercator projection. I couldn’t figure out why for the second time I tried the origin calculation method as following, it turned out to appear normally with start angle of 45°.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; sides; ++i) &#123;</span><br><span class="line">  rotatedAngle = (i * radian / <span class="number">360</span> * <span class="number">2</span> * <span class="built_in">Math</span>.PI / sides) + (<span class="number">90</span> - angle - radian / <span class="number">2</span> )* <span class="built_in">Math</span>.PI / <span class="number">180</span> ; <span class="comment">// start from y = 0 (sector1 based on symmetry y axis, clockwise rotation)</span></span><br><span class="line">  coordinate = <span class="built_in">this</span>.getJWD(origin.Longitude, origin.Latitude, radius, rotatedAngle);  <span class="comment">// method getJWD() can be found ↓ link</span></span><br><span class="line">  points.push(coordinate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if not circle, add center point.</span></span><br><span class="line"><span class="comment">// this allows drawing circle via polygon api</span></span><br><span class="line"><span class="keyword">if</span> (radian !== <span class="string">&quot;360&quot;</span>) &#123;</span><br><span class="line">  points.push([origin.Longitude, origin.Latitude]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ring = <span class="keyword">new</span> ol.geom.LinearRing(points);</span><br><span class="line"><span class="keyword">var</span> pointsCoords = ring.getCoordinates();</span><br><span class="line">feature = <span class="keyword">new</span> ol.Feature(<span class="keyword">new</span> ol.geom.Polygon([pointsCoords]));</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="calculate-longitude-amp-latitude-via-coordinate"><a href="#calculate-longitude-amp-latitude-via-coordinate" class="headerlink" title="calculate longitude &amp; latitude via coordinate"></a>calculate longitude &amp; latitude via coordinate</h3><p>former dev using func getJWD to calculate the coordinates, but this func cause the display error with start degree of 45°, so I discarded it.<br>For more info about this func : <a href="https://www.cnblogs.com/zhoug2020/p/7634187.html">link</a></p>
<hr>
<h3 id="Draw-a-circle"><a href="#Draw-a-circle" class="headerlink" title="Draw a circle"></a>Draw a circle</h3><p>Simply used <code>ol.geom.Circle</code> instead of <code>ol..geom.Polygon</code>, which will cause a start/end radius as follows:</p>
<table>
<thead>
<tr>
<th align="left"><center>Before</th>
<th align="left"><center>After</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><img src=https://res.cloudinary.com/elizashi/image/upload/v1565247159/gitblog/posts/openlayer/circleError_ycjh8e.png style="width: 60%"/></td>
<td align="left"><img src=https://res.cloudinary.com/elizashi/image/upload/v1565247156/gitblog/posts/openlayer/updated_x1vkan.png style="width: 60%"/></td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> circle = <span class="keyword">new</span> ol.geom.Circle(</span><br><span class="line">    ol.proj.transform([longitude, latitude], <span class="string">&#x27;EPSG:4326&#x27;</span>, <span class="string">&#x27;EPSG:3857&#x27;</span>),</span><br><span class="line">    radius</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> circleFeature = <span class="keyword">new</span> ol.Feature(circle);</span><br></pre></td></tr></table></figure>
<p><a href="http://www.acuriousanimal.com/thebookofopenlayers3/index.html">OpenLayer Samples link</a>  ||  <a href="http://www.acuriousanimal.com/thebookofopenlayers3/chapter07_04_featureoverlay.html">Circle</a></p>
<h4 id="update"><a href="#update" class="headerlink" title="update:"></a>update:</h4><p>The pattern turned out to be simple circle pattern，which does not include geometry params，but our project need geometry params in GeoJSON format to decide which area is covered.<br>So I finally turn to <a href="https://openlayers.org/en/latest/apidoc/module-ol_geom_Polygon.html#.fromCircle">ol/geom/Polygon.fromCircle</a> which transform plain circle into Polygon format. It returns Polygon geometry so that can be used in further calculation of coverage.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> circle = <span class="keyword">new</span> OpenLayers.geom.Circle(circleParams.center, circleParams.radius);</span><br><span class="line">feature = <span class="keyword">new</span> OpenLayers.Feature(<span class="keyword">new</span> OpenLayers.geom.Polygon.fromCircle(circle, <span class="number">500</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>openlayer</tag>
      </tags>
  </entry>
  <entry>
    <title>Tips when using postgresql</title>
    <url>/2020/05/18/postgres-tips/</url>
    <content><![CDATA[<h3 id="ERROR-column-“xxx”-does-not-exist"><a href="#ERROR-column-“xxx”-does-not-exist" class="headerlink" title="[ERROR] column “xxx” does not exist"></a>[ERROR] column “xxx” does not exist</h3><p>This issue happens when run <code>db=&gt; select * from &quot;ExxJobs&quot; where status=&quot;Ongoing&quot;;</code> <br>It returns</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR:  column <span class="string">&quot;Ongoing&quot;</span> does not exist</span><br><span class="line">LINE 1: select * from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> status=<span class="string">&quot;Ongoing&quot;</span>;</span><br><span class="line">                                             ^</span><br><span class="line">ERROR:  column <span class="string">&quot;ongoing&quot;</span> does not exist</span><br><span class="line">LINE 1: select * from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> status=Ongoing;</span><br><span class="line">                                             ^</span><br></pre></td></tr></table></figure>
<p><strong>Solution</strong> <br>just change “” to ‘’.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db=&gt; select * from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> status=<span class="string">&#x27;Ongoing&#x27;</span>;</span><br><span class="line"> id | <span class="built_in">type</span>| xxxJobId |   xxxJobUrl  | status  | errorMessage |         createdAt          |         updatedAt</span><br><span class="line">----+-----------------+----------+--------------------------------------------------------------------------------------------------------+---------+--------------+----------------------------+----------------------------</span><br><span class="line"> 16 | ... | 22947534 |   &#123;<span class="string">&quot;...&quot;</span>&#125;   |  Ongoing |              | 2020-05-18 06:17:32.525+00 | 2020-05-18 06:17:32.544+00</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
<p>similarly:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cecdb=&gt; delete from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> <span class="string">&#x27;xxxJobId&#x27;</span>=22674314;</span><br><span class="line">ERROR:  invalid input syntax <span class="keyword">for</span> <span class="built_in">integer</span>: <span class="string">&quot;xxxJobId&quot;</span></span><br><span class="line">LINE 1: delete from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> <span class="string">&#x27;xxxJobId&#x27;</span>=22674314;</span><br><span class="line"></span><br><span class="line">db=&gt; delete from <span class="string">&quot;ExxJobs&quot;</span> <span class="built_in">where</span> <span class="string">&quot;xxxJobId&quot;</span>=<span class="string">&#x27;22674314&#x27;</span>;</span><br><span class="line">DELETE 1</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>postgres</tag>
      </tags>
  </entry>
  <entry>
    <title>Python concepts</title>
    <url>/2021/05/06/py-basic/</url>
    <content><![CDATA[<h3 id="classmethod-amp-staticmethod"><a href="#classmethod-amp-staticmethod" class="headerlink" title="classmethod &amp; staticmethod"></a>classmethod &amp; staticmethod</h3><p><a href="https://www.cnblogs.com/baxianhua/p/10845620.html">https://www.cnblogs.com/baxianhua/p/10845620.html</a>  </p>
<p>Python不支持多个的參数重载构造函数，用classmethod修饰符的方式，定义出来的函数就能够在类对象实例化之前调用这些函数，就相当于多个构造函数，解决多个构造函数的代码写在类外面的问题  </p>
<p>类最基本的作用是实例化出一个对象，但是有的时候再实例化之前，就需要先和类做一定的交互(init方法里需要调用类里的方法，或init之前需要调用类方法)，这种交互可能会影响实际实例化的过程，所以必须放在调用构造函数之前。大概也可能是因为这个原因出现了classmethod  </p>
<p>对于一个普通的类，我们要使用其中的函数的话，需要对类进行实例化，而一个类中，某个函数前面加上了staticmethod或者classmethod的话，那么这个函数就可以不通过实例化直接调用，可以通过类名进行调用的</p>
<p>类方法的第一个参数(cls)指代的就是类本身。类方法会用这个类来创建并返回最终的实例。使用类方法的另一个好处就是在继承的时候，保证了子类使用可选构造函数构造出来的类是子类的实例而不是父类的实例</p>
<p>staticmethod就是全局可调的静态方法</p>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><p><a href="https://blog.csdn.net/mieleizhi0522/article/details/82142856">https://blog.csdn.net/mieleizhi0522/article/details/82142856</a><br>yield = return &amp; generator</p>
<center><a id="more"></a></center>

<h3 id="json-transform-from-string-to-json"><a href="#json-transform-from-string-to-json" class="headerlink" title="json (transform from string to json)"></a>json (transform from string to json)</h3><p>import <code>json</code> module first</p>
<ol>
<li>JSON string -&gt; JSON: <code>json.loads()</code><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rawData = json.loads(soup.get_text())[<span class="string">&quot;data&quot;</span>]</span><br></pre></td></tr></table></figure></li>
<li>Python object -&gt; JSON: <code>json.dumps()</code><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dict</span> = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Anne&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line">data = json.dumps(<span class="built_in">dict</span>)</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python development &amp; problems</title>
    <url>/2021/05/06/py-problem/</url>
    <content><![CDATA[<h3 id="venv-setup-activate-amp-exit"><a href="#venv-setup-activate-amp-exit" class="headerlink" title="venv setup, activate &amp; exit"></a>venv setup, activate &amp; exit</h3><ol>
<li>setup:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python3 -m venv</span><br></pre></td></tr></table></figure></li>
<li>activate:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . venv/Scripts/activate        <span class="comment"># windows</span></span><br><span class="line">$ <span class="built_in">source</span> venv/bin/activate       <span class="comment"># linux &amp; Mac OS</span></span><br></pre></td></tr></table></figure></li>
<li>exit:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ deactivate</span><br></pre></td></tr></table></figure>
ref: <a href="https://blog.csdn.net/weixin_30292745/article/details/101445788?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-3-101445788.pc_agg_rank_aggregation&amp;utm_term=python+%E5%85%B3%E9%97%ADvenv&amp;spm=1000.2123.3001.4430">https://blog.csdn.net/weixin_30292745/article/details/101445788?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-3-101445788.pc_agg_rank_aggregation&amp;utm_term=python+%E5%85%B3%E9%97%ADvenv&amp;spm=1000.2123.3001.4430</a></li>
</ol>
<center><a id="more"></a></center>

<h3 id="setup-flask-development-env-inside-react-project"><a href="#setup-flask-development-env-inside-react-project" class="headerlink" title="setup flask development env inside react project"></a>setup flask development env inside react project</h3><p>take my project as an example:</p>
<ol>
<li>mkdir react-app/api/</li>
<li>under <code>api/</code>, create file named <code>api.py</code></li>
<li>(venv) pip install python-dotenv</li>
<li>create <code>.env</code> file under /api</li>
<li>write the following content into .env:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FLASK_APP=api.py</span><br><span class="line">FLASK_ENV=development</span><br></pre></td></tr></table></figure>
start server:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ flask run</span><br></pre></td></tr></table></figure>
ref: <a href="https://stackoverflow.com/questions/54600434/how-to-set-flask-env-inside-config-file">https://stackoverflow.com/questions/54600434/how-to-set-flask-env-inside-config-file</a></li>
</ol>
<h3 id="UnicodeEncodeError"><a href="#UnicodeEncodeError" class="headerlink" title="UnicodeEncodeError"></a>UnicodeEncodeError</h3><ol>
<li>‘charmap’ codec can’t encode characters in position 87-93: character maps to <undefined><br><a href="https://stackoverflow.com/questions/27092833/unicodeencodeerror-charmap-codec-cant-encode-characters">https://stackoverflow.com/questions/27092833/unicodeencodeerror-charmap-codec-cant-encode-characters</a><br>tried multiple ways to print the raw context directly but failed, but it can be written into files with<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;books.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(json.dumps(item, ensure_ascii=<span class="literal">False</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="UnicodeEncodeError-‘charmap’-codec-can’t-encode-character-‘-u0130’"><a href="#UnicodeEncodeError-‘charmap’-codec-can’t-encode-character-‘-u0130’" class="headerlink" title="UnicodeEncodeError: ‘charmap’ codec can’t encode character ‘\u0130’"></a>UnicodeEncodeError: ‘charmap’ codec can’t encode character ‘\u0130’</h3>‘\u0130’ is ‘I’ in Latin, charmap is the default encoding format used locally.<br>solution: <code>&lt;target-string&gt;.encode(&#39;utf-8&#39;)</code><br>Note, it cannot be fully handled with above encoding function, it actually turn out to be like <code>&quot;\u0130stanbul&quot;</code><br>currently I have no better solution but add one more function to translate the Latin letter to English …</li>
</ol>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>Promise</title>
    <url>/2019/08/15/promise/</url>
    <content><![CDATA[<h2 id="js-async-Promise"><a href="#js-async-Promise" class="headerlink" title="js async - Promise"></a>js async - Promise</h2><p>How <code>Promise</code> works is that, each async task will return result and construct a Promise instance, and each instance has a <code>then</code>, which is used for directing to next callback func.<br>Here is a simple promise example:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// async codes here..</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(f1); <span class="comment">// f1 is an async callback function/task,</span></span><br><span class="line">                          <span class="comment">// promise instance p1 receives f1&#x27;s result</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// when f1 is done, do f2</span></span><br><span class="line">p1.then(f2);              <span class="comment">// f2 is the next async func to be executed</span></span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>

<p>Promise changed the style of multiple nesting levels. <br>In olde way, these steps will be written as:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">step1(<span class="function"><span class="keyword">function</span> (<span class="params">value1</span>) </span>&#123;</span><br><span class="line">  step2(value1, <span class="function"><span class="keyword">function</span>(<span class="params">value2</span>) </span>&#123;</span><br><span class="line">    step3(value2, <span class="function"><span class="keyword">function</span>(<span class="params">value3</span>) </span>&#123;</span><br><span class="line">      step4(value3, <span class="function"><span class="keyword">function</span>(<span class="params">value4</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>using Promise, it will be like:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">new</span> <span class="built_in">Promise</span>(step1))</span><br><span class="line">  .then(step2)</span><br><span class="line">  .then(step3)</span><br><span class="line">  .then(step4);</span><br></pre></td></tr></table></figure>
<h3 id="Promise-state"><a href="#Promise-state" class="headerlink" title="Promise state"></a>Promise state</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* 异步操作成功 */</span>)&#123;</span><br><span class="line">    resolve(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    reject(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>resolve</code> and <code>reject</code> is two functions provided by JS engine. (no need to declare)</p>
<ul>
<li><code>resolve</code> : change the state of promise obj from <strong>pending</strong> to <strong>resolved</strong></li>
<li><code>reject</code> : change the state of promise obj from <strong>pending</strong> to <strong>rejected</strong></li>
</ul>
<p><em>note: when the state is changed, nothing can be done to roll back the transaction.</em></p>
<p>我的理解是，<code>resolve()</code>, <code>reject()</code>像两个一次性boolean函数，一旦被call就会从false变为true并直接将promise实例做上resolved/rejected的状态标记。</p>
<p>If the Promise instance has already been generated, can use <code>then</code> declare the callback functions for these two state:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// success</span></span><br><span class="line">  <span class="comment">// call when state changed to resolved</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// failure</span></span><br><span class="line">  <span class="comment">// call when state changed to rejected</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Both functions receive result returned by Promise obj as paremeter <code>value</code>/<code>error</code>.</p>
<p><strong>Promise 新建后会立即执行</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Promise&#x27;</span>); <span class="comment">//立即执行</span></span><br><span class="line">  resolve();  <span class="comment">// state changed, call then</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// `then` 要在当前脚本的所有同步任务（同级的）都执行完才会执行</span></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;   <span class="comment">// only resolve func</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;resolved.&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Hi!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise</span></span><br><span class="line"><span class="comment">// Hi!</span></span><br><span class="line"><span class="comment">// resolved</span></span><br></pre></td></tr></table></figure>
<p>For more info : <a href="https://es6.ruanyifeng.com/#docs/promise">ES6入门（阮一峰）</a>  | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"> MDN - Promise</a></p>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Python learning</title>
    <url>/2021/05/06/py-basic0/</url>
    <content><![CDATA[<h3 id="classmethod-amp-staticmethod"><a href="#classmethod-amp-staticmethod" class="headerlink" title="classmethod &amp; staticmethod"></a>classmethod &amp; staticmethod</h3><p><a href="https://www.cnblogs.com/baxianhua/p/10845620.html">https://www.cnblogs.com/baxianhua/p/10845620.html</a>  </p>
<p>Python不支持多个的參数重载构造函数，用classmethod修饰符的方式，定义出来的函数就能够在类对象实例化之前调用这些函数，就相当于多个构造函数，解决多个构造函数的代码写在类外面的问题  </p>
<p>类最基本的作用是实例化出一个对象，但是有的时候再实例化之前，就需要先和类做一定的交互(init方法里需要调用类里的方法，或init之前需要调用类方法)，这种交互可能会影响实际实例化的过程，所以必须放在调用构造函数之前。大概也可能是因为这个原因出现了classmethod  </p>
<p>对于一个普通的类，我们要使用其中的函数的话，需要对类进行实例化，而一个类中，某个函数前面加上了staticmethod或者classmethod的话，那么这个函数就可以不通过实例化直接调用，可以通过类名进行调用的</p>
<p>类方法的第一个参数(cls)指代的就是类本身。类方法会用这个类来创建并返回最终的实例。使用类方法的另一个好处就是在继承的时候，保证了子类使用可选构造函数构造出来的类是子类的实例而不是父类的实例</p>
<p>staticmethod就是全局可调的静态方法</p>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><p><a href="https://blog.csdn.net/mieleizhi0522/article/details/82142856">https://blog.csdn.net/mieleizhi0522/article/details/82142856</a><br>yield = return &amp; generator</p>
]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>Request API</title>
    <url>/2020/07/14/request-nodejs/</url>
    <content><![CDATA[<p>Request used in send request to other domain.<br><a href="https://blog.csdn.net/wuqingdeqing/article/details/99061026">https://blog.csdn.net/wuqingdeqing/article/details/99061026</a> <br><a href="https://blog.csdn.net/miss1128726/article/details/49976855">https://blog.csdn.net/miss1128726/article/details/49976855</a> <br>a basic sample of request:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  uri: <span class="string">&#x27;http://api.example.fr/example/1.xml&#x27;</span>,</span><br><span class="line">  auth: &#123;</span><br><span class="line">    user: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    pass: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    sendImmediately: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">request(options, <span class="function"><span class="keyword">function</span>(<span class="params">error, response, body</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;body : &#x27;</span> + body)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Code : &#x27;</span> + response.statusCode)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;error : &#x27;</span> + error)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;body : &#x27;</span> + body)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This method has limitation for case that expecting to send datas to more than one server. Like, I want to send xml sais to multiple bdc servers, it turns out to only transfer datas to the last bdc. (using <code>request(options, responseHandler</code>)</p>
 <center><a id="more"></a></center>
---

<p>A better way to resolve this problem is utilizing <code>request-promise</code>. <br>see <a href="https://www.npmjs.com/package/request-promise">official API description</a>. <br>Here is my implementation:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> rp = <span class="built_in">require</span>(<span class="string">&#x27;request-promise&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">sample</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">sampleFunc</span>(<span class="params">para1, para2, para3</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> opts = &#123;</span><br><span class="line">      url: url,</span><br><span class="line">      method: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">      auth:&#123;</span><br><span class="line">          user: username,</span><br><span class="line">          pass: password,</span><br><span class="line">          sendImmediately: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(url.toLowerCase().startsWith(<span class="string">&#x27;https&#x27;</span>))&#123;</span><br><span class="line">        opts.ca = cert;</span><br><span class="line">        opts = <span class="built_in">Object</span>.assign(Config.defaultOptions,opts); <span class="comment">// sample</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> responseHandler = <span class="function">(<span class="params">err, res, data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// sample</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> rp(opts).then(responseHandler).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// print error in log</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="0717-UPDATE"><a href="#0717-UPDATE" class="headerlink" title="0717 UPDATE"></a>0717 UPDATE</h3><p>ERROR implement request-promise above, <strong>note that it returns different paras from original request</strong> <br>Point:</p>
<ul>
<li>resolveWithFullResponse: true,</li>
<li>then(reponse)<br>Corrected:<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">sampleFunc</span>(<span class="params">para1, para2, para3</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> opts = &#123;</span><br><span class="line">      url: url,</span><br><span class="line">      method: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">      resolveWithFullResponse: <span class="literal">true</span>,</span><br><span class="line">      auth:&#123;</span><br><span class="line">          user: username,</span><br><span class="line">          pass: password,</span><br><span class="line">          sendImmediately: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">const</span> responseHandler = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// the res is a full response containing res.statusCode &amp; res.body</span></span><br><span class="line">    <span class="comment">// sample</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> rp(opts).then(responseHandler).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// print error in log</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>node.js</tag>
        <tag>backend</tag>
      </tags>
  </entry>
  <entry>
    <title>PyQt Learning &amp; Practice</title>
    <url>/2020/10/12/pyqt/</url>
    <content><![CDATA[<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install PyQt5</span><br><span class="line">Collecting PyQt5</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/43/cf/f89c7e632014cb8725fc30b36292ca709a5b5598e4e99fff09cb677fc898/PyQt5-5.15.1-5.15.1-cp35.cp36.cp37.cp38.cp39-none-win32.whl (51.2MB)</span><br><span class="line">     |████████████████████████████████| 51.2MB 117kB/s</span><br><span class="line">Collecting PyQt5-sip&lt;13,&gt;=12.8 (from PyQt5)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/69/eb/bb296c8a96eadacd5e91df3f5d600d9e4727b90e8b010cb86e146f995ce4/PyQt5_sip-12.8.1-cp37-cp37m-win32.whl (50kB)</span><br><span class="line">     |████████████████████████████████| 51kB 233kB/s</span><br><span class="line">Installing collected packages: PyQt5-sip, PyQt5</span><br><span class="line">Successfully installed PyQt5-5.15.1 PyQt5-sip-12.8.1</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install pyqt5-tools</span><br><span class="line">Collecting pyqt5-tools</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/68/5b/202a0dbe7774f26be5ade0fa42cbd4cc6fc4dc5b19c824dfccf6160f8566/pyqt5_tools-5.15.1.1.7.4-cp37-cp37m-win32.whl (48.1MB)</span><br><span class="line">     |█                               | 1.7MB 16kB/s eta 0:47:49ERROR: Exception:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\urllib3\response.py&quot;</span>, line 397, <span class="keyword">in</span> _error_catcher</span><br><span class="line">    yield</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\urllib3\response.py&quot;</span>, line 479, <span class="keyword">in</span> <span class="built_in">read</span></span><br><span class="line">    data = self._fp.read(amt)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\cachecontrol\filewrapper.py&quot;</span>, line 62, <span class="keyword">in</span> <span class="built_in">read</span></span><br><span class="line">    data = self.__fp.read(amt)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\http\client.py&quot;</span>, line 457, <span class="keyword">in</span> <span class="built_in">read</span></span><br><span class="line">    n = self.readinto(b)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\http\client.py&quot;</span>, line 501, <span class="keyword">in</span> readinto</span><br><span class="line">    n = self.fp.readinto(b)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\socket.py&quot;</span>, line 589, <span class="keyword">in</span> readinto</span><br><span class="line">    <span class="built_in">return</span> self._sock.recv_into(b)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\ssl.py&quot;</span>, line 1071, <span class="keyword">in</span> recv_into</span><br><span class="line">    <span class="built_in">return</span> self.read(nbytes, buffer)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\ssl.py&quot;</span>, line 929, <span class="keyword">in</span> <span class="built_in">read</span></span><br><span class="line">    <span class="built_in">return</span> self._sslobj.read(len, buffer)</span><br><span class="line">socket.timeout: The <span class="built_in">read</span> operation timed out</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\cli\base_command.py&quot;</span>, line 188, <span class="keyword">in</span> main</span><br><span class="line">    status = self.run(options, args)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\commands\install.py&quot;</span>, line 345, <span class="keyword">in</span> run</span><br><span class="line">    resolver.resolve(requirement_set)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\legacy_resolve.py&quot;</span>, line 196, <span class="keyword">in</span> resolve</span><br><span class="line">    self._resolve_one(requirement_set, req)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\legacy_resolve.py&quot;</span>, line 359, <span class="keyword">in</span> _resolve_one</span><br><span class="line">    abstract_dist = self._get_abstract_dist_for(req_to_install)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\legacy_resolve.py&quot;</span>, line 307, <span class="keyword">in</span> _get_abstract_dist_for</span><br><span class="line">    self.require_hashes</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\operations\prepare.py&quot;</span>, line 199, <span class="keyword">in</span> prepare_linked_requirement</span><br><span class="line">    progress_bar=self.progress_bar</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 1064, <span class="keyword">in</span> unpack_url</span><br><span class="line">    progress_bar=progress_bar</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 924, <span class="keyword">in</span> unpack_http_url</span><br><span class="line">    progress_bar)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 1152, <span class="keyword">in</span> _download_http_url</span><br><span class="line">    _download_url(resp, link, content_file, hashes, progress_bar)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 861, <span class="keyword">in</span> _download_url</span><br><span class="line">    hashes.check_against_chunks(downloaded_chunks)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\utils\hashes.py&quot;</span>, line 75, <span class="keyword">in</span> check_against_chunks</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 829, <span class="keyword">in</span> written_chunks</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\utils\ui.py&quot;</span>, line 156, <span class="keyword">in</span> iter</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> it:</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_internal\download.py&quot;</span>, line 818, <span class="keyword">in</span> resp_read</span><br><span class="line">    decode_content=False):</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\urllib3\response.py&quot;</span>, line 531, <span class="keyword">in</span> stream</span><br><span class="line">    data = self.read(amt=amt, decode_content=decode_content)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\urllib3\response.py&quot;</span>, line 496, <span class="keyword">in</span> <span class="built_in">read</span></span><br><span class="line">    raise IncompleteRead(self._fp_bytes_read, self.length_remaining)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\contextlib.py&quot;</span>, line 130, <span class="keyword">in</span> __exit__</span><br><span class="line">    self.gen.throw(<span class="built_in">type</span>, value, traceback)</span><br><span class="line">  File <span class="string">&quot;c:\users\eshibij\appdata\local\programs\python\python37-32\lib\site-packages\pip\_vendor\urllib3\response.py&quot;</span>, line 402, <span class="keyword">in</span> _error_catcher</span><br><span class="line">    raise ReadTimeoutError(self._pool, None, <span class="string">&#x27;Read timed out.&#x27;</span>)</span><br><span class="line">pip._vendor.urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host=<span class="string">&#x27;files.pythonhosted.org&#x27;</span>, port=443): Read timed out.</span><br><span class="line">WARNING: You are using pip version 19.2.3, however version 20.2.4 is available.</span><br><span class="line">You should consider upgrading via the <span class="string">&#x27;python -m pip install --upgrade pip&#x27;</span> <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<p>rerun the install cmd, then finished with:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install pyqt5-tools</span><br><span class="line">Collecting pyqt5-tools</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/68/5b/202a0dbe7774f26be5ade0fa42cbd4cc6fc4dc5b19c824dfccf6160f8566/pyqt5_tools-5.15.1.1.7.4-cp37-cp37m-win32.whl (48.1MB)</span><br><span class="line">     |████████████████████████████████| 48.1MB 656kB/s</span><br><span class="line">Collecting python-dotenv (from pyqt5-tools)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/f2/16/28d434b28c5be29a6af8fd0e3a2bda3bd30500ef0cd17bc79f7a6793a8d4/python_dotenv-0.14.0-py2.py3-none-any.whl</span><br><span class="line">Collecting click (from pyqt5-tools)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/d2/3d/fa76db83bf75c4f8d338c2fd15c8d33fdd7ad23a9b5e57eb6c5de26b430e/click-7.1.2-py2.py3-none-any.whl (82kB)</span><br><span class="line">     |████████████████████████████████| 92kB 590kB/s</span><br><span class="line">Requirement already satisfied: pyqt5==5.15.1 <span class="keyword">in</span> c:\users\eshibij\appdata\<span class="built_in">local</span>\programs\python\python37-32\lib\site-packages (from pyqt5-tools) (5.15.1)</span><br><span class="line">Requirement already satisfied: PyQt5-sip&lt;13,&gt;=12.8 <span class="keyword">in</span> c:\users\eshibij\appdata\<span class="built_in">local</span>\programs\python\python37-32\lib\site-packages (from pyqt5==5.15.1-&gt;pyqt5-tools) (12.8.1)</span><br><span class="line">Installing collected packages: python-dotenv, click, pyqt5-tools</span><br><span class="line">Successfully installed click-7.1.2 pyqt5-tools-5.15.1.1.7.4 python-dotenv-0.14.0</span><br><span class="line">WARNING: You are using pip version 19.2.3, however version 20.2.4 is available.</span><br><span class="line">You should consider upgrading via the <span class="string">&#x27;python -m pip install --upgrade pip&#x27;</span> <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<p>check if successfully installed:<br>win + s and search with <code>designer</code>, then callout the Qt tool GUI.</p>
<p>ref: <a href="https://blog.csdn.net/azuremouse/article/details/90338961">https://blog.csdn.net/azuremouse/article/details/90338961</a></p>
<h3 id="Widget"><a href="#Widget" class="headerlink" title="Widget"></a>Widget</h3><ol>
<li>QtCore.QRect<br>(x, y, width, height)<br>x, y为widget相对于父widget的左上角坐标，以此点为起点，向右width，向下height</li>
</ol>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3>]]></content>
      <categories>
        <category>interest</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>GUI</tag>
        <tag>PyQt</tag>
      </tags>
  </entry>
  <entry>
    <title>React Learning</title>
    <url>/2021/01/29/react/</url>
    <content><![CDATA[<p>This is a recording of my study on React framework</p>
<h4 id="super-props-super-no-super"><a href="#super-props-super-no-super" class="headerlink" title="super(props) | super() | no super"></a>super(props) | super() | no super</h4><ul>
<li><strong>super()</strong>:<br>If constructor is used, there is a must to add <code>super()</code>, it is for initializing <code>this</code>, and can bind events to <code>this</code>.  </li>
<li><strong>super(props)</strong>:<br>If you want to use <code>this.props</code> in a constructor, also need to add <code>super(props)</code>.<br>(No matter there is a constructor, <code>this.props</code> can work in render(), this is auto-implemented by React)  </li>
<li><strong>no super</strong>:<br>If there is no constructor, super is not mandatory, cuz React will add a empty constructor as default.  </li>
</ul>
<center><a id="more"></a></center>

<p>Here I created a component using ES6 class:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.props.attr1 = <span class="string">&quot;a1&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.props.attr2 = <span class="string">&quot;a2&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      some: <span class="string">&quot;Sample&#x27;s value&quot;</span>,</span><br><span class="line">      arr: [],</span><br><span class="line">      opt: <span class="string">&quot;c&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The child class “Sample” must use a <code>super()</code> to inherit the properties from parent class <code>React.Component</code>.<br>For the above sample, the child class also want to declare new properties based on the inherits, so it needs to use <code>super(props)</code>.<br>If only the <code>state</code> is needed, <code>super()</code> is enough.<br>This is because, <code>this.props</code> must be an object, so we can declare properties under it.<br>But <code>constructor(props)&#123;&#125;</code> defined <code>props</code> as an object.<br>What <code>super(props)</code> does is to assign an object to <code>props</code> (<code>this.props=props</code>)  in parent constructor, others with no passing parameters are assigned as undefined.<br>As there is no property under <code>state</code>, it is ok to define state with <code>super()</code>.</p>
<p>ref： <a href="https://www.cnblogs.com/itgezhu/p/11199313.html">https://www.cnblogs.com/itgezhu/p/11199313.html</a></p>
<h4 id="skip-constructor-when-using-state"><a href="#skip-constructor-when-using-state" class="headerlink" title="skip constructor when using state"></a>skip constructor when using state</h4><p>In <strong>ES7</strong>, it is supported to use <code>state</code> only instead of build a constructor first.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It works equal to</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      data: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="React-hooks"><a href="#React-hooks" class="headerlink" title="React hooks"></a>React hooks</h4><p>4 basic hooks: <a href="http://www.ruanyifeng.com/blog/2019/09/react-hooks.html">http://www.ruanyifeng.com/blog/2019/09/react-hooks.html</a><br><code>useState</code>, <code>useContext</code>, <code>useReducer</code>, <code>useEffect</code></p>
<p>Updated 2020 (focus on <code>useEffect()</code>): <a href="http://www.ruanyifeng.com/blog/2020/09/react-hooks-useeffect-tutorial.html">http://www.ruanyifeng.com/blog/2020/09/react-hooks-useeffect-tutorial.html</a></p>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title>Send batches of data creation requests to http server via Shell</title>
    <url>/2019/12/18/send%20quantity%20of%20http%20requests%20via%20shell/</url>
    <content><![CDATA[<p>In order to test the data pool volume, send over 60000 creation data to server.<br>Shell Script:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">a=1</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$a</span> -le 60000 ]; <span class="keyword">do</span>  <span class="comment"># start from 1, end by 60000</span></span><br><span class="line">    json=<span class="string">&quot;&#123;\&quot;areas\&quot;:[&#123;\&quot;new\&quot;:[58,60,57],\&quot;id\&quot;:\&quot;<span class="variable">$a</span>\&quot;, \&quot;center\&quot;:[-39,49],\&quot;name\&quot;:\&quot;$1<span class="variable">$a</span>\&quot;,\&quot;Version\&quot;:\&quot;1.0\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    a=$((a+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    curl -v -X POST -H <span class="string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span> -H <span class="string">&quot;Cookie: sessionId=_____&quot;</span> http://url -d <span class="string">&quot;<span class="variable">$json</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><strong>Mind the syntax especially the space, <code>&quot;&quot;</code> and <code>&#39;&#39;</code>, using <code>\</code> for escaping “” inside json to avoid syntax error.</strong></p>
<hr>
<h4 id="other-materials"><a href="#other-materials" class="headerlink" title="other materials:"></a>other materials:</h4><ol>
<li><a href="http://www.ruanyifeng.com/blog/2019/09/curl-reference.html">curl 的用法指南</a></li>
</ol>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Require JS - define模块定义</title>
    <url>/2019/07/25/require%20js%20-%20define%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p><strong>CMD (Common Module Definition)</strong><br>在 CMD 规范中，一个模块就是一个文件。代码的书写格式如下：<br>              <center><em>define(factory);</em></center><br>define 是一个全局函数，用来定义模块。</p>
<h3 id="1-factory为函数时，表示模块的构造方法："><a href="#1-factory为函数时，表示模块的构造方法：" class="headerlink" title="1. factory为函数时，表示模块的构造方法："></a>1. factory为函数时，表示模块的构造方法：</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span>, <span class="built_in">module</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 模块代码</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行该构造方法，可以得到模块向外提供的接口。<br>factory 为对象、字符串时，表示模块的接口就是该对象、字符串<br> <center><a id="more"></a></center></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(&#123; <span class="string">&quot;foo&quot;</span>: <span class="string">&quot;bar&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>也可以通过字符串定义模板模块:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="string">&#x27;I am a template. My name is &#123;&#123;name&#125;&#125;.&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-define-id-deps-factory"><a href="#2-define-id-deps-factory" class="headerlink" title="2. define(id, deps, factory?)"></a>2. define(id, deps, factory?)</h3><p>字符串 id 表示模块标识，数组 deps 是模块依赖</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="string">&#x27;hello&#x27;</span>, [<span class="string">&#x27;jquery&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span>, <span class="built_in">module</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 模块代码</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>factory参数可以省略。省略时，表示声明依赖关系。<br>在开发阶段，推荐不要手写 id 和 deps 参数，因为这两个参数可以在构建阶段通过工具自动生成。</p>
<!-- （？？？还没遇到可以自动生成的，接下来看看） -->
<p><em>注意：带 id 和 deps 参数的 define 用法不属于 CMD 规范，而属于 Modules/Transport 规范。</em></p>
<h3 id="3-require-Function"><a href="#3-require-Function" class="headerlink" title="3. require Function"></a>3. require Function</h3><p>require接受module-name(id)作为唯一参数，用来获取其他模块提供的接口</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取模块 a 的接口</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a&#x27;</span>);</span><br><span class="line">  <span class="comment">// 调用模块 a 的方法</span></span><br><span class="line">  a.doSomething();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="4-exports-Object"><a href="#4-exports-Object" class="headerlink" title="4. exports Object"></a>4. exports Object</h3><p>exports 是一个对象，用来向外提供模块接口。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对外提供 foo 属性</span></span><br><span class="line">  <span class="built_in">exports</span>.foo = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line">  <span class="comment">// 对外提供 doSomething 方法</span></span><br><span class="line">  <span class="built_in">exports</span>.doSomething = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>除了给<code>exports</code>对象增加成员，还可以使用<code>return</code>直接向外提供接口。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 通过 return 直接提供接口</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    foo: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">    doSomething: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="TBC"><a href="#TBC" class="headerlink" title="TBC"></a>TBC</h2><hr>
<p>ref:  <a href="https://blog.csdn.net/cpf506497746/article/details/8832317">https://blog.csdn.net/cpf506497746/article/details/8832317</a></p>
<!-- - - -
**AMD (Asynchronous Module Definition, 异步模块加载机制) 规范:\
define("module-name", [array-of-dependencies], module-factory-or-object);**

### 1. 定义一个模块
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(<span class="string">&quot;alpha&quot;</span>, [<span class="string">&quot;require&quot;</span>, <span class="string">&quot;exports&quot;</span>, <span class="string">&quot;beta&quot;</span>], <span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span>, beta</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.verb = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> beta.verb();</span><br><span class="line"></span><br><span class="line"><span class="comment">// or:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&quot;beta&quot;</span>).verb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上述代码定义了一个alpha模块，并且依赖于内置的require，exports模块，以及外部的beta模块。第三个参数为callback回调函数，可直接使用依赖模块，这里按依赖声明顺序作为参数提供给回调函数。</p>
<ul>
<li>这里的require函数让你能够随时去依赖一个模块，即取得模块的引用，从而即使模块没有作为参数定义，也能够被使用</li>
<li>exports是定义的alpha 模块的实体，在其上定义的任何属性和方法也就是alpha模块的属性和方法。通过exports.verb = … 为alpha模块定义了一个verb方法。例子中是简单调用了模块beta的verb方法。</li>
<li>module-name可以包含路径</li>
</ul>
<h3 id="2-匿名模块"><a href="#2-匿名模块" class="headerlink" title="2. 匿名模块"></a>2. 匿名模块</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define([<span class="string">&quot;alpha&quot;</span>], <span class="function"><span class="keyword">function</span> (<span class="params">alpha</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    verb: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> alpha.verb() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>无name即定义了一个匿名模块，此时模块文件的文件名作为id标识，例如若此模块文件放在a.js中，则a为module name，可在dependence中用”a”来调用，此条意义在于可调用不同文件中的module，避免功能反复实现</p>
<h3 id="3-仅有一个参数的define"><a href="#3-仅有一个参数的define" class="headerlink" title="3. 仅有一个参数的define"></a>3. 仅有一个参数的define</h3><ol>
<li>仅提供数据（相当于包含了一个完整JSON-P实现）<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define(&#123;</span><br><span class="line">  provinces:[</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">&#x27;上海&#x27;</span>,</span><br><span class="line">      areas: [<span class="string">&#x27;浦东&#x27;</span>, <span class="string">&#x27;徐汇&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">&#x27;江苏&#x27;</span>,</span><br><span class="line">      cities: [<span class="string">&#x27;南京&#x27;</span>, <span class="string">&#x27;南通&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//…</span></span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
把模块变成一个简单的数据对象，达到高度复用效果。<br>假设这个文件名为china.js，那么如果某个模块需要这个数据，只需要：<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define([<span class="string">&#x27;china&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params">china</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//在这里使用省市数据</span></span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>包含方法具有功能的一个对象<br>如果参数是一个函数，则在函数中，可以随时require自己需要的模块<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">define( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> p = <span class="built_in">require</span>(<span class="string">&#x27;china&#x27;</span>);</span><br><span class="line">  <span class="comment">// start to use china module</span></span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p>ref: <br><a href="https://blog.csdn.net/qq_16633405/article/details/77961539">https://blog.csdn.net/qq_16633405/article/details/77961539</a> –&gt;</p>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>Sequelize</title>
    <url>/2020/01/19/sequelize/</url>
    <content><![CDATA[<p>Sequelize 是一个基于 promise 的 Node.js ORM, 目前支持 Postgres, MySQL, SQLite 和 Microsoft SQL Server, 主要用来进行数据库和nodejs后端数据映射。<br>Docs: <a href="https://demopark.github.io/sequelize-docs-Zh-CN/">Sequelize Docs 中文版</a>(不全)  |  <a href="https://sequelize.org/master/">Official api docs</a></p>
<p>Here I only mark certain api I use most frequently.</p>
<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><h3 id="definition"><a href="#definition" class="headerlink" title="definition"></a>definition</h3><p>use <code>define</code> to map data model to table in db.<br><a name = "dataModel"></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">sequelize, DataTypes</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> Cell = sequelize.define(<span class="string">&quot;Cell&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">            id: &#123;</span><br><span class="line">                type: DataTypes.INTEGER,</span><br><span class="line">                primaryKey: <span class="literal">true</span>,</span><br><span class="line">                autoIncrement: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            type: &#123;</span><br><span class="line">                type: DataTypes.INTEGER,</span><br><span class="line">                defaultValue:<span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            name: &#123;</span><br><span class="line">                type: DataTypes.STRING(<span class="number">255</span>),</span><br><span class="line">                unique: <span class="string">&#x27;compositeIndex&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            timestamps: <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    Cell.getCells = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...function...</span><br><span class="line"></span><br><span class="line">    ...function...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>

<h3 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h3><ol>
<li>find</li>
</ol>
<ul>
<li><code>findByPk</code>, search element in db by <strong>primaryKey</strong> (usually id).<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Cell.findCell = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> cell = <span class="keyword">await</span> Cell.findByPk(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// or like</span></span><br><span class="line">Project.findByPk(<span class="number">123</span>).then(<span class="function"><span class="params">project</span> =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// project 将是 Project的一个实例,并具有在表中存为 id 123 条目的内容.</span></span><br><span class="line"><span class="comment">// 如果没有定义这样的条目,你将获得null</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><code>findOne</code>, search element in db by <strong>property</strong>.<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Cell.findCellByName = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> Cell.findOne(&#123;<span class="attr">where</span>: &#123;<span class="attr">name</span>: name&#125;&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// if multiple properties</span></span><br><span class="line">Project.findOne(&#123;</span><br><span class="line">  where: &#123;<span class="attr">title</span>: <span class="string">&#x27;aProject&#x27;</span>&#125;,</span><br><span class="line">  attributes: [<span class="string">&#x27;id&#x27;</span>, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;title&#x27;</span>]]</span><br><span class="line">&#125;).then(<span class="function"><span class="params">project</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// project 将是 Projects 表中 title 为 &#x27;aProject&#x27;  的第一个条目 || null</span></span><br><span class="line">  <span class="comment">// project.get(&#x27;title&#x27;) 将包含 project 的 name</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><code>findAndCountAll</code><a name = "findAndCountAll"></a> is a combination of <a href="#findAll"><code>findAll</code></a> and <a href="#count"><code>count</code></a>.It search db with conditions, return records with a data set (<code>rows</code>) and total count (<code>count</code>). Useful when you want to list data as a table, it provides with <code>limit</code> and <code>offset</code> in pagination.<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Project</span><br><span class="line">  .findAndCountAll(&#123;</span><br><span class="line">     where: &#123;</span><br><span class="line">        title: &#123;</span><br><span class="line">          [Op.like]: <span class="string">&#x27;foo%&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     offset: <span class="number">10</span>,</span><br><span class="line">     limit: <span class="number">2</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result.count);</span><br><span class="line">    <span class="built_in">console</span>.log(result.rows);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
Op = Operators. for more available Ops, see <a href="https://sequelize.org/master/manual/model-querying-basics.html#operators">https://sequelize.org/master/manual/model-querying-basics.html#operators</a> <br>it also support <code>include</code> to set limits of count, or construct <strong>left join</strong>:<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// only data with required attribute value equals to true will be counted</span></span><br><span class="line">User.findAndCountAll(&#123;</span><br><span class="line">    include: [</span><br><span class="line">       &#123; <span class="attr">model</span>: Profile, <span class="attr">required</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    limit: <span class="number">3</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// e.g. model Cells left join with model XXX.</span></span><br><span class="line">Cell.searchByNameAndPagination = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">offs, limits, attribute, order, name</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">let</span> cells = <span class="keyword">await</span> Cell.findAndCountAll(&#123;</span><br><span class="line">            include: [&#123;</span><br><span class="line">                model: XXX</span><br><span class="line">                <span class="comment">// right: true  // will turn to right join, only when required is false</span></span><br><span class="line">            &#125;],</span><br><span class="line">            where: where,</span><br><span class="line">            offset: offs,</span><br><span class="line">            limit: limits,</span><br><span class="line">            order: orderTmp</span><br><span class="line">    &#125;);</span><br><span class="line">    cells.rows = cells.rows.map(<span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</span><br><span class="line">        cell.dataValues.xxxname = cell.XXX ? cell.XXX.name : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">delete</span> cell.dataValues.XXX;</span><br><span class="line">        <span class="keyword">delete</span> cell.dataValues.xxxId;</span><br><span class="line">        <span class="keyword">return</span> cell.dataValues;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> cells;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>findAll</code><a name = "findAll"></a>, similar to above, without counting.</li>
</ul>
<ol start="2">
<li><p><code>create</code> <br>create a new obj in current model</p>
</li>
<li><p><code>count</code><a name = "count"></a> <br>normally use with <a href="#findAndCountAll"><code>findAndCountAll</code></a></p>
</li>
<li><p><code>min</code> / <code>max</code> / <code>sum</code> <br>return min/max/sum value with given attribute.</p>
</li>
<li><p><code>upsert</code> <br><a href="https://sequelize.org/master/class/lib/model.js~Model.html#static-method-upsert">ref</a>, Insert or update a single row. An update will be executed if a row which matches the supplied values on either the primary key or a unique key is found.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> Cell.upsert(&#123;</span><br><span class="line">      type: value.type,</span><br><span class="line">      name: value.name,</span><br><span class="line">      ...</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      successRecords.push(&#123;</span><br><span class="line">          value</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">exc</span>) </span>&#123;</span><br><span class="line">      failedRecords.push(&#123;</span><br><span class="line">          gis: value,</span><br><span class="line">          reason: exc.original</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>According to the <a href="#dataModel">data model</a> as above, this means the upsert will use <code>id</code> as the key to match, cuz id is the only attribute not changed in upsert.</p>
</li>
</ol>
]]></content>
      <categories>
        <category>basic</category>
      </categories>
      <tags>
        <tag>node.js</tag>
        <tag>backend</tag>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>WebUploader</title>
    <url>/2019/08/19/webUploader/</url>
    <content><![CDATA[<p>Using <a href="https://fex.baidu.com/webuploader/doc/index.html">WebUploader</a> as 3pp to upload files to system.</p>
<h3 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 仅包含了常用参数</span></span><br><span class="line"><span class="keyword">var</span> uploader = <span class="keyword">new</span> WebUploader.Uploader(&#123;</span><br><span class="line">    duplicate: <span class="literal">true</span>, <span class="comment">// 是否允许重复文件 default undefined</span></span><br><span class="line">    auto: <span class="literal">false</span>,  <span class="comment">// 选完文件后，是否自动上传</span></span><br><span class="line">    swf: <span class="string">&#x27;path_of_swf/Uploader.swf&#x27;</span>,  <span class="comment">// swf文件路径</span></span><br><span class="line">    server: <span class="string">&quot;/upload.html&quot;</span>, <span class="comment">// 文件接收服务端</span></span><br><span class="line">    pick: &#123; <span class="attr">id</span>: <span class="string">&quot;#uploadFile&quot;</span>, <span class="attr">innerHTML</span>: <span class="string">&quot;localImg&quot;</span> &#125;, <span class="comment">// 选择文件的按钮。可选</span></span><br><span class="line">    accept: &#123; <span class="comment">// sample, 只允许选择图片文件</span></span><br><span class="line">            title: <span class="string">&#x27;Images&#x27;</span>,</span><br><span class="line">            extensions: <span class="string">&#x27;gif,jpg,jpeg,bmp,png&#x27;</span>,</span><br><span class="line">            mimeTypes: <span class="string">&#x27;image/*&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    threads: <span class="number">1</span>, <span class="comment">// 线程数</span></span><br><span class="line">    fileSingleSizeLimit: <span class="number">2000</span>,  <span class="comment">// 单文件大小限制</span></span><br><span class="line">    fileNumLimit: <span class="number">10</span>,  <span class="comment">// 单次上传文件数量限制</span></span><br><span class="line">    fileSingleSizeLimit:  <span class="comment">// 验证单个文件大小是否超出限制, 超出则不允许加入队列</span></span><br><span class="line">    compress:<span class="literal">false</span>, <span class="comment">// 是否压缩上传</span></span><br><span class="line">    chunked: <span class="literal">true</span>, <span class="comment">// 是否要分片处理大文件上传, default false</span></span><br><span class="line">    chunkSize: <span class="number">5242880</span>, <span class="comment">// 如果要分片，分多大一片？ default 5242880 (5M)</span></span><br><span class="line">    chunkRetry: <span class="number">1</span>,  <span class="comment">// 如果某个分片由于网络问题出错，允许自动重传多少次？ default 2</span></span><br><span class="line">    threads: <span class="number">1</span>, <span class="comment">// 上传并发数。允许同时最大上传进程数 default 3</span></span><br><span class="line">    formData:&#123;&#125;, <span class="comment">// 文件上传请求的参数表，每次发送都会发送此对象中的参数</span></span><br><span class="line">    method: <span class="string">&#x27;GET&#x27;</span>,  <span class="comment">// POST or GET, default POST</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
 <center><a id="more"></a></center>

<h3 id="2-监听event"><a href="#2-监听event" class="headerlink" title="2. 监听event"></a>2. 监听event</h3><p>仅列举常用event</p>
<ul>
<li><strong>uploadAccept</strong><br>当某个文件上传到服务端响应后，会派送此事件来询问服务端响应是否有效。如果此事件handler返回值为false, 则此文件将派送server类型的uploadError事件<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">uploader.on(<span class="string">&#x27;uploadAccept&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">file, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (response.error) &#123;</span><br><span class="line">      <span class="built_in">this</span>.uploader.trigger(<span class="string">&#x27;uploadError&#x27;</span>, file, response.UserMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><strong>uploadSuccess</strong><br>当文件上传成功时触发（单文件上传成功）<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">uploader.on(<span class="string">&#x27;uploadSuccess&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>._saveSuccessHandler(file);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><strong>uploadError</strong><br>当文件上传出错时触发<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">uploader.on(<span class="string">&#x27;uploadError&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">file, reason</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> xhr = &#123;&#125;, responseJSON = &#123;&#125;;</span><br><span class="line">      responseJSON.UserMessage = reason;</span><br><span class="line">      xhr.status = <span class="number">500</span>;</span><br><span class="line">      xhr.responseJSON = responseJSON;</span><br><span class="line">      <span class="keyword">if</span> (reason) &#123;</span><br><span class="line">          createErrorDialog(xhr, <span class="number">500</span>, <span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.uploader.reset();  <span class="comment">// uploader重置</span></span><br><span class="line">      <span class="built_in">this</span>.submitBtn.removeAttribute(<span class="string">&#x27;disabled&#x27;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
For more details: <a href="https://www.jianshu.com/p/9f669deebf82">https://www.jianshu.com/p/9f669deebf82</a></li>
</ul>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>jquery</tag>
        <tag>WebUploader</tag>
      </tags>
  </entry>
  <entry>
    <title>shell grammar</title>
    <url>/2020/02/11/shell/</url>
    <content><![CDATA[<h3 id="gt-amp-gt-gt"><a href="#gt-amp-gt-gt" class="headerlink" title="&gt; &amp; &gt;&gt;"></a>&gt; &amp; &gt;&gt;</h3><ol>
<li><code>&gt;</code> 创建<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello shell&quot;</span> &gt; output.txt</span><br></pre></td></tr></table></figure></li>
<li><code>&gt;&gt;</code> 追加<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello shell&quot;</span> &gt;&gt; output.txt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当output.txt不存在时，两者都会创建一个新的output.txt；<br>当output.txt存在时，前者会清空并重新写入，后者怎会在末尾追加</p>
</blockquote>
</li>
</ol>
<p>ref: <a href="https://blog.csdn.net/nahanai/article/details/83861449">https://blog.csdn.net/nahanai/article/details/83861449</a></p>
<center><a id="more"></a></center>
---
###
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>cmd</tag>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>windows errors in daily use</title>
    <url>/2020/05/13/windows-error/</url>
    <content><![CDATA[<h3 id="Error1"><a href="#Error1" class="headerlink" title="Error1"></a>Error1</h3><ul>
<li><p>Steps to reproduce the error:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cp winpty.exe /usr/bin</span><br><span class="line">cp: cannot create regular file <span class="string">&#x27;/usr/bin/winpty.exe&#x27;</span>: Permission denied</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo cp winpty.exe /usr/bin</span><br><span class="line">bash: sudo: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ whoami</span><br><span class="line">eshibij</span><br></pre></td></tr></table></figure>
<p>As above I have already been a root user (no need to run with <code>sudo</code>), so the only answer for this error is that the destination directory <code>/usr/bin</code> does not exists. Check:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PS C:\Users\eshibij\Downloads\winpty-0.4.3-cygwin-2.8.0-x64\bin&gt; <span class="built_in">cd</span> /usr/bin</span><br><span class="line"><span class="built_in">cd</span> : Cannot find path <span class="string">&#x27;C:\usr\bin&#x27;</span> because it does not exist.</span><br></pre></td></tr></table></figure>
<center><a id="more"></a></center>
</li>
<li><p>Solution: give up coping this file.</p>
</li>
</ul>
<h3 id="Error2"><a href="#Error2" class="headerlink" title="Error2"></a>Error2</h3><ul>
<li><p>Steps to reproduce the error:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it &lt;pod&gt; bash</span><br><span class="line">Unable to use a TTY - input is not a terminal or the right kind of file</span><br></pre></td></tr></table></figure></li>
<li><p>Solution: <br>download <code>winpyt.exe</code> file from <a href="https://github.com/rprichard/winpty/releases">https://github.com/rprichard/winpty/releases</a> and do the copy it to <code>/usr/bin</code></p>
<blockquote>
<p><strong>Note</strong>: do not use <code>winpty-0.4.3-cygwin-2.8.0-ia32.tar.gz</code> as the above link provided, cuz it will cause new issues missing ddl: <code>C:/Program Files/Git/usr/bin/winpty.exe: error while loading shared libraries: cygwin1.dll: cannot open shared object file: No such file or directory</code>. <br>Using the other version <code>winpty-0.4.3-msys2-2.7.0-x64.tar.gz</code></p>
</blockquote>
<p>After install <code>winpty</code>, you can use <code>winpty kubectl exec -it &lt;pod&gt; -c &lt;container&gt; sh</code> to access containers inside pods.</p>
</li>
</ul>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>cmd</tag>
        <tag>bash</tag>
        <tag>powershell</tag>
      </tags>
  </entry>
  <entry>
    <title>Errors encountered in using k8s</title>
    <url>/2020/04/08/k8s-errors/</url>
    <content><![CDATA[<p>This is a record in deploying k8s in work stage.</p>
<h2 id="Issue-1-failed-to-schedule-pod-for-not-running-“VolumeBinding”-filter-plugin"><a href="#Issue-1-failed-to-schedule-pod-for-not-running-“VolumeBinding”-filter-plugin" class="headerlink" title="Issue 1: failed to schedule pod for not running “VolumeBinding” filter plugin"></a>Issue 1: failed to schedule pod for not running “VolumeBinding” filter plugin</h2><p>describe pod:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                 From               Message</span><br><span class="line">  ----     ------            ----                ----               -------</span><br><span class="line">  Warning  FailedScheduling  55s (x19 over 26m)  default-scheduler  error while running &quot;VolumeBinding&quot; filter plugin for pod &quot;eri-cec-9dcd4d6c8-whvrm&quot;: pod has unbound immediate PersistentVolumeClaims</span><br></pre></td></tr></table></figure>
<p>check pod specs by <code>kubectl edit pod &lt;pod-name&gt;</code>:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cec-database</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">claimName:</span> <span class="string">eri-cec-database-pvc</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cec-misc</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">claimName:</span> <span class="string">eri-cec-misc-pvc</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-token-pxxg8</span></span><br><span class="line">  <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">default-token-pxxg8</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2020-04-08T01:58:02Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;error while running &quot;VolumeBinding&quot; filter plugin for pod &quot;eri-cec-9dcd4d6c8-whvrm&quot;:</span></span><br><span class="line"><span class="string">      pod has unbound immediate PersistentVolumeClaims&#x27;</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Unschedulable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Pending</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>
<p>The two persistentVolumeClaims were set during <code>helm install</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm install -n eri .&#x2F;cec-release-1.0.0.tgz \</span><br><span class="line">&gt; --set persistence.enabled&#x3D;true \</span><br><span class="line">&gt; --set persistence.storageClass&#x3D;nfs \</span><br><span class="line">&gt; --set persistence.database.size&#x3D;5Gi \</span><br><span class="line">&gt; --set persistence.miscellaneous.size&#x3D;5Gi \</span><br><span class="line">&gt; --set ingress.cecManager.hostName&#x3D;dual-test \</span><br><span class="line">&gt; --set ingress.cecApi.hostName&#x3D;dual-api</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NAME:   eri</span><br><span class="line">LAST DEPLOYED: Wed Apr  8 09:58:00 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">RESOURCES:</span><br><span class="line">&#x3D;&#x3D;&gt; v1&#x2F;Deployment</span><br><span class="line">NAME     AGE</span><br><span class="line">eri-cec  1s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&gt; v1&#x2F;PersistentVolumeClaim</span><br><span class="line">NAME                  AGE</span><br><span class="line">eri-cec-database-pvc  2s</span><br><span class="line">eri-cec-misc-pvc      2s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&gt; v1&#x2F;Pod(related)</span><br><span class="line">NAME                     AGE</span><br><span class="line">eri-cec-9dcd4d6c8-whvrm  1s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&gt; v1&#x2F;Secret</span><br><span class="line">NAME                     AGE</span><br><span class="line">eri-cec-database-secret  2s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&gt; v1&#x2F;Service</span><br><span class="line">NAME     AGE</span><br><span class="line">eri-cec  1s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&gt; v1beta1&#x2F;Ingress</span><br><span class="line">NAME             AGE</span><br><span class="line">eri-cec-ingress  1s</span><br></pre></td></tr></table></figure>
<p>=========================solution========================= <br>Refers:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/60774220/kubernetes-pod-has-unbound-immediate-persistentvolumeclaims">https://stackoverflow.com/questions/60774220/kubernetes-pod-has-unbound-immediate-persistentvolumeclaims</a></li>
<li><a href="https://blog.csdn.net/oguro/article/details/96964440">https://blog.csdn.net/oguro/article/details/96964440</a></li>
<li><a href="https://blog.csdn.net/liumiaocn/article/details/103388607">https://blog.csdn.net/liumiaocn/article/details/103388607</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/</a> <br>From above info, there is something wrong with PVC (PersistentVolumeClaims), which leaves state “unbound”. The PVC should be bound to certain PV (PersistentVolume) which has enough capacity to hold the binding PVC. <br>check PVCs and PVs:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl get pvc -A</span><br><span class="line">NAMESPACE   NAME                      STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">cec         eri-sh-cec-database-pvc   Pending                                      nfs            125m</span><br><span class="line">cec         eri-sh-cec-misc-pvc       Pending                                      nfs            125m</span><br><span class="line">default     eri-cec-database-pvc      Pending                                      nfs            3h22m</span><br><span class="line">default     eri-cec-misc-pvc          Pending                                      nfs            3h22m</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl get pv -A</span><br><span class="line">No resources found</span><br></pre></td></tr></table></figure>
There is no PV on current node-63, thus I create two PVs for db-pvc and misc-pvc.<br>Make a directory for PVs first:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 mnt]# sudo mkdir &#x2F;mnt&#x2F;data</span><br></pre></td></tr></table></figure>
check permission and capacity the PVC need:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl edit pvc eri-sh-cec-database-pvc -n cec</span><br><span class="line">...</span><br><span class="line">accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br></pre></td></tr></table></figure>
vi pv-init.yaml:<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">eri-sh-cec-database-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eri-sh-cec-database-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">eri-sh-cec-misc-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eri-sh-cec-misc-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl apply -f pv-init.yaml</span><br><span class="line">persistentvolume&#x2F;eri-sh-cec-database-pv created</span><br><span class="line">persistentvolume&#x2F;eri-sh-cec-misc-pv created</span><br><span class="line">[root@host63 cec-installer]# kubectl get pv -A</span><br><span class="line">NAME                     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">eri-sh-cec-database-pv   5Gi        RWO,RWX        Retain           Available                                   15s</span><br><span class="line">eri-sh-cec-misc-pv       5Gi        RWO,RWX        Retain           Available                                   15s</span><br></pre></td></tr></table></figure>
PVC still not work, check its status:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl describe pvc eri-sh-cec-database-pvc -n cec</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                Age                   From                                                                                                                                Message</span><br><span class="line">  ----     ------                ----                  ----                                                                                                                                -------</span><br><span class="line">  Warning  ProvisioningFailed    54m (x3 over 104m)    cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner_nfs-provisioner-nfs-server-provisioner-0_79370fad-78b7-11ea-8b82-66556e93189d  failed to provision volume with StorageClass &quot;nfs&quot;: error getting NFS server IP for volume: service SERVICE_NAME&#x3D;nfs-provisioner-nfs-server-provisioner is not valid; check that it has for ports map[&#123;111 UDP&#125;:true &#123;111 TCP&#125;:true &#123;2049 TCP&#125;:true &#123;20048 TCP&#125;:true] exactly one endpoint, this pod&#39;s IP POD_IP&#x3D;192.168.220.144</span><br><span class="line">  Warning  ProvisioningFailed    38m (x8 over 3h6m)    cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner_nfs-provisioner-nfs-server-provisioner-0_79370fad-78b7-11ea-8b82-66556e93189d  failed to provision volume with StorageClass &quot;nfs&quot;: error getting NFS server IP for volume: service SERVICE_NAME&#x3D;nfs-provisioner-nfs-server-provisioner is not valid; check that it has for ports map[&#123;2049 TCP&#125;:true &#123;20048 TCP&#125;:true &#123;111 UDP&#125;:true &#123;111 TCP&#125;:true] exactly one endpoint, this pod&#39;s IP POD_IP&#x3D;192.168.220.144</span><br><span class="line">  Normal   Provisioning          21m (x16 over 3h6m)   cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner_nfs-provisioner-nfs-server-provisioner-0_79370fad-78b7-11ea-8b82-66556e93189d  External provisioner is provisioning volume for claim &quot;cec&#x2F;eri-sh-cec-database-pvc&quot;</span><br><span class="line">  Warning  ProvisioningFailed    21m (x2 over 3h4m)    cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner_nfs-provisioner-nfs-server-provisioner-0_79370fad-78b7-11ea-8b82-66556e93189d  failed to provision volume with StorageClass &quot;nfs&quot;: error getting NFS server IP for volume: service SERVICE_NAME&#x3D;nfs-provisioner-nfs-server-provisioner is not valid; check that it has for ports map[&#123;111 TCP&#125;:true &#123;2049 TCP&#125;:true &#123;20048 TCP&#125;:true &#123;111 UDP&#125;:true] exactly one endpoint, this pod&#39;s IP POD_IP&#x3D;192.168.220.144</span><br><span class="line">  Normal   ExternalProvisioning  87s (x742 over 3h6m)  persistentvolume-controller                                                                                                         waiting for a volume to be created, either by external provisioner &quot;cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner&quot; or manually created by system administrator</span><br></pre></td></tr></table></figure>
<strong>Did not figure out</strong></li>
</ul>
<hr>
<hr>
<h2 id="Issue-2-The-deployed-pod-without-nfs-would-use-ipv4-as-default-and-service-nginx-ingress-will-use-ipv4-address-as-default-route-cannot-change-it"><a href="#Issue-2-The-deployed-pod-without-nfs-would-use-ipv4-as-default-and-service-nginx-ingress-will-use-ipv4-address-as-default-route-cannot-change-it" class="headerlink" title="Issue 2. The deployed pod (without nfs) would use ipv4 as default, and service nginx-ingress will use ipv4 address as default route, cannot change it."></a>Issue 2. The deployed pod (without nfs) would use ipv4 as default, and service <code>nginx-ingress</code> will use ipv4 address as default route, cannot change it.</h2><p>log nginx-ingress:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# kubectl logs nginx-ingress-controller-64d58897bd-b99gw</span><br><span class="line">  -------------------------------------------------------------------------------</span><br><span class="line">  NGINX Ingress controller</span><br><span class="line">    Release:       0.29.0</span><br><span class="line">    Build:         git-eedcdcdbf</span><br><span class="line">    Repository:    https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;ingress-nginx</span><br><span class="line">    nginx version: nginx&#x2F;1.17.8</span><br><span class="line">  -------------------------------------------------------------------------------</span><br><span class="line">  I0407 10:17:14.810155       8 flags.go:215] Watching for Ingress class: nginx</span><br><span class="line">  W0407 10:17:14.811042       8 flags.go:260] SSL certificate chain completion is disabled (--enable-ssl-chain-completion&#x3D;false)</span><br><span class="line">  W0407 10:17:14.811123       8 client_config.go:543] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">  I0407 10:17:14.811367       8 main.go:193] Creating API client for https:&#x2F;&#x2F;192.167.0.1:443</span><br><span class="line">  I0407 10:17:14.820212       8 main.go:237] Running in Kubernetes cluster version v1.17 (v1.17.4) - git (clean) commit 8d8aa39598534325ad77120c120a22b3a990b5ea - platform linux&#x2F;amd64</span><br><span class="line">  I0407 10:17:14.823302       8 main.go:91] Validated default&#x2F;nginx-ingress-default-backend as the default backend.</span><br><span class="line">  I0407 10:17:15.126113       8 main.go:102] SSL fake certificate created &#x2F;etc&#x2F;ingress-controller&#x2F;ssl&#x2F;default-fake-certificate.pem</span><br><span class="line">  W0407 10:17:15.147723       8 store.go:657] Unexpected error reading configuration configmap: configmaps &quot;nginx-ingress-controller&quot; not found</span><br><span class="line">  I0407 10:17:15.156374       8 nginx.go:263] Starting NGINX Ingress controller</span><br><span class="line">  I0407 10:17:16.357204       8 nginx.go:307] Starting NGINX process</span><br><span class="line">  I0407 10:17:16.357338       8 leaderelection.go:242] attempting to acquire leader lease  default&#x2F;ingress-controller-leader-nginx...</span><br><span class="line">  W0407 10:17:16.358186       8 controller.go:394] Service &quot;default&#x2F;nginx-ingress-default-backend&quot; does not have any active Endpoint</span><br><span class="line">  I0407 10:17:16.358304       8 controller.go:137] Configuration changes detected, backend reload required.</span><br><span class="line">  I0407 10:17:16.360127       8 status.go:86] new leader elected: nginx-ingress-controller-64d58897bd-cthrs</span><br><span class="line">  I0407 10:17:16.450895       8 controller.go:153] Backend successfully reloaded.</span><br><span class="line">  I0407 10:17:16.450966       8 controller.go:162] Initial sync, sleeping for 1 second.</span><br><span class="line">  W0407 10:17:20.280746       8 controller.go:394] Service &quot;default&#x2F;nginx-ingress-default-backend&quot; does not have any active Endpoint</span><br><span class="line">  W0407 10:17:23.614240       8 controller.go:394] Service &quot;default&#x2F;nginx-ingress-default-backend&quot; does not have any active Endpoint</span><br><span class="line">  W0407 10:17:33.458971       8 controller.go:394] Service &quot;default&#x2F;nginx-ingress-default-backend&quot; does not have any active Endpoint</span><br><span class="line">  I0407 10:17:53.811527       8 leaderelection.go:252] successfully acquired lease default&#x2F;ingress-controller-leader-nginx</span><br><span class="line">  I0407 10:17:53.811566       8 status.go:86] new leader elected: nginx-ingress-controller-64d58897bd-b99gw</span><br><span class="line">  W0407 10:18:00.868971       8 controller.go:394] Service &quot;default&#x2F;nginx-ingress-default-backend&quot; does not have any active Endpoint</span><br><span class="line">  I0408 03:14:30.743173       8 event.go:281] Event(v1.ObjectReference&#123;Kind:&quot;Ingress&quot;, Namespace:&quot;cec&quot;, Name:&quot;eri-sh-cec-ingress&quot;, UID:&quot;dd298fd3-3c16-42e8-a544-c7f942ec4e3e&quot;, APIVersion:&quot;networking.k8s.io&#x2F;v1beta1&quot;, ResourceVersion:&quot;211359&quot;, FieldPath:&quot;&quot;&#125;): type: &#39;Normal&#39; reason: &#39;CREATE&#39; Ingress cec&#x2F;eri-sh-cec-ingress</span><br><span class="line">  W0408 03:14:34.068588       8 controller.go:921] Service &quot;default&#x2F;eri-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:34.068631       8 controller.go:921] Service &quot;default&#x2F;eri-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:34.068648       8 controller.go:921] Service &quot;cec&#x2F;eri-sh-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:34.068661       8 controller.go:921] Service &quot;cec&#x2F;eri-sh-cec&quot; does not have any active Endpoint.</span><br><span class="line">  I0408 03:14:53.817883       8 status.go:274] updating Ingress cec&#x2F;eri-sh-cec-ingress status from [] to [&#123;10.136.40.63 &#125;]</span><br><span class="line">  I0408 03:14:53.820045       8 event.go:281] Event(v1.ObjectReference&#123;Kind:&quot;Ingress&quot;, Namespace:&quot;cec&quot;, Name:&quot;eri-sh-cec-ingress&quot;, UID:&quot;dd298fd3-3c16-42e8-a544-c7f942ec4e3e&quot;, APIVersion:&quot;networking.k8s.io&#x2F;v1beta1&quot;, ResourceVersion:&quot;211445&quot;, FieldPath:&quot;&quot;&#125;): type: &#39;Normal&#39; reason: &#39;UPDATE&#39; Ingress cec&#x2F;eri-sh-cec-ingress</span><br><span class="line">  W0408 03:14:53.820285       8 controller.go:921] Service &quot;default&#x2F;eri-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:53.820310       8 controller.go:921] Service &quot;default&#x2F;eri-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:53.820326       8 controller.go:921] Service &quot;cec&#x2F;eri-sh-cec&quot; does not have any active Endpoint.</span><br><span class="line">  W0408 03:14:53.820341       8 controller.go:921] Service &quot;cec&#x2F;eri-sh-cec&quot; does not have any active Endpoint.</span><br></pre></td></tr></table></figure>
<p>Solved the problem of product service using default ipv4 as cluster-ip by adding new paras in helm deployment charts:</p>
<ul>
<li><code>ipFamily:</code> below <code>service:</code> in <code>values.yaml</code></li>
<li><pre><code class="yaml"><span class="attr">ipFamily:</span> <span class="string">&#123;&#123;.Values.service.ipFamily&#125;&#125;</span>
<span class="string"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  below &#96;spec:&#96; in &#96;service.yaml&#96;</span><br><span class="line">  - &#96;--set service.ipFamily&#x3D;IPv6&#96; when helm install product</span><br><span class="line"></span><br><span class="line">**Solution:**</span><br><span class="line">Modify helm chart before installing ingress, in &#96;value.yaml&#96;, config:</span><br><span class="line">&#96;&#96;&#96;yaml</span><br><span class="line">hostNetwork: true</span><br><span class="line">reportNodeInternalIp: true</span><br><span class="line">daemonset:</span><br><span class="line">  useHostPort: true</span><br><span class="line">kind: DaemonSet</span><br></pre></td></tr></table></figure></span>
<span class="string">you</span> <span class="string">can</span> <span class="string">also</span> <span class="string">set</span> <span class="string">service</span> <span class="string">type</span> <span class="string">and</span> <span class="string">external_IP</span> <span class="string">here.</span>
<span class="string">After</span> <span class="string">helm</span> <span class="string">install,</span> <span class="string">check</span> <span class="string">if</span> <span class="string">you</span> <span class="string">can</span> <span class="string">visit</span> <span class="string">service</span> <span class="string">using</span> <span class="string">hostname</span> <span class="string">via</span> <span class="string">host-ip.</span>
<span class="string"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# curl http:&#x2F;&#x2F;dual-ipv6:80</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">[root@host63 cec-installer]# curl http:&#x2F;&#x2F;dual-ipv4:80</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure></span>
<span class="string">also</span> <span class="string">check</span> <span class="string">with</span> <span class="string">client</span> <span class="string">UI.</span>
</code></pre>
</li>
</ul>
<hr>
<hr>
<h2 id="Issue-3-Failed-to-init-tiller-pod-creating-error-rpc-error-code-DeadlineExceeded-desc-context-deadline-exceeded"><a href="#Issue-3-Failed-to-init-tiller-pod-creating-error-rpc-error-code-DeadlineExceeded-desc-context-deadline-exceeded" class="headerlink" title="Issue 3. Failed to init tiller, pod creating error: rpc error: code = DeadlineExceeded desc = context deadline exceeded"></a>Issue 3. Failed to init tiller, pod creating error: rpc error: code = DeadlineExceeded desc = context deadline exceeded</h2><p>pod hang on state <code>ContainerCreating</code> after doing helm init. describe pod:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host59 ~]# kubectl describe -n kube-system pod tiller-deploy-969865475-sn2k2</span><br><span class="line">Name:           tiller-deploy-969865475-sn2k2</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Node:           host59&#x2F;2001:1b74:88:9400::59:59</span><br><span class="line">Controlled By:  ReplicaSet&#x2F;tiller-deploy-969865475</span><br><span class="line">Containers:</span><br><span class="line">  tiller:</span><br><span class="line">    Container ID:   </span><br><span class="line">    Image:          gcr.io&#x2F;kubernetes-helm&#x2F;tiller:v2.16.1</span><br><span class="line">    Image ID:       </span><br><span class="line">    Ports:          44134&#x2F;TCP, 44135&#x2F;TCP</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                  Age                   From               Message</span><br><span class="line">  Normal   Scheduled               54m                   default-scheduler  Successfully assigned kube-system&#x2F;tiller-deploy-969865475-sn2k2 to host59</span><br><span class="line">  Warning  FailedCreatePodSandBox  2m47s (x13 over 50m)  kubelet, host59    Failed to create pod sandbox: rpc error: code &#x3D; DeadlineExceeded desc &#x3D; context deadline exceeded</span><br><span class="line">  Normal   SandboxChanged          2m47s (x13 over 50m)  kubelet, host59    Pod sandbox changed, it will be killed and re-created.</span><br></pre></td></tr></table></figure>
<p>check docker containers, which is already running, so there must be something wrong with docker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host59 ~]# systemctl status kubelet -l</span><br><span class="line">Apr 17 17:25:27 host59 kubelet[19205]: E0417 17:25:27.660517   19205 dns.go:135] Nameserver limits were exceeded, some nameservers have been omitted, the applied nameserver line is: 10.221.16.11 10.221.16.10 150.236.34.180</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host59 ~]# journalctl -u  kubelet -f</span><br><span class="line">Apr 17 17:27:18 host59 kubelet[19205]: E0417 17:27:18.262418   19205 cni.go:385] Error deleting kube-system_tiller-deploy-969865475-sn2k2&#x2F;f35df2a630d07b0ec7149fb06d7216c60a3c77a7118924c7b7eb9556b02f5cab from network multus&#x2F;multus-cni-network: netplugin failed with no error message</span><br><span class="line">Apr 17 17:27:18 host59 kubelet[19205]: W0417 17:27:18.263092   19205 cni.go:331] CNI failed to retrieve network namespace path: Error: No such container: beb6e83c61bc47ba808dcc51e6c76e89817efb1f518fe28bc1083c99ad4721e1</span><br><span class="line">Apr 17 17:27:19 host59 kubelet[19205]: E0417 17:27:19.660435   19205 dns.go:135] Nameserver limits were exceeded, some nameservers have been omitted, the applied nameserver line is: 10.221.16.11 10.221.16.10 150.236.34.180</span><br></pre></td></tr></table></figure>
<p>So the <code>multus</code> pod/container is not running correctly. Check the pod:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host59 ~]# kubectl describe pod  -n kube-system pod kube-multus-ds-amd64-wz5xj</span><br><span class="line">Name:         kube-multus-ds-amd64-wz5xj</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Node:         host59&#x2F;2001:1b74:88:9400::59:59</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                    From             Message</span><br><span class="line">  Warning  DNSConfigForming  117s (x291 over 6h7m)  kubelet, host59  Nameserver limits were exceeded, some nameservers have been omitted, the applied nameserver line is: 10.221.16.11 10.221.16.10 150.236.34.180</span><br><span class="line">Error from server (NotFound): pods &quot;pod&quot; not found</span><br></pre></td></tr></table></figure>
<p>Delete pod kube-mutlus:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl delete -f multus-daemonset.yml</span><br></pre></td></tr></table></figure>
<p>still not work, edit deployment find:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host59 opt]# kubectl edit deploy tiller-deploy -n kube-system</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2020-04-20T01:53:55Z&quot;</span><br><span class="line">    lastUpdateTime: &quot;2020-04-20T01:53:55Z&quot;</span><br><span class="line">    message: Deployment does not have minimum availability.</span><br><span class="line">    reason: MinimumReplicasUnavailable</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Available</span><br><span class="line">  - lastTransitionTime: &quot;2020-04-20T02:03:56Z&quot;</span><br><span class="line">    lastUpdateTime: &quot;2020-04-20T02:03:56Z&quot;</span><br><span class="line">    message: ReplicaSet &quot;tiller-deploy-b747845f&quot; has timed out progressing.</span><br><span class="line">    reason: ProgressDeadlineExceeded</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Progressing</span><br><span class="line">  observedGeneration: 1</span><br><span class="line">  replicas: 1</span><br><span class="line">  unavailableReplicas: 1</span><br><span class="line">  updatedReplicas: 1</span><br></pre></td></tr></table></figure>
<p>Finally find the reason: mutlus is not compatible with calico, thus <code>Error deleting kube-system_tiller-deploy... from network multus/multus-cni-network: netplugin failed with no error message</code> happened as above. Even if I delete mutlus before, it has already been configured in etcd config file under /etc/kubernetes. So modify related config and the tiller pod will turn to normal.</p>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Support ipv6/dualStack in K8s</title>
    <url>/2020/03/20/k8s-ipv6-dualstack-support/</url>
    <content><![CDATA[<p><strong>记录惊天巨坑enable ipv6 and dual stack for our product，从k8s安装开始</strong></p>
<p><em>0. 原来产品是本地安装测试的，仅支持ipv4安装很简便，但这次要求支持ipv6/dualStack，根据<a href="https://kubernetes.io/docs/concepts/services-networking/dual-stack/">官网文档</a>，我们需要1.16版本以上的kubernetes，<code>kubectl version</code>查看本地版本:</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Client Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.8&quot;</span>, GitCommit:<span class="string">&quot;211047e9a1922595eaa3a1127ed365e9299a6c23&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-10-15T12:11:03Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.10&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;windows/amd64&quot;</span>&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.8&quot;</span>, GitCommit:<span class="string">&quot;211047e9a1922595eaa3a1127ed365e9299a6c23&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-10-15T12:02:12Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.10&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p><em>1.14。。赶紧查docker desktop自带的kubernetes怎么更新，发现<a href="https://monkeywie.github.io/2019/09/16/k8s-update-operate/">要写deploy</a>测试或者<a href="https://www.cnblogs.com/lonelyxmas/p/10670477.html">重装k8s?</a> 感觉不适用。因为这是docker自带的不知道重装会不会有别的影响。决定直接装到我们组的remote server上，这样测试也可以一步到位。</em></p>
<center><a id="more"></a></center>

<ol>
<li>登上remote server发现第二个坑，机子连不了外网。。。连yum install都必须自己配置本地yum repo…一开始是想自己再装一个能连外网的虚拟机，把docker和k8s下载下来打好包再transfer到remote server上。</li>
</ol>
<ul>
<li>setup redhat7 to local vm: <br><em>error when setup vm</em>: <code>VT-x is not available (VERR_VMX_NO_VMX)</code><br><em>solution</em>: <a href="https://blog.csdn.net/imilano/article/details/83038682">https://blog.csdn.net/imilano/article/details/83038682</a>  (note: this action will affect the auto-start of docker)</li>
<li>enable the subscription before downloading docker:<br><a href="https://blog.csdn.net/yl_1314/article/details/52044022">https://blog.csdn.net/yl_1314/article/details/52044022</a></li>
</ul>
<ol start="2">
<li>不太行，改用这个: <a href="https://github.com/wxdlong/ok8s">https://github.com/wxdlong/ok8s</a> <br>把包下到本地再放到60上</li>
</ol>
<ul>
<li><p>before downloading, need change user permission level on docker. run command with:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export MSYS_NO_PATHCONV&#x3D;1</span><br></pre></td></tr></table></figure>
<p>then add local user to group “docker-users”, “Hyper-V Administrators”,” Remote Desktop Users”,”Remote Management Users”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PS H:\&gt; net localgroup docker-users ERICSSON\&lt;eid&gt; &#x2F;add</span><br><span class="line">System error 1378 has occurred.</span><br><span class="line">The specified account name is already a member of the group.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PS H:\&gt; net localgroup &quot;Hyper-V Administrators&quot; ERICSSON\&lt;eid&gt; &#x2F;add</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PS H:\&gt; net localgroup &quot;Remote Desktop Users&quot; ERICSSON\&lt;eid&gt; &#x2F;add</span><br><span class="line">System error 1378 has occurred.</span><br><span class="line">The specified account name is already a member of the group.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PS H:\&gt; net localgroup &quot;Remote Management Users&quot; ERICSSON\&lt;eid&gt; &#x2F;add</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure></li>
<li><p>check shared docker in DockerDesktop<br><img src="https://res.cloudinary.com/elizashi/image/upload/v1584431386/gitblog/posts/linux-docker-k8s/docker-desktop-share_p0z97p.png" alt="alt"><br><em>If still can’t see the volume, relogon PC, sec, and reset credentials.</em></p>
</li>
<li><p>download packages to local folder <code>download</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --rm -v <span class="string">&#x27;//c//Users//&lt;eid&gt;//download:/ok8s&#x27;</span> registry.cn-hangzhou.aliyuncs.com/wxdlong/ok8s:v1.16.3</span><br></pre></td></tr></table></figure>
<p>接下来就是把这个folder copy到host server上按教程往下走。</p>
</li>
</ul>
<ol start="2">
<li>配置k8s和docker过程中遇到的<strong>错误</strong></li>
</ol>
<ul>
<li><p><code>kubectl cluster-info</code> return <br>[error] <code>The connection to the server localhost:8080 was refused - did you specify the right host or port?</code></p>
<ul>
<li><a href="https://blog.csdn.net/wzygis/article/details/91354870">https://blog.csdn.net/wzygis/article/details/91354870</a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>包里缺少<strong>flannel插件</strong>,自行安装</p>
<ul>
<li><p>Copy <code>/etc/kubernetes/admin.conf</code> to <code>$HOME/.kube/</code>(on windows, on host server we just use <code>/root</code>)：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ~]# mkdir -p &#x2F;root&#x2F;.kube</span><br><span class="line">[root@192-168-1-61 .kube]# cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf &#x2F;root&#x2F;.kube&#x2F;config</span><br><span class="line">[root@192-168-1-61 .kube]# ls -ltr &#x2F;root&#x2F;.kube&#x2F;</span><br><span class="line">total 8</span><br><span class="line">  -rw-------. 1 root root 5448 Mar 17 21:33 config</span><br></pre></td></tr></table></figure>
<p><em>这一步可能是多余的，因为上面第一个错误已经export过路径了</em></p>
<p>check pod status</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ok8s]# kubectl get pods -A</span><br><span class="line">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-5644d7b6d9-5sp86                    0&#x2F;1     Pending   0          15h</span><br><span class="line">kube-system   coredns-5644d7b6d9-qjfz9                    0&#x2F;1     Pending   0          15h</span><br><span class="line">kube-system   etcd-192-168-1-61.maas                      1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-apiserver-192-168-1-61.maas            1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-controller-manager-192-168-1-61.maas   1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-flannel-ds-amd64-vx4bw                 1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-proxy-h4gdc                            1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-scheduler-192-168-1-61.maas            1&#x2F;1     Running   0          15h</span><br></pre></td></tr></table></figure>
<p>According to above result, the core DNS service is not started successfully.</p>
</li>
<li><p>flannel still not work, check <code>tail -f /var/log/messages</code> found <code>Unable to update cni config: no valid networks found in /etc/cni/net.d</code> + <code>[fork/exec /opt/ok8s/cni/flannel: permission denied fork/exec /opt/ok8s/cni/portmap: permission denied]</code> <br>go to folder <code>cd /opt/ok8s/cni/</code> and run <code>chmod +x *</code>. <br><em>tip: 无权限文件一般是白字，像上面这样授予全部权限会变为绿色，chmod 777 会把文件变为灰底</em></p>
</li>
<li><p>再次<code>kubectl get pods -A</code>可以看到两个core-dns node已经跑起来了</p>
</li>
</ul>
</li>
<li><p><strong>安装dashboard</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ok8s]# kubectl get pods -A</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-76585494d8-qb5mw   1&#x2F;1     Running            0          101m</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-5996555fd8-88qz6        0&#x2F;1     ImagePullBackOff   0          101m</span><br></pre></td></tr></table></figure>
<p>这里pull image失败了，看了下应该是因为host server不能连外网，dashboard没大用处，这步暂时跳过</p>
</li>
<li><p>更换network插件为<strong>calico</strong> <br>装完flannel发现它还<a href="https://github.com/coreos/flannel/issues/248">没支持ipv6</a>，我人傻了，只好重新安装calico，先存一下calico支持<a href="https://docs.projectcalico.org/networking/ipv6">ipv6</a> | <a href="https://docs.projectcalico.org/networking/dual-stack">dual-stack</a>的官方文档, 以及<a href="https://shouneng.website/2019/08/23/zai-kubernetes-zhong-zheng-que-di-an-zhuang-calico/">非常详细的中文安装教程</a></p>
<ul>
<li><p><code>kubeadm reset</code>后更改pod-network-cidr，重新init cluster:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ok8s]# kubeadm init --v&#x3D;7 --pod-network-cidr&#x3D;192.168.0.0&#x2F;16 --kubernetes-version&#x3D;v1.16.3</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Calico作为CNI插件安装。必须通过传递–network-plugin=cni参数将kubelet配置为使用CNI网络, 这里–pod-network-cidr=192.168.0.0就是是用来给 controller-manager 用作自动分配pod子网 (用作给每个node上的pod分配IP address)</p>
</blockquote>
</li>
<li><p>follow this <a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">official doc</a></p>
</li>
<li><p>由于不能连外网导致image pull不下来，手动下载过去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kube-system   calico-node-vcbmc     0&#x2F;1     Init:ImagePullBackOff   0     9m12s</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 nodeagent~uds]# kubectl describe pods calico-node-vcbmc -n kube-system</span><br><span class="line">Events:</span><br><span class="line">Type     Reason     Age                     From                        Message</span><br><span class="line">Normal   Scheduled  9m44s                   default-scheduler           Successfully assigned kube-system&#x2F;calico-node-vcbmc to 192-168-1-61.maas</span><br><span class="line">Warning  Failed     9m3s                    kubelet, 192-168-1-61.maas  Failed to pull image &quot;calico&#x2F;cni:v3.13.1&quot;: rpc error: code &#x3D; Unknown desc &#x3D; Error response from daemon: Get https:&#x2F;&#x2F;registry-1.docker.io&#x2F;v2&#x2F;: dial tcp: lookup registry-1.docker.io on 10.136.40.87:53: server misbehaving</span><br><span class="line">Normal   Pulling    7m37s (x4 over 9m44s)   kubelet, 192-168-1-61.maas  Pulling image &quot;calico&#x2F;cni:v3.13.1&quot;</span><br><span class="line">Warning  Failed     7m22s (x3 over 9m29s)   kubelet, 192-168-1-61.maas  Failed to pull image &quot;calico&#x2F;cni:v3.13.1&quot;: rpc error: code &#x3D; Unknown desc &#x3D; Error response from daemon: Get https:&#x2F;&#x2F;registry-1.docker.io&#x2F;v2&#x2F;: net&#x2F;http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span><br><span class="line">Warning  Failed     7m22s (x4 over 9m29s)   kubelet, 192-168-1-61.maas  Error: ErrImagePull</span><br><span class="line">Warning  Failed     7m9s (x6 over 9m28s)    kubelet, 192-168-1-61.maas  Error: ImagePullBackOff</span><br><span class="line">Normal   BackOff    4m36s (x16 over 9m28s)  kubelet, 192-168-1-61.maas  Back-off pulling image &quot;calico&#x2F;cni:v3.13.1&quot;</span><br></pre></td></tr></table></figure>
<p>download <code>calico:v3.13.1</code> via <a href="https://docs.projectcalico.org/release-notes/">https://docs.projectcalico.org/release-notes/</a>, transfer the tgz package to host server. <br><code>[root@192-168-1-61 calico]# docker load --input /home/eshibij/calico-v3.13.1/release-v3.13.1/images/calico-node.tar</code> –&gt; load calico image, check:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 calico]# docker images</span><br><span class="line">REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">calico&#x2F;node                          v3.13.1             2e5029b93d4a        5 days ago          260MB</span><br></pre></td></tr></table></figure>
<p>把<code>pod2daemon-flexvol</code>, <code>calico-cni</code>, <code>calico-kube-controllers</code>也一起load了</p>
</li>
<li><p><strong>[error]</strong> pod describe find <code>calico 0/1 nodes are available: 1 node(s) had taints that the pod didn&#39;t tolerate.</code> <br>–&gt; 这个一般是有另一个它依赖的node还没起来，查看/var/log/messages <br>–&gt; <code>[failed to find plugin &quot;calico&quot; in path [/opt/ok8s/cni]</code> <br>–&gt; 原因是ok8s把加载的image里的默认文件挂载路径改成了<code>/opt/ok8s/cni</code>。可以直接在<code>/opt/cni/bin</code> (插件加载默认路径) 下找到<code>calico</code>和<code>calico-ipam</code>二进制文件copy到<code>/opt/ok8s/cni</code>下，也可以修改calico.yaml里的文件路径后重新apply -f</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cni]# kubectl get pods -A</span><br><span class="line">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-788d6b9876-dzlrz    1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   calico-node-fttdx                           1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   coredns-5644d7b6d9-dl8ft                    1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   coredns-5644d7b6d9-dzrdv                    1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   etcd-192-168-1-61.maas                      1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-apiserver-192-168-1-61.maas            1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-controller-manager-192-168-1-61.maas   1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-proxy-l54q7                            1&#x2F;1     Running   0          15h</span><br><span class="line">kube-system   kube-scheduler-192-168-1-61.maas            1&#x2F;1     Running   0          15h</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>modify <strong>kubelet</strong>.service <br>add <code>--feature-gates=&quot;IPv6DualStack=true&quot;</code> after <code>ExecStart=/opt/ok8s/bin/kubelet</code> in file <code>/usr/lib/systemd/system/kubelet.service</code></p>
</li>
<li><p>host server <strong>network config</strong></p>
<blockquote>
<p>refer <a href="https://www.jianshu.com/p/e92dec9f9cf4">https://www.jianshu.com/p/e92dec9f9cf4</a></p>
</blockquote>
<p>add configs to <code>/etc/sysctl.d/98-ok8s.conf</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net.ipv6.conf.all.disable_ipv6 &#x3D; 0</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 &#x3D; 0</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 &#x3D; 0</span><br><span class="line">net.ipv6.conf.all.forwarding&#x3D;1</span><br></pre></td></tr></table></figure>
<p>run <code>sysctl -p</code> to make these configs work <br>enable ipv6 on host server, add setting to <code>/etc/sysconfig/network</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NETWORKING_IPV6&#x3D;yes</span><br></pre></td></tr></table></figure>
<p>check <code>ifcfg-xxx</code> under /etc/sysconfig/networkscripts/:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IPV6INIT&#x3D;yes</span><br><span class="line">IPV6_AUTOCONF&#x3D;yes</span><br></pre></td></tr></table></figure></li>
<li><p>generate <strong>kubeconfig</strong> file to parse configs</p>
<blockquote>
<p>refer <a href="https://github.com/Jason-ZW/kubernetes-dual-stack-poc/blob/86f51df6766a3091fea2838416eb55dc6b83d44e/kubeadm/kubeconfig.config">https://github.com/Jason-ZW/kubernetes-dual-stack-poc/blob/86f51df6766a3091fea2838416eb55dc6b83d44e/kubeadm/kubeconfig.config</a></p>
</blockquote>
</li>
<li><p><strong>[error]</strong> k8s v1.16.3 cannot parse subnet with comma <br><a href="https://github.com/kubernetes/kubeadm/issues/1828">https://github.com/kubernetes/kubeadm/issues/1828</a> <br>update K8s to v1.17.4<br>packages/images updated:</p>
<ul>
<li><p>binary file: kubeadm, kubelet, kubectl, kube-proxy, kube-scheduler</p>
</li>
<li><p>docker image: controller-manager, proxy, scheduler, apiserver, etcd, coredns <br>Note: the <code>coredns</code> official package has to be loaded as <code>docker import coredns_1.6.5_linux_amd64.tgz</code> (reason see <a href="https://visionary-s.github.io/%2F2020%2F01%2F20%2Fdocker%2F">https://visionary-s.github.io/%2F2020%2F01%2F20%2Fdocker%2F</a>)<br>check package version after replace kubeadm file: <code>kubeadm config images list</code></p>
</li>
<li><p>reinstall following <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">official docs</a></p>
<ul>
<li>[error] failed to execute operation file exists when <code>systemctl enable kubelet</code> <br>solution : <code>systemctl disable kubelet</code> first, then redo enable action. <a href="https://bugs.freedesktop.org/show_bug.cgi?id=90277">ref</a></li>
<li>[error] cannot use “fe80::2a80:23ff:feb5:a150” as the bind address for the API Server <br>查到kubeconfig.conf中:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">nodeRegistration:</span><br><span class="line">  kubeletExtraArgs:</span><br><span class="line">    ##cgroup-driver: &quot;systemd&quot;</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: fe80::2a80:23ff:feb5:a150</span><br></pre></td></tr></table></figure>
原因：不能用scope为link的ipv6地址，要用scope为global的<code>2001:250:4000:2000::53</code><br><img src="https://res.cloudinary.com/elizashi/image/upload/v1585103774/gitblog/posts/linux-docker-k8s/ip-scope_lajyzl.png" alt="Alt"></li>
<li>etcd 3.4.3 官方镜像有点问题，导致etcd启动连接老是失败<br>solution: 把老版3.1的换了个tag。。。</li>
<li>kube-controller-manager-192-168-1-61.maas CrashLoopBackOff <br>describe node, 发现在无限重启<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">      Warning  Unhealthy  91s                   kubelet, 192-168-1-61.maas  Liveness probe failed: Get https:&#x2F;&#x2F;127.0.0.1:10257&#x2F;healthz: dial tcp 127.0.0.1:10257: connect: connection refused</span><br><span class="line">Warning  BackOff    57s (x12 over 4m30s)  kubelet, 192-168-1-61.maas  Back-off restarting failed container</span><br></pre></td></tr></table></figure>
check docker logs；<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">E0325 03:00:25.517141       1 core.go:91] Failed to start service controller: WARNING: no cloud provider provided, services of type LoadBalancer will fail</span><br><span class="line">E0325 03:00:25.638913       1 core.go:232] failed to start cloud node lifecycle controller: no cloud provider provided</span><br><span class="line">E0325 03:00:37.441597       1 controllermanager.go:521] Error starting &quot;nodeipam&quot;</span><br><span class="line">F0325 03:00:37.441623       1 controllermanager.go:235] error starting controllers: New CIDR set failed; the node CIDR size is too big</span><br></pre></td></tr></table></figure>
solution: ?</li>
</ul>
</li>
<li><p>install calico</p>
<ul>
<li><p>error when starting calico node</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kube-system   calico-node-mzcnp      0&#x2F;1     Init:CrashLoopBackOff   2       31s</span><br></pre></td></tr></table></figure>
<p>descirbe event:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        Normal   Scheduled  56s                default-scheduler           Successfully assigned kube-system&#x2F;calico-node-mzcnp to 192-168-1-61.maas</span><br><span class="line">Normal   Pulled     12s (x4 over 56s)  kubelet, 192-168-1-61.maas  Container image &quot;calico&#x2F;cni:v3.13.1&quot; already present on machine</span><br><span class="line">Normal   Created    12s (x4 over 56s)  kubelet, 192-168-1-61.maas  Created container upgrade-ipam</span><br><span class="line">Warning  Failed     12s (x4 over 56s)  kubelet, 192-168-1-61.maas  Error: failed to start container &quot;upgrade-ipam&quot;: Error response from daemon: OCI runtime create failed: container_linux.go:346: starting container process caused &quot;exec: \&quot;&#x2F;opt&#x2F;ok8s&#x2F;cni&#x2F;calico-ipam\&quot;: stat &#x2F;opt&#x2F;ok8s&#x2F;cni&#x2F;calico-ipam: no such file or directory&quot;: unknown</span><br><span class="line">Warning  BackOff    8s (x4 over 41s)   kubelet, 192-168-1-61.maas  Back-off restarting failed container</span><br></pre></td></tr></table></figure>
<p>but I found the <code>calico-ipam</code> is already under <code>/opt/ok8s/cni/</code><br>原因：calico.yaml配置里路径写错了，按官网的来</p>
</li>
<li><p>calico node起不起来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">      [root@192-168-1-61 calico]# kubectl get pods -A</span><br><span class="line">NAMESPACE     NAME                                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-788d6b9876-wkd5h    0&#x2F;1     ContainerCreating   0          39m</span><br><span class="line">kube-system   calico-node-64q4h                           0&#x2F;1     Running             0          59s</span><br><span class="line">kube-system   coredns-6955765f44-k9cb5                    0&#x2F;1     ContainerCreating   0          45m</span><br><span class="line">kube-system   coredns-6955765f44-nznr9                    0&#x2F;1     ContainerCreating   0          45m</span><br><span class="line">kube-system   etcd-192-168-1-61.maas                      1&#x2F;1     Running             0          45m</span><br><span class="line">kube-system   kube-apiserver-192-168-1-61.maas            1&#x2F;1     Running             0          45m</span><br><span class="line">kube-system   kube-controller-manager-192-168-1-61.maas   1&#x2F;1     Running             0          45m</span><br><span class="line">kube-system   kube-proxy-ggjvb                            1&#x2F;1     Running             0          45m</span><br><span class="line">kube-system   kube-scheduler-192-168-1-61.maas            1&#x2F;1     Running             0          45m</span><br></pre></td></tr></table></figure>
<p>describe calico-kube-controller:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    Warning  FailedScheduling        59s (x30 over 39m)  default-scheduler           0&#x2F;1 nodes are available: 1 node(s) had taints that the pod didn&#39;t tolerate.</span><br><span class="line">Normal   Scheduled               57s                 default-scheduler           Successfully assigned kube-system&#x2F;calico-kube-controllers-788d6b9876-wkd5h to 192-168-1-61.maas</span><br><span class="line">Warning  FailedCreatePodSandBox  54s                 kubelet, 192-168-1-61.maas  Failed to create pod sandbox: rpc error: code &#x3D; Unknown desc &#x3D; [failed to set up sandbox container &quot;27761f7a236bf9c092826ecb546dddad7c44a40fa1891faf6c45b14f330ad25d&quot; network for pod &quot;calico-kube-controllers-788d6b9876-wkd5h&quot;: networkPlugin cni failed to set up pod &quot;calico-kube-controllers-788d6b9876-wkd5h_kube-system&quot; network: error getting ClusterInformation: Get https:&#x2F;&#x2F;[10.24.0.1]:443&#x2F;apis&#x2F;crd.projectcalico.org&#x2F;v1&#x2F;clusterinformations&#x2F;default: dial tcp 10.24.0.1:443: connect: connection refused, failed to clean up sandbox container &quot;27761f7a236bf9c092826ecb546dddad7c44a40fa1891faf6c45b14f330ad25d&quot; network for pod &quot;calico-kube-controllers-788d6b9876-wkd5h&quot;: networkPlugin cni failed to teardown pod &quot;calico-kube-controllers-788d6b9876-wkd5h_kube-system&quot; network: error getting ClusterInformation: Get https:&#x2F;&#x2F;[10.24.0.1]:443&#x2F;apis&#x2F;crd.projectcalico.org&#x2F;v1&#x2F;clusterinformations&#x2F;default: dial tcp 10.24.0.1:443: connect: connection refused]</span><br><span class="line">Normal   SandboxChanged          9s (x5 over 53s)    kubelet, 192-168-1-61.maas  Pod sandbox changed, it will be killed and re-created.</span><br></pre></td></tr></table></figure>
<p>原因： <code>https://[10.24.0.1]:443</code>这个应该对应kubeconfig中kube-proxy下的clusterCIDR，应该跟kubelet下的podSubnet保持一致?（我用了serviceSubnet的网段）<br>还是不行，后面又改成了纯ipv6环境，配置文件kubeconfig.yml如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">2001</span><span class="string">:250:4000:2000::53</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">taints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">  <span class="attr">kubeletExtraArgs:</span></span><br><span class="line">    <span class="attr">node-ip:</span> <span class="string">&quot;2001:250:4000:2000::53&quot;</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">&quot;[2001:250:4000:2000::53]:6443&quot;</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="comment">#feature-gates: IPv6DualStack=true</span></span><br><span class="line">    <span class="attr">bind-address:</span> <span class="string">&quot;::&quot;</span></span><br><span class="line">    <span class="attr">service-cluster-ip-range:</span> <span class="string">fd03::/120</span></span><br><span class="line">    <span class="attr">cluster-cidr:</span> <span class="string">&quot;fd04::/120&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.17.4</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="string">&quot;fd03::/120&quot;</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="string">&quot;fd04::/120&quot;</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="string">&quot;fd03::/120&quot;</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">&quot;ipvs&quot;</span></span><br></pre></td></tr></table></figure>
<p>修改了<a href="https://docs.projectcalico.org/manifests/calico.yaml">calico.yaml</a>执行脚本的参数如下：<br>！这是dual的，ipv6-only的把ipv4的部分去掉</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">cni_network_config:</span> <span class="string">|-</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;k8s-pod-network&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cniVersion&quot;:</span> <span class="string">&quot;0.3.1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;plugins&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">...</span></span><br><span class="line">          <span class="attr">&quot;ipam&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;calico-ipam&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;assign_ipv4&quot;:</span> <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;assign_ipv6&quot;:</span> <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;ipv4_pools&quot;:</span> [<span class="string">&quot;192.170.30.0/16&quot;</span>, <span class="string">&quot;default-ipv4-ippool&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;ipv6_pools&quot;:</span> [<span class="string">&quot;fd03::/120&quot;</span>, <span class="string">&quot;default-ipv6-ippool&quot;</span>]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">...</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">...</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">calico-node</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">calico/node:v3.13.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;192.170.30.0/16&quot;</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="comment"># Disable IPv6 on Kubernetes.</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FELIX_IPV6SUPPORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV6POOL_CIDR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">fd04::/120</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP6</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;autodetect&quot;</span></span><br><span class="line">        <span class="comment"># !注意，这是后来做outgress发现的，ipv6环境默认不会配网关，see</span></span><br><span class="line">        <span class="comment"># https://docs.projectcalico.org/reference/node/configuration</span></span><br><span class="line">        <span class="comment"># 所以这里要加个参数</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV6POOL_NAT_OUTGOING</span></span><br><span class="line">          <span class="attr">value:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>create检查service地址能不能对上，具体debug步骤忘了，大概用了这些命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ss -atnlp | grep 443</span><br><span class="line">netstat -an|grep 6443</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>又装了个Nginx pod以后，试图写一个测试service看能不能通过Nginx ping通ipv6地址，失败</p>
<ul>
<li>service.yaml<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">ipFamily:</span> <span class="string">IPv6</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li>
<li>nginx.yaml<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">piVersion:</span> <span class="string">apps/v1</span> <span class="comment"># for versions before 1.9.0 use apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># tells deployment to run 2 pods matching the template</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">            <span class="attr">ports:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li>
<li>debug<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@192-168-1-61 ok8s]# kubectl apply -f service.yaml</span><br><span class="line">service&#x2F;cec created</span><br><span class="line">[root@192-168-1-61 ok8s]# kubectl get service -A</span><br><span class="line">NAMESPACE     NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">default       cec          ClusterIP   fd03::7d     &lt;none&gt;        8080&#x2F;TCP                 35s</span><br><span class="line">default       kubernetes   ClusterIP   fd03::1      &lt;none&gt;        443&#x2F;TCP                  4h36m</span><br><span class="line">kube-system   kube-dns     ClusterIP   fd03::a      &lt;none&gt;        53&#x2F;UDP,53&#x2F;TCP,9153&#x2F;TCP   4h36m</span><br><span class="line">[root@192-168-1-61 ok8s]# kubectl describe -n default pod nginx-deployment-574b87c764-qptmz</span><br><span class="line">...</span><br><span class="line">Node:         192-168-1-61.maas&#x2F;2001:250:4000:2000::53</span><br><span class="line">Labels:       app&#x3D;nginx</span><br><span class="line">Annotations:  cni.projectcalico.org&#x2F;podIP: fd04::d5&#x2F;128</span><br><span class="line">              cni.projectcalico.org&#x2F;podIPs: fd04::d5&#x2F;128</span><br><span class="line">IP:           fd04::d5</span><br><span class="line">Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Container ID:   docker:&#x2F;&#x2F;199c74a7f44d431d95091d991025e43b24dca7fa9cc9d77e3781af1b89f160ce</span><br><span class="line">      Image:          nginx:1.14.2</span><br><span class="line">      Port:           80&#x2F;TCP</span><br><span class="line">      Host Port:      0&#x2F;TCP</span><br><span class="line">...</span><br><span class="line">[root@192-168-1-61 ok8s]# kubectl get pods -o yaml | grep -i podip</span><br><span class="line">    cni.projectcalico.org&#x2F;podIP: fd04::d5&#x2F;128</span><br><span class="line">    cni.projectcalico.org&#x2F;podIPs: fd04::d5&#x2F;128</span><br><span class="line">  podIP: fd04::d5</span><br><span class="line">  podIPs:</span><br><span class="line">[root@192-168-1-61 ok8s]# kubectl describe svc cec</span><br><span class="line">...</span><br><span class="line">Selector:          app&#x3D;nginx</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                fd03::7d</span><br><span class="line">Port:              http  8080&#x2F;TCP</span><br><span class="line">TargetPort:        80&#x2F;TCP</span><br><span class="line">Endpoints:         [fd04::d5]:80</span><br><span class="line">[root@192-168-1-61 ok8s]# curl -vvv -k http:&#x2F;&#x2F;[fd03::7d]:8080 -g</span><br><span class="line">* About to connect() to fd03::7d port 8080 (#0)</span><br><span class="line">*   Trying fd03::7d...</span><br><span class="line">* Connection refused</span><br><span class="line">* Failed connect to fd03::7d:8080; Connection refused</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed connect to fd03::7d:8080; Connection refused</span><br><span class="line">[root@192-168-1-61 ok8s]# &gt;&#x2F;dev&#x2F;tcp&#x2F;fd03::7d&#x2F;8080</span><br><span class="line">-bash: connect: Connection refused</span><br><span class="line">-bash: &#x2F;dev&#x2F;tcp&#x2F;fd03::7d&#x2F;8080: Connection refused</span><br><span class="line">[root@192-168-1-61 ok8s]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  [fd03::1]:443 rr</span><br><span class="line">  -&gt; [2001:250:4000:2000::53]:6443 Masq    1      4          0         </span><br><span class="line">TCP  [fd03::a]:53 rr</span><br><span class="line">  -&gt; [fd04::cf]:53                Masq    1      0          0         </span><br><span class="line">  -&gt; [fd04::d7]:53                Masq    1      0          0         </span><br><span class="line">TCP  [fd03::a]:9153 rr</span><br><span class="line">  -&gt; [fd04::cf]:9153              Masq    1      0          0         </span><br><span class="line">  -&gt; [fd04::d7]:9153              Masq    1      0          0         </span><br><span class="line">TCP  [fd03::7d]:8080 rr</span><br><span class="line">  -&gt; [fd04::d5]:80                Masq    1      0          0         </span><br><span class="line">UDP  [fd03::a]:53 rr</span><br><span class="line">  -&gt; [fd04::cf]:53                Masq    1      0          0         </span><br><span class="line">  -&gt; [fd04::d7]:53                Masq    1      0          0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cec-installer]# kubectl get svc,deploy</span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service&#x2F;kubernetes   ClusterIP   fd03::1      &lt;none&gt;        443&#x2F;TCP   137m</span><br><span class="line"></span><br><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps&#x2F;nginx-deployment   2&#x2F;2     2            2           105m</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ok8s]# kubectl exec -it nginx-deployment-574b87c764-qptmz bash</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;# &gt;&#x2F;dev&#x2F;tcp&#x2F;127.0.0.1&#x2F;80</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;# &gt;&#x2F;dev&#x2F;tcp&#x2F;fd04::d5&#x2F;80</span><br><span class="line">bash: connect: Connection refused</span><br><span class="line">bash: &#x2F;dev&#x2F;tcp&#x2F;fd04::d5&#x2F;80: Connection refused</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;# cd &#x2F;etc&#x2F;nginx&#x2F;</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;etc&#x2F;nginx# cat nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">  default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">  log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">              &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">              &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">  access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">  sendfile        on;</span><br><span class="line">  #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">  #gzip  on;</span><br><span class="line"></span><br><span class="line">  include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; not modified on my desktop, thus skip the modification here</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;etc&#x2F;nginx# nginx -s reload</span><br><span class="line">2020&#x2F;03&#x2F;26 09:01:37 [notice] 28#28: signal process started</span><br><span class="line">root@nginx-deployment-574b87c764-qptmz:&#x2F;etc&#x2F;nginx# &gt;&#x2F;dev&#x2F;tcp&#x2F;fd04::d5&#x2F;80</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>install helm/tiller/nfs/ingress <br>Background: no connection to outer internet on host server, install helm and tiller locally, export tiller image and transfer it to host server.</p>
<ul>
<li><p>Step1: install helm</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;get.helm.sh&#x2F;helm-v2.16.1-linux-amd64.tar.gz</span><br><span class="line">&#x2F;&#x2F; transfer package to host server:&#x2F;var&#x2F;tmp&#x2F;xxx-installer&#x2F;</span><br><span class="line">[root@192-168-1-61 cec-installer]# tar zxvf helm-v2.16.1-linux-amd64.tar.gz</span><br><span class="line">linux-amd64&#x2F;</span><br><span class="line">linux-amd64&#x2F;helm</span><br><span class="line">linux-amd64&#x2F;LICENSE</span><br><span class="line">linux-amd64&#x2F;tiller</span><br><span class="line">linux-amd64&#x2F;README.md</span><br><span class="line">[root@192-168-1-61 cec-installer]# sudo install **&#x2F;helm &#x2F;usr&#x2F;bin</span><br><span class="line">[root@192-168-1-61 cec-installer]# helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:&quot;v2.16.1&quot;, GitCommit:&quot;bbdfe5e7803a12bbdf97e94cd847859890cf4050&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br><span class="line">Error: could not find tiller</span><br><span class="line">[root@192-168-1-61 cec-installer]# helm init</span><br><span class="line">Creating &#x2F;root&#x2F;.helm</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;repository</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;repository&#x2F;cache</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;repository&#x2F;local</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;plugins</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;starters</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;cache&#x2F;archive</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;repository&#x2F;repositories.yaml</span><br><span class="line">Adding stable repo with URL: https:&#x2F;&#x2F;kubernetes-charts.storage.googleapis.com</span><br><span class="line">Error: error initializing: Looks like &quot;https:&#x2F;&#x2F;kubernetes-charts.storage.googleapis.com&quot; is not a valid chart repository or cannot be reached:etes-charts.storage.googleapis.com&#x2F;index.yaml: dial tcp: lookup kubernetes-charts.storage.googleapis.com on 10.136.40.87:53: server misbehavi</span><br></pre></td></tr></table></figure>
<p>here refered <a href="https://www.jianshu.com/p/2bb1dfdadee8">https://www.jianshu.com/p/2bb1dfdadee8</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 这一步不知道要不要做，反正我先做了</span><br><span class="line">[root@192-168-1-61 cec-installer]# cd linux-amd64&#x2F;</span><br><span class="line">[root@192-168-1-61 linux-amd64]# ls</span><br><span class="line">LICENSE  README.md  helm  tiller</span><br><span class="line">[root@192-168-1-61 linux-amd64]# vim rbac-config.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 linux-amd64]# kubectl create -f rbac-config.yaml</span><br><span class="line">serviceaccount&#x2F;tiller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;tiller created</span><br></pre></td></tr></table></figure></li>
<li><p>Step2: init tiller <br>save local <code>tiller</code> image and transfer it to host server, then follow the <a href="https://github.com/helm/helm/issues/4540">answer@Amit-Thawait</a></p>
<blockquote>
<p>这里还遇到一个问题，本地win10的helm和tiller以前装的是2.14，这次用了2.16，不知如何升级，问了一下，原来是用2.16的helm.exe和tiller.exe文件替换掉<eid>/.helm/下的俩对应exe再init一遍就行了，估计linux上的更新就是替换一下二进制文件吧。。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@host63 cec-installer]# docker image tag 1f92aa902d73 gcr.io&#x2F;kubernetes-helm&#x2F;tiller:v2.16.1</span><br><span class="line">[root@192-168-1-61 cec-installer]# helm init --client-only --skip-refresh</span><br><span class="line">Creating &#x2F;root&#x2F;.helm&#x2F;repository&#x2F;repositories.yaml</span><br><span class="line">Adding stable repo with URL: https:&#x2F;&#x2F;kubernetes-charts.storage.googleapis.com</span><br><span class="line">Adding local repo with URL: http:&#x2F;&#x2F;127.0.0.1:8879&#x2F;charts</span><br><span class="line">$HELM_HOME has been configured at &#x2F;root&#x2F;.helm.</span><br><span class="line">Not installing Tiller due to &#39;client-only&#39; flag having been set</span><br><span class="line">&#x2F;&#x2F; load tiller image</span><br><span class="line">[root@192-168-1-61 cec-installer]# helm init</span><br><span class="line">$HELM_HOME has been configured at &#x2F;root&#x2F;.helm.</span><br><span class="line">Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.</span><br><span class="line">Please note: by default, Tiller is deployed with an insecure &#39;allow unauthenticated users&#39; policy.</span><br><span class="line">To prevent this, run &#96;helm init&#96; with the --tiller-tls-verify flag.</span><br><span class="line">For more information on securing your installation see: https:&#x2F;&#x2F;docs.helm.sh&#x2F;using_helm&#x2F;#securing-your-helm-installation</span><br></pre></td></tr></table></figure>
<p>helm error happens:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cec-installer]# helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:&quot;v2.16.1&quot;, GitCommit:&quot;bbdfe5e7803a12bbdf97e94cd847859890cf4050&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br><span class="line">E0326 23:21:17.649683   11541 portforward.go:400] an error occurred forwarding 39127 -&gt; 44134: error forwarding port 44134 to pod 8d197e975824256d2de574f4577161702560b55a4aa70978bac91f2e43abe712, uid : unable to do port forwarding: socat not found</span><br><span class="line">E0326 23:21:18.652732   11541 portforward.go:400] an error occurred forwarding 39127 -&gt; 44134: error forwarding port 44134 to pod 8d197e975824256d2de574f4577161702560b55a4aa70978bac91f2e43abe712, uid : unable to do port forwarding: socat not found</span><br></pre></td></tr></table></figure>
<p>According to <a href="https://www.kubernetes.org.cn/3879.html">https://www.kubernetes.org.cn/3879.html</a>, this error happens due to rr is not set to permitted in k8s net config, install socat to fix it. (internal yum repository has build up, thus download directly)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cec-installer]# yum install socat.x86_64</span><br><span class="line">[root@192-168-1-61 cec-installer]# helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:&quot;v2.16.1&quot;, GitCommit:&quot;bbdfe5e7803a12bbdf97e94cd847859890cf4050&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:&quot;v2.16.4&quot;, GitCommit:&quot;5e135cc465d4231d9bfe2c5a43fd2978ef527e83&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>版本好像没对上，懒得重装了凑合用吧。</p>
</li>
<li><p>Step3: install nfs <br>  <strong>[error]</strong> cannot install nfs:</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm install stable&#x2F;nfs-server-provisioner --name nfs-provisioner --set persistence.storageClass&#x3D;nfs --set persistence.size&#x3D;20Gi --set rbac.create&#x3D;true</span><br><span class="line">Error: validation failed: [storageclasses.storage.k8s.io &quot;nfs&quot; not found, serviceaccounts &quot;nfs-provisioner-nfs-server-provisioner&quot; not found, clusterroles.rbac.authorization.k8s.io &quot;nfs-provisioner-nfs-server-provisioner&quot; not found, clusterrolebindings.rbac.authorization.k8s.io &quot;nfs-provisioner-nfs-server-provisioner&quot; not found, services &quot;nfs-provisioner-nfs-server-provisioner&quot; not found, statefulsets.apps &quot;nfs-provisioner-nfs-server-provisioner&quot; not found]</span><br></pre></td></tr></table></figure>
<p> try to downgrade tiller to 2.16.1 on windows:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm reset --force</span><br><span class="line">$ helm init -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.1</span><br></pre></td></tr></table></figure>
<p> nfs installed on windows successfully:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME                 PROVISIONER                                            AGE</span><br><span class="line">hostpath (default)   docker.io/hostpath                                     7d3h</span><br><span class="line">nfs                  cluster.local/nfs-provisioner-nfs-server-provisioner   102s</span><br></pre></td></tr></table></figure>
<p> for offline linux server, firstly download <a href="https://github.com/helm/charts/tree/master/stable/nfs-server-provisioner">helm chart package</a>, then package the chart files to tgz, helm install it on host server:</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cec-installer]# helm install -n nfs-provisioner .&#x2F;nfs-servier-provisoner.tgz \</span><br><span class="line">&gt; --set persistence.storageClass&#x3D;nfs \</span><br><span class="line">&gt; --set persistence.size&#x3D;20Gi</span><br><span class="line"></span><br><span class="line">Error: release nfs-provisioner failed: namespaces &quot;default&quot; is forbidden: User &quot;system:serviceaccount:kube-system:default&quot; cannot get resource &quot;namespaces&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure>
<p> 应该是helm创建sa时未添加helm-tiller，按这个<a href="https://forum.choerodon.io/t/topic/1721/3">步骤</a>加上就ok了:</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 cec-installer]# kubectl create serviceaccount --namespace kube-system helm-tiller</span><br><span class="line">serviceaccount&#x2F;helm-tiller created</span><br><span class="line"></span><br><span class="line">[root@192-168-1-61 cec-installer]# kubectl create clusterrolebinding helm-tiller-cluster-rule --clusterrole&#x3D;cluster-admin --serviceaccount&#x3D;kube-system:helm-tiller</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;helm-tiller-cluster-rule created</span><br><span class="line"></span><br><span class="line">[root@192-168-1-61 cec-installer]# helm init --service-account&#x3D;helm-tiller --upgrade</span><br><span class="line">$HELM_HOME has been configured at &#x2F;root&#x2F;.helm.</span><br><span class="line">Tiller (the Helm server-side component) has been updated to gcr.io&#x2F;kubernetes-helm&#x2F;tiller:v2.16.1 .</span><br><span class="line"></span><br><span class="line">[root@192-168-1-61 cec-installer]# helm install -n nfs-provisioner .&#x2F;nfs-servier-provisoner.tgz --set persistence.storageClass&#x3D;nfs --set persistence.size&#x3D;20Gi</span><br><span class="line">NAME:   nfs-provisioner</span><br><span class="line">LAST DEPLOYED: Mon Mar 30 02:13:19 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line">...</span><br><span class="line">[root@192-168-1-61 cec-installer]# kubectl get storageclass</span><br><span class="line">NAME   PROVISIONER                                            RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs    cluster.local&#x2F;nfs-provisioner-nfs-server-provisioner   Delete          Immediate           true                   2m42s</span><br></pre></td></tr></table></figure></li>
<li><p>Step4: install nginx-ingress, similar to installing nfs</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker load -i ingress-nginx.tar.gz</span><br><span class="line">docker image tag 20c7790fd73d quay.io&#x2F;kubernetes-ingress-controller&#x2F;nginx-ingress-controller:0.29.0</span><br><span class="line">helm install -n nginx-ingress .&#x2F;nginx-ingress-deploy.tgz --set rbac.create&#x3D;true</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>finally, start to install our product</p>
<ul>
<li><p>产品jenkins-ci因为没人维护挂了。。只好本地打包</p>
<ul>
<li><p>step1: <code>./startindesignenv.sh -c -d</code> -d步骤中最后为<code>npm start</code>所以最后不会停要手动cancel进程。build + deploy完了以后可以在coreservice/backend/webroot（类似target）下找到拷贝过去的前端编译文件。</p>
</li>
<li><p>step2: 在任一service目录下（例：coreservice）<code>$ docker build -t &lt;package-name&gt; .</code>执行打包，coreservice比较特殊，因为前后端一体所以要执行第一步先把前端整合到后端，其他service直接打包即可。</p>
<ul>
<li><p>error1:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Step 1/15 : FROM node:10.15.3-alpine</span><br><span class="line">error pulling image configuration: Get https://registry-1.docker.io/v2/library/node/blobs.. net/http: TLS handshake timeout</span><br></pre></td></tr></table></figure>
<p>solution : network not stable, ignore and build again</p>
</li>
<li><p>error2:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> Step 2/15 : RUN apk add --no-cache bash openssl</span><br><span class="line"> fetch http://dl-cdn.alpinelinux.org/alpine/v3.9/main/x86_64/APKINDEX.tar.gz</span><br><span class="line"> WARNING: Ignoring http://dl-cdn.alpinelinux.org/alpine/v3.9/main/x86_64/APKINDEX.tar.gz: network error (check Internet connection and firewall)</span><br><span class="line"> ERROR: unsatisfiable constraints:</span><br><span class="line">    bash (missing):</span><br><span class="line">      required by: world[bash]</span><br><span class="line">    openssl (missing):</span><br><span class="line">      required by: world[openssl]</span><br><span class="line">The <span class="built_in">command</span> <span class="string">&#x27;/bin/sh -c apk add --no-cache bash openssl&#x27;</span> returned a non-zero code: 2</span><br></pre></td></tr></table></figure>
<p>solution: didnt figure out the detailed reason, but restart docker cannot solve this issue. Thanks to Ye who taught me to add</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ENV</span> HTTP_PROXY=<span class="string">&quot;http://www-proxy.lmera.ericsson.se:8080&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HTTPS_PROXY=<span class="string">&quot;http://www-proxy.lmera.ericsson.se:8080&quot;</span></span><br></pre></td></tr></table></figure>
<p>to Dockerfile, the problem due to no connection to external link while running the <code>alpinelinux</code>.</p>
<blockquote>
<p>the proxy ENV config will also take effect on container running on host server after loading, we would better use <code>--build-arg</code> when execute <code>docker build</code>, see <a href="https://www.cntofu.com/book/139/image/dockerfile/arg.md">https://www.cntofu.com/book/139/image/dockerfile/arg.md</a><br>e.g. $ docker build -t core-cec . –build-arg HTTP_PROXY=”<a href="http://www-proxy.lmera.ericsson.se:8080&quot;">http://www-proxy.lmera.ericsson.se:8080&quot;</a></p>
</blockquote>
</li>
</ul>
</li>
<li><p>Step3: install on linux server</p>
<ol>
<li><code>docker load -i &lt;package&gt;</code></li>
<li><code>helm install -n eri2 ./cec-release-1.0.0.tgz --set service.type=NodePort --set persistence.enabled=false --set persistence.storageClass=nfs --set persistence.database.size=5Gi --set persistence.miscellaneous.size=5Gi</code></li>
<li>deployed but got error, when building one service container, run image as container and enter to check:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  [root@192-168-1-61 cec-installer]# docker run -it registry&#x2F;cec-sai:1.0.0 sh</span><br><span class="line">  &#x2F;opt&#x2F;ericsson&#x2F;cec&#x2F;saiservice # &#x2F;usr&#x2F;local&#x2F;bin&#x2F;npm start</span><br><span class="line">  &#x2F;opt&#x2F;ericsson&#x2F;cec&#x2F;saiservice&#x2F;node_modules&#x2F;bindings&#x2F;bindings.js:91</span><br><span class="line">    throw e</span><br><span class="line">    ^</span><br><span class="line">    Error: Error loading shared library &#x2F;opt&#x2F;ericsson&#x2F;cec&#x2F;saiservice&#x2F;node_modules&#x2F;libxmljs&#x2F;build&#x2F;Release&#x2F;xmljs.node: Exec format error</span><br><span class="line">at Object.Module._extensions..node (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:730:18)</span><br><span class="line">at Module.load (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:600:32)</span><br><span class="line">at tryModuleLoad (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:539:12)</span><br><span class="line">at Function.Module._load (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:531:3)</span><br><span class="line">at Module.require (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:637:17)</span><br><span class="line">at require (internal&#x2F;modules&#x2F;cjs&#x2F;helpers.js:22:18)</span><br><span class="line">at bindings (&#x2F;opt&#x2F;ericsson&#x2F;cec&#x2F;saiservice&#x2F;node_modules&#x2F;bindings&#x2F;bindings.js:84:48)</span><br><span class="line">at Object.&lt;anonymous&gt; (&#x2F;opt&#x2F;ericsson&#x2F;cec&#x2F;saiservice&#x2F;node_modules&#x2F;libxmljs&#x2F;lib&#x2F;bindings.js:1:99)</span><br><span class="line">at Module._compile (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:701:30)</span><br><span class="line">at Object.Module._extensions..js (internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:712:10)</span><br><span class="line">npm ERR! code ELIFECYCLE</span><br><span class="line">npm ERR! errno 1</span><br><span class="line">npm ERR! CEC_SAI_Handler@1.0.0 start: &#96;node server.js&#96;</span><br><span class="line">npm ERR! Exit status 1</span><br><span class="line">npm ERR!</span><br><span class="line">npm ERR! Failed at the CEC_SAI_Handler@1.0.0 start script.</span><br><span class="line">npm ERR! This is probably not a problem with npm. There is likely additional logging output above.</span><br><span class="line">npm ERR! A complete log of this run can be found in:</span><br><span class="line">npm ERR!     &#x2F;root&#x2F;.npm&#x2F;_logs&#x2F;2020-03-31T02_30_46_424Z-debug.log</span><br></pre></td></tr></table></figure>
it may due to the some nodes in <code>npm_modules</code> not work both on windows and linux env. ref: <a href="https://dzone.com/articles/packaging-a-node-app-for-docker-from-windows">https://dzone.com/articles/packaging-a-node-app-for-docker-from-windows</a> <br>solution: remove <code>node_modules</code> before docker image build, npm install all packages in docker container, thus it will be generated in linux format.<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf node_modules</span></span><br><span class="line">...</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
build and check image:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t cec-sai . --build-arg HTTP_PROXY=<span class="string">&quot;http://www-proxy.lmera.ericsson.se:8080&quot;</span></span><br><span class="line">$ winpty docker run -it cec-sai sh</span><br><span class="line">/opt/ericsson/cec/saiservice <span class="comment"># find / -name npm</span></span><br><span class="line">/usr/<span class="built_in">local</span>/lib/node_modules/npm</span><br><span class="line">/usr/<span class="built_in">local</span>/lib/node_modules/npm/bin/npm</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/npm</span><br><span class="line">/opt/ericsson/cec/saiservice <span class="comment"># /usr/local/bin/npm start</span></span><br><span class="line">&gt; CEC_SAI_Handler@1.0.0 start /opt/ericsson/cec/saiservice</span><br><span class="line">&gt; node server.js</span><br><span class="line">sequelize deprecated String based operators are now deprecated. Please use Symbol based operators <span class="keyword">for</span> better security, <span class="built_in">read</span> more at http://docs.sequelizejs.com/manual/tutorial/querying.html<span class="comment">#operators node_modules/sequelize/lib/sequelize.js:245:13</span></span><br></pre></td></tr></table></figure>
save image:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker save -o cec-sai-200327.tar.gz cec-sai</span><br></pre></td></tr></table></figure>
then load it to host server on linux<blockquote>
<p>Run enm server via docker container is a simpler way, use <code>docker run -itd --name &lt;simulator-name&gt; -p 8091:8091 -v &lt;volume-path&gt; &lt;image-id or name&gt;</code>, volune path can be skipped to set, remind to expose port 8091 or the container cannot be accessed. (port depends on your design)</p>
</blockquote>
</li>
</ol>
</li>
<li><p>Step4: install simulator <br>save image on windows, load it to linux, then start simulator service on linux server:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create deployment xxx-simulator --image=xxx-simulator:1.0.0</span><br><span class="line">deployment.apps/xxx-simulator created</span><br></pre></td></tr></table></figure>
<p>get simulator ip address:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod -l app=enm-simulator -o wide</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE    IP         NODE                NOMINATED NODE   READINESS GATES</span><br><span class="line">xxx-simulator-79d68f588f-8l2fq   1/1     Running   0          4m3s   fd04::fb   192-168-1-61.maas   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Test functionalities</p>
<ul>
<li><p>[error1] connot apply ipv6 address in our settings. <br>solution: change validation regex from <code>^http(s)?://[\\w\\.\\-?=%&amp;:/]+$</code> to <code>^http(s)?://([\[\\w\\.\\-?=%&amp;:/](\])?)+$</code></p>
</li>
<li><p>[error2] cannot connect to simulator when do cell import:<br>solution: modify default <code>HOST</code> config in <code>server.js</code> from ‘0.0.0.0’ to ‘’. see <a href="https://nodejs.org/api/net.html#net_net_isip_input">official node.js docs</a> section = <em>server.listen(options[, callback])</em> <br>here I record my debug history:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ~]# kubectl exec -it xxx-simulator-79d68f588f-8l2fq bash</span><br><span class="line">bash-4.4# netstat -tunlp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address           State       PID&#x2F;Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:8091            0.0.0.0:*               LISTEN      23&#x2F;node</span><br><span class="line">tcp        0      0 0.0.0.0:8092            0.0.0.0:*               LISTEN      23&#x2F;node</span><br></pre></td></tr></table></figure>
<p>the ip is deafult in ipv4 format, so enter our core service (frontend and backend) pod to check more.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ~]# kubectl exec -it -c xxx-core eri1-xxx-6c4b88cd75-7plb8 bash</span><br><span class="line">bash-4.4# ping6 fd04::fd</span><br><span class="line">PING fd04::fd (fd04::fd): 56 data bytes</span><br><span class="line">64 bytes from fd04::fd: seq&#x3D;0 ttl&#x3D;63 time&#x3D;0.144 ms</span><br><span class="line">64 bytes from fd04::fd: seq&#x3D;1 ttl&#x3D;63 time&#x3D;0.179 ms</span><br><span class="line">64 bytes from fd04::fd: seq&#x3D;2 ttl&#x3D;63 time&#x3D;0.069 ms</span><br></pre></td></tr></table></figure>
<p>fd04::fd is the ipv6 address of simulator, so simulator can be accessed by core service.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.4# netstat -tunlp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 :::8082                 :::*                    LISTEN      -</span><br><span class="line">tcp        0      0 :::8083                 :::*                    LISTEN      -</span><br><span class="line">tcp        0      0 :::8084                 :::*                    LISTEN      -</span><br><span class="line">tcp        0      0 :::8888                 :::*                    LISTEN      16&#x2F;node</span><br><span class="line">tcp        0      0 :::5432                 :::*                    LISTEN      -</span><br><span class="line">tcp        0      0 :::8443                 :::*                    LISTEN      16&#x2F;node</span><br><span class="line">tcp        0      0 :::8585                 :::*                    LISTEN      16&#x2F;node</span><br></pre></td></tr></table></figure>
<p>ports are all correct, so there might be errors in simulator codes</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@192-168-1-61 ~]# kubectl exec -it enm-simulator-77c8886b88-7ksxk bash</span><br><span class="line">bash-4.4# grep -i host &#x2F;opt&#x2F;eri..&#x2F;xxx&#x2F;simulatorservice&#x2F;server.js</span><br><span class="line">const HOST &#x3D; &#39;0.0.0.0&#39;;</span><br><span class="line">httpServer.listen(HTTP_PORT, HOST, () &#x3D;&gt; &#123;</span><br><span class="line">  LOGGER.info(&quot;HTTP Server is running on : http:&#x2F;&#x2F;%s:%s&quot;, HOST, HTTP_PORT);</span><br><span class="line">httpsServer.listen(HTTPS_PORT, HOST, () &#x3D;&gt; &#123;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>果然。。。config default HOST = ‘0.0.0.0’ –&gt; HOST = ‘’</p>
</li>
<li><p>system error : <code>connect ECONNREFUSED 127.0.0.1:8091,ENM=http://[fd04::fe]:8091</code> <br>this error indicate the default route the simulator service connect to is not correct, check in codes I found:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ENMSERVICEPROTOCO: process.env.enmserviceprotoco || <span class="string">&#x27;http:&#x27;</span>,</span><br><span class="line">  ENMSERVICEPORT: process.env.enmserviceport || <span class="number">8083</span>,</span><br><span class="line">  ENMSERVICEHOST: process.env.enmservicehost || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  ENMNODEPROTOCO: process.env.enmnodeprotocol || <span class="string">&#x27;http:&#x27;</span>,</span><br><span class="line">  ENMNODEPORT: process.env.enmnodeport || <span class="number">8091</span>,</span><br><span class="line">  ENMNODEHOST: process.env.enmnodehost || <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  CORENODEPROTOCO: process.env.corenodeprotocol || <span class="string">&#x27;http:&#x27;</span>,</span><br><span class="line">  CORENODEPORT: process.env.corenodeport || <span class="number">8585</span>,</span><br><span class="line">  CORENODEHOST: process.env.corenodehost || <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I guess there should be a <code>ENV</code> parameter configured in xxx simulator deployment.yaml. To temporarily fix this problem, I edit the deployment config of xxx-simulator, refer <a href="https://stackoverflow.com/questions/49928819/how-to-pull-environment-variables-with-helm-charts">answer</a> and <a href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/">k8s official doc</a>:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">xxx-simulator</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enmnodehost</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;[fd04::fe]&#x27;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">xxx-simulator:1.0.0</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>这方法不对，原因：<code>connect ECONNREFUSED 127.0.0.1:8091</code>是enmservice和simulator在通信，这个相当于连了localhost:8091 (查看enmservice的log也确实如此)，理论上应连[fd04::fe]:8091。问题出在enmservice request export of simulator的地址，所以改simulator的container启动配置没用。<br>检查simulator的export代码，发现当时写的时候没考虑到ipv6，因为我们的create完job以后从simulator export的jobUrl是这么传的。。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fqdn = req.headers &amp;&amp; req.headers[<span class="string">&quot;host&quot;</span>] ? req.headers[<span class="string">&quot;host&quot;</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>] : <span class="literal">null</span>;</span><br><span class="line">JOBSDATA = <span class="keyword">new</span> JOBS(moJobId, fqdn);</span><br></pre></td></tr></table></figure>
<p>所以error message里会出现<code>http://[fd04:8091/bulk-con...</code>这种url</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;Error: connect ECONNREFUSED ::1:8091&quot;</span>,</span><br><span class="line"><span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;ca&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;jar&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://[fd04:8091/bulk-configuration/v1/import-jobs/jobs/18974277/files&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改了一下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fqdn = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.headers &amp;&amp; req.headers[<span class="string">&quot;host&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">const</span> headerHost = req.headers[<span class="string">&quot;host&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/\[/</span>.test(headerHost)) &#123;</span><br><span class="line">            <span class="keyword">let</span> start = headerHost.indexOf(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> end = headerHost.indexOf(<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">            fqdn = headerHost.slice(start, end + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fqdn = headerHost.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fqdn = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>work</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>k8s</tag>
      </tags>
  </entry>
</search>
